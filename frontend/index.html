<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Downloader - éŸ³ä¹ä¸‹è½½å™¨</title>
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="/js/config/env.js?v=20250620-2"></script>
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- å·¥å…·å’ŒæœåŠ¡ -->
    <script src="/js/utils/constants.js?v=20250620-2"></script>
    <script src="/js/utils/helpers.js?v=20250620-2"></script>
    <script src="/js/services/api.js?v=20250620-2"></script>
    <!-- ä¸»åº”ç”¨åˆå§‹åŒ– -->
    <script src="/js/main.js?v=20250620-2"></script>
    <!-- ç¡®ä¿APIå®ä¾‹å¯ç”¨ -->
    <script>
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆåæ£€æŸ¥APIå®ä¾‹
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” æ£€æŸ¥APIå®ä¾‹çŠ¶æ€...');
            
            if (typeof window.api === 'undefined') {
                console.error('âŒ APIå®ä¾‹æœªæ­£ç¡®åˆ›å»ºï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»º...');
                if (typeof window.ApiService !== 'undefined') {
                    window.api = new window.ApiService();
                    console.log('âœ… APIå®ä¾‹å·²æ‰‹åŠ¨åˆ›å»º');
                } else {
                    console.error('âŒ ApiServiceç±»æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥api.jsæ–‡ä»¶åŠ è½½');
                    alert('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼šAPIæœåŠ¡æœªåŠ è½½ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                }
            } else {
                console.log('âœ… APIå®ä¾‹å·²æ­£ç¡®åŠ è½½');
            }
        });
    </script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="/css/main.css?v=20250620-2">
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        /* å¹³æ»‘çš„æ•°æ®æ›´æ–° */
        .download-task-item {
            transition: all 0.3s ease;
        }
        
        /* é˜²æ­¢é—ªçƒçš„é€šç”¨æ ·å¼ */
        .no-flash {
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* éŸ³ä¹æ’­æ”¾è¿›åº¦æ¡ */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- å¯¼èˆªæ  -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-music text-blue-600 mr-2"></i>
                            Music Downloader
                        </h1>
                    </div>
                    
                    <!-- å¯¼èˆªèœå• -->
                    <div class="flex items-center space-x-6">
                        <button @click="activeTab = 'search'" 
                                :class="activeTab === 'search' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition">
                            <i class="fas fa-search mr-1"></i>æœç´¢
                        </button>
                        <button @click="activeTab = 'library'" 
                                :class="activeTab === 'library' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-bookmark mr-1"></i>æ”¶è—åº“
                            <span v-if="libraryStats?.total_songs > 0" 
                                  class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ libraryStats.total_songs }}
                            </span>
                        </button>
                        <button @click="activeTab = 'playlists'" 
                                :class="activeTab === 'playlists' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition">
                            <i class="fas fa-list-music mr-1"></i>æ­Œå•
                        </button>
                        <button @click="activeTab = 'downloads'" 
                                :class="activeTab === 'downloads' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-download mr-1"></i>ä¸‹è½½
                            <span v-if="pendingDownloads > 0" 
                                  class="absolute -top-1 -right-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ pendingDownloads }}
                            </span>
                        </button>
                        <button @click="showBatchProgress = !showBatchProgress" 
                                :class="showBatchProgress ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-tasks mr-1"></i>ä»»åŠ¡
                            <span v-if="activeBatchTasksCount > 0" 
                                  class="absolute -top-1 -right-2 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ activeBatchTasksCount }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
                    <div class="flex items-center space-x-4">
                        <!-- å·²ç™»å½•çŠ¶æ€ -->
                        <div v-if="isAuthenticated" class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <i class="fas fa-user-circle text-blue-600"></i>
                                <span>{{ currentUser?.username }}</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">{{ currentUser?.role }}</span>
                            </div>
                            <button @click="logout" 
                                    class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition">
                                <i class="fas fa-sign-out-alt mr-1"></i>ç™»å‡º
                            </button>
                        </div>
                        
                        <!-- æœªç™»å½•çŠ¶æ€ -->
                        <div v-else class="flex items-center space-x-3">
                            <span class="text-sm text-gray-500">æ¸¸å®¢æ¨¡å¼ï¼ˆåªè¯»ï¼‰</span>
                            <a href="/login.html" 
                               class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                <i class="fas fa-sign-in-alt mr-1"></i>ç®¡ç†å‘˜ç™»å½•
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- æœç´¢ç»„ä»¶ -->
            <search-component v-if="activeTab === 'search'" 
                            @song-added-to-library="onSongAddedToLibrary"
                            @playlist-imported="onPlaylistImported">
            </search-component>

            <!-- æ”¶è—åº“ç»„ä»¶ -->
            <library-component v-if="activeTab === 'library'"
                             @playlist-created="onPlaylistCreated"
                             @download-started="onDownloadStarted">
            </library-component>

            <!-- æ­Œå•ç»„ä»¶ -->
            <playlists-component v-if="activeTab === 'playlists'"
                               :playlists="playlists"
                               @playlist-updated="loadPlaylists"
                               @download-started="onDownloadStarted">
            </playlists-component>

            <!-- ä¸‹è½½ç»„ä»¶ -->
            <download-component v-if="activeTab === 'downloads'"
                              :download-tasks="downloadTasks"
                              @task-updated="loadDownloadTasks">
            </download-component>
        </main>

        <!-- éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶ -->
        <music-player v-if="currentTrack" 
                     :current-track="currentTrack"
                     @track-ended="onTrackEnded">
        </music-player>

        <!-- é€šçŸ¥ç»„ä»¶ -->
        <notification-component :notifications="notifications"
                              @dismiss="dismissNotification">
        </notification-component>
    </div>

    <!-- Vue åº”ç”¨è„šæœ¬ -->
    <script>
    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                // ç”¨æˆ·è®¤è¯çŠ¶æ€
                isAuthenticated: false,
                currentUser: null,
                
                // å½“å‰æ´»åŠ¨æ ‡ç­¾
                activeTab: 'search',
                
                // åŠ è½½çŠ¶æ€
                isLoading: false,
                
                // é€šçŸ¥æ¶ˆæ¯
                notifications: [],
                notificationIdCounter: 0,
                
                // æ­Œå•åˆ—è¡¨
                playlists: [],
                
                // ä¸‹è½½ä»»åŠ¡
                downloadTasks: [],
                
                // å¾…å¤„ç†ä¸‹è½½æ•°
                pendingDownloads: 0,
                
                // å½“å‰æ’­æ”¾æ­Œæ›²
                currentTrack: null,
                
                // æ’­æ”¾åˆ—è¡¨é˜Ÿåˆ—ç®¡ç†
                currentPlaylist: null,
                currentPlaylistIndex: -1,
                
                // æ”¶è—åº“ç»Ÿè®¡
                libraryStats: null,
                
                // æ‰¹é‡ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
                batchTasks: [],
                showBatchProgress: false
            }
        },
        
        computed: {
            activeBatchTasksCount() {
                return this.batchTasks.filter(task => task.status === 'running').length;
            }
        },
        
        mounted() {
            // ç¡®ä¿APIå®ä¾‹å¯ç”¨
            if (typeof window.api === 'undefined') {
                this.showError('APIæœåŠ¡æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                console.error('âŒ APIå®ä¾‹åœ¨Vue mountedä¸­æœªæ‰¾åˆ°');
                return;
            }
            
            console.log('âœ… Vueåº”ç”¨å·²æŒ‚è½½ï¼ŒAPIå®ä¾‹å¯ç”¨');
            
            // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
            this.checkAuthStatus();
            
            // åˆå§‹åŒ–æ•°æ®
            this.loadPlaylists();
            this.loadDownloadTasks();
            this.loadLibraryStats();
            
            // ç›‘å¬åŠ è½½çŠ¶æ€
            window.addEventListener('api-loading', (e) => {
                this.isLoading = e.detail;
            });
            
            // å®šæœŸåˆ·æ–°ä¸‹è½½ä»»åŠ¡ï¼ˆæ™ºèƒ½æ›´æ–°ï¼Œä¸é—ªçƒï¼‰
            setInterval(() => {
                if (this.activeTab === 'downloads' || this.pendingDownloads > 0) {
                    this.updateDownloadTasksSilent();
                }
            }, 3000);
        },
        
        methods: {
            // åŠ è½½æ­Œå•åˆ—è¡¨
            async loadPlaylists() {
                try {
                    const response = await window.api.getPlaylists();
                    this.playlists = response.data?.playlists || [];
                } catch (error) {
                    this.showError('åŠ è½½æ­Œå•å¤±è´¥: ' + error.message);
                }
            },
            
            // åŠ è½½ä¸‹è½½ä»»åŠ¡
            async loadDownloadTasks() {
                try {
                    const response = await window.api.getDownloadTasks();
                    this.downloadTasks = response.tasks || [];
                    
                    // è®¡ç®—å¾…å¤„ç†ä»»åŠ¡æ•°
                    this.pendingDownloads = this.downloadTasks.filter(
                        task => ['pending', 'downloading'].includes(task.status)
                    ).length;
                } catch (error) {
                    this.showError('åŠ è½½ä¸‹è½½ä»»åŠ¡å¤±è´¥: ' + error.message);
                }
            },
            
            // é™é»˜æ›´æ–°ä¸‹è½½ä»»åŠ¡ï¼ˆä¸é—ªçƒï¼‰
            async updateDownloadTasksSilent() {
                try {
                    const response = await window.api.getDownloadTasks();
                    const newTasks = response.tasks || [];
                    
                    // æ™ºèƒ½æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„ä»»åŠ¡
                    newTasks.forEach(newTask => {
                        const existingIndex = this.downloadTasks.findIndex(t => t.id === newTask.id);
                        if (existingIndex !== -1) {
                            // ä½¿ç”¨Vue.setç¡®ä¿å“åº”å¼æ›´æ–°
                            Vue.set(this.downloadTasks, existingIndex, newTask);
                        } else {
                            // æ–°ä»»åŠ¡æ·»åŠ åˆ°å¼€å¤´
                            this.downloadTasks.unshift(newTask);
                        }
                    });
                    
                    // ç§»é™¤å·²ç»ä¸å­˜åœ¨çš„ä»»åŠ¡
                    const newTaskIds = new Set(newTasks.map(t => t.id));
                    this.downloadTasks = this.downloadTasks.filter(t => newTaskIds.has(t.id));
                    
                    // æ›´æ–°å¾…å¤„ç†ä»»åŠ¡æ•°
                    this.pendingDownloads = this.downloadTasks.filter(
                        task => ['pending', 'downloading'].includes(task.status)
                    ).length;
                } catch (error) {
                    console.error('æ›´æ–°ä¸‹è½½ä»»åŠ¡å¤±è´¥:', error);
                }
            },
            
            // åŠ è½½æ”¶è—åº“ç»Ÿè®¡
            async loadLibraryStats() {
                try {
                    const response = await window.api.getLibraryStats();
                    this.libraryStats = response.data || response;
                } catch (error) {
                    this.showError('åŠ è½½æ”¶è—åº“ç»Ÿè®¡å¤±è´¥: ' + error.message);
                }
            },
            
            // æ­Œæ›²æ·»åŠ åˆ°æ”¶è—åº“
            onSongAddedToLibrary() {
                this.showSuccess('å·²æ·»åŠ åˆ°æ”¶è—åº“');
                this.loadLibraryStats();
            },
            
            // æ­Œå•åˆ›å»ºæˆåŠŸ
            onPlaylistCreated(playlist) {
                this.showSuccess(`æ­Œå• "${playlist.name}" åˆ›å»ºæˆåŠŸ`);
                this.loadPlaylists();
                this.activeTab = 'playlists';
            },
            
            // æ’­æ”¾åˆ—è¡¨å¯¼å…¥å¤„ç†
            onPlaylistImported(playlist) {
                this.showSuccess(`æ’­æ”¾åˆ—è¡¨ "${playlist.name}" å¯¼å…¥æˆåŠŸ`);
                this.loadPlaylists();
            },
            
            // ä¸‹è½½å¼€å§‹
            onDownloadStarted(info) {
                this.showSuccess(info.message || 'ä¸‹è½½ä»»åŠ¡å·²åˆ›å»º');
                this.loadDownloadTasks();
                this.activeTab = 'downloads';
            },
            
            // æ›²ç›®æ’­æ”¾ç»“æŸ
            onTrackEnded() {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ’­æ”¾åˆ—è¡¨æ­£åœ¨æ’­æ”¾
                if (this.currentPlaylist && this.currentPlaylist.length > 0 && this.currentPlaylistIndex >= 0) {
                    // æ’­æ”¾ä¸‹ä¸€é¦–æ­Œ
                    this.currentPlaylistIndex++;
                    
                    if (this.currentPlaylistIndex < this.currentPlaylist.length) {
                        // è¿˜æœ‰ä¸‹ä¸€é¦–æ­Œï¼Œç»§ç»­æ’­æ”¾
                        const nextSong = this.currentPlaylist[this.currentPlaylistIndex];
                        const mode = nextSong.playMode || 'preview';
                        
                        // ä½¿ç”¨ç›¸åŒçš„æ’­æ”¾é€»è¾‘
                        let audioUrl = null;
                        let trackTitle = nextSong.title;
                        
                        if (mode === 'downloaded' && nextSong.is_downloaded && nextSong.file_url) {
                            audioUrl = nextSong.file_url;
                            trackTitle += ' (ä¸‹è½½ç‰ˆæœ¬)';
                        } else if (nextSong.preview_url) {
                            audioUrl = nextSong.preview_url;
                            trackTitle += ' (è¯•å¬ç‰ˆæœ¬)';
                        }
                        
                        if (audioUrl) {
                            this.currentTrack = {
                                id: nextSong.spotify_id,
                                title: trackTitle,
                                artist: nextSong.artist,
                                album: nextSong.album,
                                album_art: nextSong.album_art_url,
                                audio_url: audioUrl,
                                preview_url: nextSong.preview_url,
                                duration: nextSong.duration,
                                mode: mode
                            };
                        } else {
                            // å½“å‰æ­Œæ›²æ— æ³•æ’­æ”¾ï¼Œè·³åˆ°ä¸‹ä¸€é¦–
                            this.onTrackEnded();
                        }
                    } else {
                        // æ’­æ”¾åˆ—è¡¨ç»“æŸ
                        this.currentTrack = null;
                        this.currentPlaylist = null;
                        this.currentPlaylistIndex = -1;
                        this.showSuccess('æ’­æ”¾åˆ—è¡¨æ’­æ”¾å®Œæˆ');
                    }
                } else {
                    // å•æ›²æ’­æ”¾ç»“æŸ
                    this.currentTrack = null;
                }
            },
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccess(message) {
                this.notificationIdCounter++;
                
                // é™åˆ¶æœ€å¤§é€šçŸ¥æ•°é‡ï¼Œé˜²æ­¢å †ç§¯
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ç§»é™¤æœ€æ—§çš„é€šçŸ¥
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'success',
                    message: message,
                    createdAt: Date.now()
                });
            },
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showError(message) {
                this.notificationIdCounter++;
                
                // é™åˆ¶æœ€å¤§é€šçŸ¥æ•°é‡ï¼Œé˜²æ­¢å †ç§¯
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ç§»é™¤æœ€æ—§çš„é€šçŸ¥
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'error',
                    message: message,
                    createdAt: Date.now()
                });
            },
            
            // æ˜¾ç¤ºAPIä¿¡æ¯
            showApiInfo(apiUrl, playlist) {
                const message = `APIæ¥å£é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼

ğŸ“‹ **æ¥å£åœ°å€**: ${apiUrl}

ğŸ“– **è¯¦ç»†æ–‡æ¡£**: è®¿é—® /docs æŸ¥çœ‹å®Œæ•´APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

ğŸ’¡ **å¿«é€Ÿä½¿ç”¨**: 
- æ”¯æŒGETè¯·æ±‚ç›´æ¥è·å–JSONæ•°æ®
- æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼Œå¯ç›´æ¥åœ¨Laravelé¡¹ç›®ä¸­ä½¿ç”¨
- è¿”å›å®Œæ•´çš„æ­Œæ›²å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬å°é¢ã€è¯•å¬é“¾æ¥ã€ä¸‹è½½çŠ¶æ€ç­‰`;

                // åˆ›å»ºç®€æ´çš„é€šçŸ¥
                this.notificationIdCounter++;
                
                // é™åˆ¶æœ€å¤§é€šçŸ¥æ•°é‡ï¼Œé˜²æ­¢å †ç§¯
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ç§»é™¤æœ€æ—§çš„é€šçŸ¥
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'success',
                    message: message,
                    duration: 8000, // 8ç§’åè‡ªåŠ¨å…³é—­
                    createdAt: Date.now()
                });
            },
            
            // å…³é—­é€šçŸ¥
            dismissNotification(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index > -1) {
                    this.notifications.splice(index, 1);
                }
            },
            
            // ============= è®¤è¯ç›¸å…³æ–¹æ³• =============
            
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            async checkAuthStatus() {
                const token = localStorage.getItem('auth_token');
                const userInfo = localStorage.getItem('user_info');
                
                if (!token) {
                    this.isAuthenticated = false;
                    this.currentUser = null;
                    return;
                }
                
                try {
                    // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
                    const response = await axios.get('/api/auth/me', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    this.isAuthenticated = true;
                    this.currentUser = response.data;
                    
                    // è®¾ç½®axiosé»˜è®¤header
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    
                } catch (error) {
                    // tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                    this.logout();
                }
            },
            
            // ç™»å‡º
            logout() {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                delete axios.defaults.headers.common['Authorization'];
                this.isAuthenticated = false;
                this.currentUser = null;
                
                // è·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = '/login.html';
            },
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯çš„æ“ä½œ
            requireAuth(action) {
                if (!this.isAuthenticated) {
                    this.showError('è¯·å…ˆç™»å½•åå†è¿›è¡Œæ­¤æ“ä½œ');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }
                return true;
            }
        }
    });

    // æ³¨å†Œå…¨å±€ç»„ä»¶
    
    // æœç´¢ç»„ä»¶
    app.component('search-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-search text-blue-600 mr-2"></i>éŸ³ä¹æœç´¢
                </h2>
                
                <!-- æœç´¢æ¡† -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <input v-model="searchQuery" 
                               @keyup.enter="search"
                               type="text" 
                               placeholder="æœç´¢æ­Œæ›²ã€è‰ºäººã€ä¸“è¾‘ã€æ­Œå•..."
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button @click="search" 
                                :disabled="!searchQuery"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition">
                            <i class="fas fa-search mr-2"></i>æœç´¢
                        </button>
                    </div>
                    
                    <!-- æœç´¢ç±»å‹æ ‡ç­¾ -->
                    <div class="mt-4 flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">æœç´¢ç±»å‹:</span>
                        <button v-for="type in searchTypes" :key="type.key"
                                @click="switchSearchType(type.key)"
                                :class="searchOptions.searchType === type.key ? 
                                    'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 text-sm rounded-full transition">
                            <i :class="type.icon" class="mr-1"></i>{{ type.name }}
                            <span v-if="hasSearched" class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-white bg-opacity-20">
                                {{ getResultCount(type.key) }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- æœç´¢é€‰é¡¹ -->
                    <div class="mt-4 space-y-3">
                        <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€é€‰é¡¹ -->
                        <div class="flex items-center space-x-4 text-sm">
                            <label v-if="searchOptions.searchType === 'track'" class="flex items-center">
                                <input v-model="searchOptions.previewOnly" type="checkbox" class="mr-2">
                                ä»…æ˜¾ç¤ºå¯è¯•å¬
                            </label>
                            <select v-model="searchOptions.regionGroup" @change="onRegionGroupChange" class="px-3 py-1 border rounded">
                                <option value="">æ‰€æœ‰åœ°åŒº</option>
                                <option value="asia">äºšæ´²</option>
                                <option value="eastasia">ä¸œäºš</option>
                                <option value="japankorea">æ—¥éŸ©</option>
                                <option value="southeast">ä¸œå—äºš</option>
                                <option value="southasia">å—äºš</option>
                                <option value="europe">æ¬§æ´²</option>
                                <option value="westerneurope">è¥¿æ¬§</option>
                                <option value="easterneurope">ä¸œæ¬§</option>
                                <option value="northamerica">åŒ—ç¾</option>
                                <option value="southamerica">å—ç¾</option>
                                <option value="oceania">å¤§æ´‹æ´²</option>
                                <option value="middleeast">ä¸­ä¸œ</option>
                                <option value="africa">éæ´²</option>
                            </select>
                            <select v-model="searchOptions.countryFilter" class="px-3 py-1 border rounded">
                                <option value="">æ‰€æœ‰å›½å®¶</option>
                                <option value="china">ä¸­å›½</option>
                                <option value="korea">éŸ©å›½</option>
                                <option value="japan">æ—¥æœ¬</option>
                                <option value="usa">ç¾å›½</option>
                                <option value="uk">è‹±å›½</option>
                                <option value="turkey">åœŸè€³å…¶</option>
                                <option value="taiwan">å°æ¹¾</option>
                                <option value="thailand">æ³°å›½</option>
                                <option value="vietnam">è¶Šå—</option>
                                <option value="singapore">æ–°åŠ å¡</option>
                                <option value="malaysia">é©¬æ¥è¥¿äºš</option>
                                <option value="indonesia">å°åº¦å°¼è¥¿äºš</option>
                                <option value="philippines">è²å¾‹å®¾</option>
                                <option value="india">å°åº¦</option>
                                <option value="canada">åŠ æ‹¿å¤§</option>
                                <option value="australia">æ¾³å¤§åˆ©äºš</option>
                                <option value="france">æ³•å›½</option>
                                <option value="germany">å¾·å›½</option>
                                <option value="spain">è¥¿ç­ç‰™</option>
                                <option value="italy">æ„å¤§åˆ©</option>
                                <option value="russia">ä¿„ç½—æ–¯</option>
                                <option value="brazil">å·´è¥¿</option>
                                <option value="mexico">å¢¨è¥¿å“¥</option>
                                <option value="argentina">é˜¿æ ¹å»·</option>
                            </select>
                            <select v-model="searchOptions.limit" class="px-3 py-1 border rounded">
                                <option value="10">10æ¡ç»“æœ</option>
                                <option value="20">20æ¡ç»“æœ</option>
                                <option value="50">50æ¡ç»“æœ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æœ -->
                <div v-if="searchResults.length > 0" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold">
                            {{ getSearchTypeText() }}æœç´¢ç»“æœ ({{ searchResults.length }})
                        </h3>
                        
                        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       :checked="selectedItems.length === searchResults.length && searchResults.length > 0"
                                       @change="toggleSelectAll"
                                       class="mr-2">
                                å…¨é€‰
                            </label>
                            <button v-if="selectedItems.length > 0" 
                                    @click="invertSelection" 
                                    class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition"
                                    title="åé€‰å½“å‰é€‰æ‹©">
                                <i class="fas fa-exchange-alt mr-1"></i>åé€‰
                            </button>
                            <span v-if="selectedItems.length > 0" class="text-sm text-gray-600">
                                å·²é€‰æ‹© {{ selectedItems.length }} é¡¹
                            </span>
                            
                            <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                            <div v-if="selectedItems.length > 0" class="flex space-x-2">
                                <!-- ç»Ÿä¸€çš„æ‰¹é‡æ”¶è—æŒ‰é’® -->
                                <button @click="showLibraryImportModal" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                                        title="æ‰¹é‡å¯¼å…¥åˆ°æ”¶è—åº“">
                                    <i class="fas fa-bookmark mr-1"></i>æ‰¹é‡æ”¶è—
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ­Œæ›²ç»“æœ -->
                    <div v-if="searchOptions.searchType === 'track'" v-for="track in searchResults" :key="track.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="track.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- ä¸“è¾‘å°é¢ -->
                                <img v-if="track.album_art_url" 
                                     :src="track.album_art_url" 
                                     :alt="track.album"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400 text-2xl"></i>
                                </div>
                                
                                <!-- æ­Œæ›²ä¿¡æ¯ -->
                                <div>
                                    <h4 class="font-semibold">{{ track.title }}</h4>
                                    <p class="text-sm text-gray-600">{{ track.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ track.album }} 
                                        <span v-if="track.year">({{ track.year }})</span>
                                        <span v-if="track.country" class="ml-2">
                                            <i class="fas fa-globe text-gray-400"></i> {{ track.country }}
                                        </span>
                                        <span v-if="track.preview_url" class="ml-2 text-green-600">
                                            <i class="fas fa-play-circle"></i> å¯è¯•å¬
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <!-- è¯•å¬æŒ‰é’® -->
                                <button v-if="track.preview_url" 
                                        @click="playPreview(track)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-play mr-1"></i>è¯•å¬
                                </button>
                                
                                <!-- æ·»åŠ åˆ°æ”¶è—åº“ -->
                                <button @click="addToLibrary(track)"
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-bookmark mr-1"></i>æ”¶è—
                                </button>
                                
                                <!-- ç›´æ¥ä¸‹è½½ -->
                                <button @click="downloadTrack(track)"
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download mr-1"></i>ä¸‹è½½
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ­Œå•ç»“æœ -->
                    <div v-if="searchOptions.searchType === 'playlist'" v-for="playlist in searchResults" :key="playlist.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="playlist.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- æ­Œå•å°é¢ -->
                                <img v-if="playlist.image_url" 
                                     :src="playlist.image_url" 
                                     :alt="playlist.name"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-list-music text-white text-2xl"></i>
                                </div>
                                
                                <!-- æ­Œå•ä¿¡æ¯ -->
                                <div>
                                    <h4 class="font-semibold">{{ playlist.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ playlist.owner }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ playlist.total_tracks }} é¦–æ­Œæ›²
                                        <span v-if="playlist.description" class="ml-2">{{ playlist.description }}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <button @click="importPlaylist(playlist)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-plus mr-1"></i>å¯¼å…¥æ­Œå•
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸“è¾‘ç»“æœ -->
                    <div v-if="searchOptions.searchType === 'album'" v-for="album in searchResults" :key="album.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="album.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- ä¸“è¾‘å°é¢ -->
                                <img v-if="album.image_url" 
                                     :src="album.image_url" 
                                     :alt="album.name"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-blue-400 to-indigo-400 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-compact-disc text-white text-2xl"></i>
                                </div>
                                
                                <!-- ä¸“è¾‘ä¿¡æ¯ -->
                                <div>
                                    <h4 class="font-semibold">{{ album.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ album.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ album.total_tracks }} é¦–æ­Œæ›²
                                        <span v-if="album.release_date" class="ml-2">({{ album.release_date.slice(0,4) }})</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <button @click="importAlbum(album)"
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-plus mr-1"></i>å¯¼å…¥ä¸“è¾‘
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è‰ºäººç»“æœ -->
                    <div v-if="searchOptions.searchType === 'artist'" v-for="artist in searchResults" :key="artist.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="artist.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- è‰ºäººå¤´åƒ -->
                                <img v-if="artist.image_url" 
                                     :src="artist.image_url" 
                                     :alt="artist.name"
                                     class="w-16 h-16 rounded-full object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-green-400 to-teal-400 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-music text-white text-2xl"></i>
                                </div>
                                
                                <!-- è‰ºäººä¿¡æ¯ -->
                                <div>
                                    <h4 class="font-semibold">{{ artist.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ formatFollowers(artist.followers) }} å…³æ³¨è€…</p>
                                    <p class="text-xs text-gray-500">
                                        æµè¡Œåº¦: {{ artist.popularity }}/100
                                        <span v-if="artist.genres && artist.genres.length" class="ml-2">
                                            {{ artist.genres.slice(0,2).join(', ') }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <button @click="searchArtistTracks(artist)"
                                        class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                    <i class="fas fa-music mr-1"></i>æŸ¥çœ‹çƒ­é—¨æ­Œæ›²
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ— ç»“æœæç¤º -->
                <div v-else-if="hasSearched" class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p>æœªæ‰¾åˆ°ç›¸å…³éŸ³ä¹</p>
                </div>
                
                <!-- æ”¶è—åº“å¯¼å…¥æ¨¡æ€æ¡† -->
                <div v-if="importToLibraryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">æ‰¹é‡æ·»åŠ åˆ°æ”¶è—åº“</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»</label>
                                <input v-model="libraryImportSettings.category" 
                                       type="text" 
                                       placeholder="å¦‚ï¼šK-POP, æµè¡ŒéŸ³ä¹ç­‰"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å›½å®¶</label>
                                <select v-model="libraryImportSettings.country" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">é€‰æ‹©å›½å®¶</option>
                                    <option value="china">ä¸­å›½</option>
                                    <option value="korea">éŸ©å›½</option>
                                    <option value="japan">æ—¥æœ¬</option>
                                    <option value="usa">ç¾å›½</option>
                                    <option value="uk">è‹±å›½</option>
                                    <option value="turkey">åœŸè€³å…¶</option>
                                    <option value="taiwan">å°æ¹¾</option>
                                    <option value="thailand">æ³°å›½</option>
                                    <option value="vietnam">è¶Šå—</option>
                                    <option value="singapore">æ–°åŠ å¡</option>
                                    <option value="malaysia">é©¬æ¥è¥¿äºš</option>
                                    <option value="indonesia">å°åº¦å°¼è¥¿äºš</option>
                                    <option value="philippines">è²å¾‹å®¾</option>
                                    <option value="india">å°åº¦</option>
                                    <option value="canada">åŠ æ‹¿å¤§</option>
                                    <option value="australia">æ¾³å¤§åˆ©äºš</option>
                                    <option value="france">æ³•å›½</option>
                                    <option value="germany">å¾·å›½</option>
                                    <option value="spain">è¥¿ç­ç‰™</option>
                                    <option value="italy">æ„å¤§åˆ©</option>
                                    <option value="russia">ä¿„ç½—æ–¯</option>
                                    <option value="brazil">å·´è¥¿</option>
                                    <option value="mexico">å¢¨è¥¿å“¥</option>
                                    <option value="argentina">é˜¿æ ¹å»·</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è¯­è¨€</label>
                                <select v-model="libraryImportSettings.language" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">é€‰æ‹©è¯­è¨€</option>
                                    <option value="chinese">ä¸­æ–‡</option>
                                    <option value="korean">éŸ©è¯­</option>
                                    <option value="japanese">æ—¥è¯­</option>
                                    <option value="english">è‹±è¯­</option>
                                    <option value="turkish">åœŸè€³å…¶è¯­</option>
                                    <option value="french">æ³•è¯­</option>
                                    <option value="german">å¾·è¯­</option>
                                    <option value="spanish">è¥¿ç­ç‰™è¯­</option>
                                    <option value="italian">æ„å¤§åˆ©è¯­</option>
                                    <option value="russian">ä¿„è¯­</option>
                                    <option value="portuguese">è‘¡è„ç‰™è¯­</option>
                                    <option value="arabic">é˜¿æ‹‰ä¼¯è¯­</option>
                                    <option value="hindi">å°åœ°è¯­</option>
                                    <option value="thai">æ³°è¯­</option>
                                    <option value="vietnamese">è¶Šå—è¯­</option>
                                    <option value="malay">é©¬æ¥è¯­</option>
                                    <option value="indonesian">å°å°¼è¯­</option>
                                    <option value="filipino">è²å¾‹å®¾è¯­</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡ç­¾</label>
                                <input v-model="libraryImportSettings.tags" 
                                       type="text" 
                                       placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šèˆæ›²,èŠ‚å¥æ„Ÿå¼º"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                                <textarea v-model="libraryImportSettings.notes" 
                                          placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <!-- ä¿å­˜ä¸ºé»˜è®¤è®¾ç½®é€‰é¡¹ -->
                            <div class="border-t pt-4">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           v-model="libraryImportSettings.saveAsDefault"
                                           class="mr-2">
                                    <span class="text-sm text-gray-700">ä¿å­˜ä¸ºé»˜è®¤è®¾ç½®ï¼ˆä¸‹æ¬¡å¿«é€Ÿæ”¶è—æ—¶ä½¿ç”¨ï¼‰</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <!-- å½“å‰é»˜è®¤è®¾ç½®æç¤º -->
                            <div class="text-xs text-gray-500">
                                <p>é»˜è®¤è®¾ç½®ï¼š</p>
                                <p>{{ defaultImportSettings.category || 'æ— åˆ†ç±»' }} | {{ countryMap[defaultImportSettings.country] || defaultImportSettings.country || 'æ— å›½å®¶' }} | {{ languageMap[defaultImportSettings.language] || defaultImportSettings.language || 'æ— è¯­è¨€' }}</p>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button @click="importToLibraryModal = false" 
                                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                    å–æ¶ˆ
                                </button>
                                <button @click="quickBatchImport" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                                        title="ä½¿ç”¨é»˜è®¤è®¾ç½®å¿«é€Ÿå¯¼å…¥">
                                    <i class="fas fa-flash mr-1"></i>å¿«é€Ÿæ”¶è—
                                </button>
                                <button @click="confirmLibraryImport" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    ç¡®è®¤æ·»åŠ  ({{ selectedItems.length }} é¡¹)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­Œå•å¯¼å…¥è®¾ç½®æ¨¡æ€æ¡† -->
                <div v-if="playlistImportModal.show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">æ­Œå•å¯¼å…¥è®¾ç½®</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ­Œå•åç§°</label>
                                <p class="text-gray-600">{{ playlistImportModal.playlist?.name }}</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»</label>
                                <input v-model="playlistImportModal.settings.category" 
                                       type="text" 
                                       placeholder="å¦‚ï¼šéŸ©å›½æ­Œå•, åœŸè€³å…¶éŸ³ä¹ç­‰"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šä¹‰å›½å®¶/åœ°åŒº</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <select v-model="playlistImportModal.settings.customCountry" 
                                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">é€‰æ‹©å›½å®¶</option>
                                        <option value="china">ä¸­å›½</option>
                                        <option value="korea">éŸ©å›½</option>
                                        <option value="japan">æ—¥æœ¬</option>
                                        <option value="usa">ç¾å›½</option>
                                        <option value="uk">è‹±å›½</option>
                                        <option value="turkey">åœŸè€³å…¶</option>
                                        <option value="taiwan">å°æ¹¾</option>
                                        <option value="thailand">æ³°å›½</option>
                                        <option value="vietnam">è¶Šå—</option>
                                        <option value="singapore">æ–°åŠ å¡</option>
                                        <option value="malaysia">é©¬æ¥è¥¿äºš</option>
                                        <option value="indonesia">å°åº¦å°¼è¥¿äºš</option>
                                        <option value="philippines">è²å¾‹å®¾</option>
                                        <option value="india">å°åº¦</option>
                                        <option value="canada">åŠ æ‹¿å¤§</option>
                                        <option value="australia">æ¾³å¤§åˆ©äºš</option>
                                        <option value="france">æ³•å›½</option>
                                        <option value="germany">å¾·å›½</option>
                                        <option value="spain">è¥¿ç­ç‰™</option>
                                        <option value="italy">æ„å¤§åˆ©</option>
                                        <option value="russia">ä¿„ç½—æ–¯</option>
                                        <option value="brazil">å·´è¥¿</option>
                                        <option value="mexico">å¢¨è¥¿å“¥</option>
                                        <option value="argentina">é˜¿æ ¹å»·</option>
                                    </select>
                                    
                                    <input v-model="playlistImportModal.settings.customRegion" 
                                           type="text" 
                                           placeholder="è‡ªå®šä¹‰åœ°åŒº"
                                           class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">è‡ªå®šä¹‰åœ°åŒºä¿¡æ¯ï¼Œä¸æ­Œæ›²åŸæœ‰å›½å®¶ä¿¡æ¯åˆ†å¼€å­˜å‚¨</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šä¹‰è¯­è¨€</label>
                                <select v-model="playlistImportModal.settings.customLanguage" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">é€‰æ‹©è¯­è¨€</option>
                                    <option value="chinese">ä¸­æ–‡</option>
                                    <option value="korean">éŸ©è¯­</option>
                                    <option value="japanese">æ—¥è¯­</option>
                                    <option value="english">è‹±è¯­</option>
                                    <option value="turkish">åœŸè€³å…¶è¯­</option>
                                    <option value="french">æ³•è¯­</option>
                                    <option value="german">å¾·è¯­</option>
                                    <option value="spanish">è¥¿ç­ç‰™è¯­</option>
                                    <option value="italian">æ„å¤§åˆ©è¯­</option>
                                    <option value="russian">ä¿„è¯­</option>
                                    <option value="portuguese">è‘¡è„ç‰™è¯­</option>
                                    <option value="arabic">é˜¿æ‹‰ä¼¯è¯­</option>
                                    <option value="hindi">å°åœ°è¯­</option>
                                    <option value="thai">æ³°è¯­</option>
                                    <option value="vietnamese">è¶Šå—è¯­</option>
                                    <option value="malay">é©¬æ¥è¯­</option>
                                    <option value="indonesian">å°å°¼è¯­</option>
                                    <option value="filipino">è²å¾‹å®¾è¯­</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">è‡ªå®šä¹‰è¯­è¨€ä¿¡æ¯ï¼Œä¸æ­Œæ›²è‡ªåŠ¨æ£€æµ‹çš„è¯­è¨€åˆ†å¼€å­˜å‚¨</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡ç­¾</label>
                                <input v-model="playlistImportModal.settings.tags" 
                                       type="text" 
                                       placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šæµè¡Œ,èˆæ›²,2024"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                                <textarea v-model="playlistImportModal.settings.notes" 
                                          placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-6">
                            <button @click="playlistImportModal.show = false" 
                                    class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                å–æ¶ˆ
                            </button>
                            <button @click="confirmPlaylistImport" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                ç¡®è®¤å¯¼å…¥åˆ°æ”¶è—åº“
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ‰¹é‡ä»»åŠ¡è¿›åº¦çª—å£ -->
                <div v-if="$root.showBatchProgress" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border p-4 w-80 z-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-800">æ‰¹é‡ä»»åŠ¡è¿›åº¦</h4>
                        <button @click="closeBatchProgress" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3 max-h-60 overflow-y-auto">
                        <div v-for="task in $root.batchTasks" :key="task.id" class="border rounded p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">
                                    {{ task.type === 'library_import' ? 'æ‰¹é‡æ”¶è—' : 'æ‰¹é‡ä»»åŠ¡' }}
                                </span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs px-2 py-1 rounded" 
                                          :class="{
                                            'bg-blue-100 text-blue-800': task.status === 'running',
                                            'bg-green-100 text-green-800': task.status === 'completed',
                                            'bg-red-100 text-red-800': task.status === 'failed',
                                            'bg-gray-100 text-gray-800': task.status === 'cancelled'
                                          }">
                                        {{ getTaskStatusText(task.status) }}
                                    </span>
                                    <button v-if="task.status === 'running'" 
                                            @click="cancelBatchTask(task.id)"
                                            class="text-xs text-red-600 hover:text-red-800">
                                        å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                            
                            <!-- è¿›åº¦æ¡ -->
                            <div class="mb-2">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>{{ task.completed }} / {{ task.total }}</span>
                                    <span>{{ getTaskProgress(task) }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                         :style="{ width: getTaskProgress(task) + '%' }"></div>
                                </div>
                            </div>
                            
                            <!-- ä»»åŠ¡è¯¦æƒ… -->
                            <div class="text-xs text-gray-500">
                                <p v-if="task.failed > 0" class="text-red-600">
                                    å¤±è´¥: {{ task.failed }} é¡¹
                                    <button v-if="task.failedItems && task.failedItems.length > 0" 
                                            @click="task.showFailureDetails = !task.showFailureDetails"
                                            class="ml-1 text-blue-600 hover:text-blue-800">
                                        {{ task.showFailureDetails ? 'éšè—' : 'æŸ¥çœ‹' }}è¯¦æƒ…
                                    </button>
                                </p>
                                <!-- å¤±è´¥è¯¦æƒ… -->
                                <div v-if="task.showFailureDetails && task.failedItems" 
                                     class="mt-2 p-2 bg-red-50 rounded text-xs max-h-20 overflow-y-auto">
                                    <div v-for="item in task.failedItems" :key="item.item_id" class="mb-1">
                                        <strong>{{ item.item_id }}:</strong> {{ item.error }}
                                    </div>
                                </div>
                                <p>å¼€å§‹æ—¶é—´: {{ task.startTime.toLocaleTimeString() }}</p>
                                <p v-if="task.endTime">ç»“æŸæ—¶é—´: {{ task.endTime.toLocaleTimeString() }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        data() {
            return {
                searchQuery: '',
                allSearchResults: {
                    tracks: [],
                    playlists: [],
                    albums: [],
                    artists: []
                },
                hasSearched: false,
                searchOptions: {
                    searchType: 'track',
                    previewOnly: false,
                    regionGroup: '',
                    countryFilter: '',
                    limit: 20
                },
                searchTypes: [
                    { key: 'track', name: 'æ­Œæ›²', icon: 'fas fa-music' },
                    { key: 'playlist', name: 'æ­Œå•', icon: 'fas fa-list-music' },
                    { key: 'album', name: 'ä¸“è¾‘', icon: 'fas fa-compact-disc' },
                    { key: 'artist', name: 'æ­Œæ‰‹', icon: 'fas fa-user-music' }
                ],
                selectedItems: [],
                showBatchActions: false,
                importToLibraryModal: false,
                libraryImportSettings: {
                    category: '',
                    country: '',
                    language: '',
                    tags: '',
                    notes: '',
                    // ä¿å­˜é»˜è®¤è®¾ç½®
                    saveAsDefault: false
                },
                // é»˜è®¤æ‰¹é‡å¯¼å…¥è®¾ç½®
                defaultImportSettings: {
                    category: 'Spotifyå¯¼å…¥',
                    country: 'korea',
                    language: 'korean',
                    tags: 'æ‰¹é‡å¯¼å…¥',
                    notes: ''
                },
                // æ­Œå•å¯¼å…¥è®¾ç½®æ¨¡æ€æ¡†
                playlistImportModal: {
                    show: false,
                    playlist: null,
                    settings: {
                        category: '',
                        customCountry: '',
                        customRegion: '',
                        customLanguage: '',
                        tags: '',
                        notes: ''
                    }
                },
                // åœ°åŒºåˆ†ç»„æ˜ å°„
                regionGroupMapping: {
                    'asia': ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬', 'å°æ¹¾', 'æ³°å›½', 'è¶Šå—', 'æ–°åŠ å¡', 'é©¬æ¥è¥¿äºš', 'å°åº¦å°¼è¥¿äºš', 'è²å¾‹å®¾', 'å°åº¦'],
                    'eastasia': ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬', 'å°æ¹¾'],
                    'japankorea': ['éŸ©å›½', 'æ—¥æœ¬'],
                    'southeast': ['æ³°å›½', 'è¶Šå—', 'æ–°åŠ å¡', 'é©¬æ¥è¥¿äºš', 'å°åº¦å°¼è¥¿äºš', 'è²å¾‹å®¾'],
                    'southasia': ['å°åº¦'],
                    'europe': ['è‹±å›½', 'æ³•å›½', 'å¾·å›½', 'è¥¿ç­ç‰™', 'æ„å¤§åˆ©', 'ä¿„ç½—æ–¯'],
                    'westerneurope': ['è‹±å›½', 'æ³•å›½', 'å¾·å›½', 'è¥¿ç­ç‰™', 'æ„å¤§åˆ©'],
                    'easterneurope': ['ä¿„ç½—æ–¯'],
                    'northamerica': ['ç¾å›½', 'åŠ æ‹¿å¤§'],
                    'southamerica': ['å·´è¥¿', 'å¢¨è¥¿å“¥', 'é˜¿æ ¹å»·'],
                    'oceania': ['æ¾³å¤§åˆ©äºš'],
                    'middleeast': ['åœŸè€³å…¶'],
                    'africa': []
                },
                // å›½å®¶è‹±æ–‡åˆ°ä¸­æ–‡æ˜ å°„
                countryMap: {
                    'china': 'ä¸­å›½',
                    'korea': 'éŸ©å›½',
                    'japan': 'æ—¥æœ¬',
                    'usa': 'ç¾å›½',
                    'uk': 'è‹±å›½',
                    'turkey': 'åœŸè€³å…¶',
                    'taiwan': 'å°æ¹¾',
                    'thailand': 'æ³°å›½',
                    'vietnam': 'è¶Šå—',
                    'singapore': 'æ–°åŠ å¡',
                    'malaysia': 'é©¬æ¥è¥¿äºš',
                    'indonesia': 'å°åº¦å°¼è¥¿äºš',
                    'philippines': 'è²å¾‹å®¾',
                    'india': 'å°åº¦',
                    'canada': 'åŠ æ‹¿å¤§',
                    'australia': 'æ¾³å¤§åˆ©äºš',
                    'france': 'æ³•å›½',
                    'germany': 'å¾·å›½',
                    'spain': 'è¥¿ç­ç‰™',
                    'italy': 'æ„å¤§åˆ©',
                    'russia': 'ä¿„ç½—æ–¯',
                    'brazil': 'å·´è¥¿',
                    'mexico': 'å¢¨è¥¿å“¥',
                    'argentina': 'é˜¿æ ¹å»·'
                },
                // è¯­è¨€è‹±æ–‡åˆ°ä¸­æ–‡æ˜ å°„
                languageMap: {
                    'chinese': 'ä¸­æ–‡',
                    'korean': 'éŸ©è¯­',
                    'japanese': 'æ—¥è¯­',
                    'english': 'è‹±è¯­',
                    'turkish': 'åœŸè€³å…¶è¯­',
                    'french': 'æ³•è¯­',
                    'german': 'å¾·è¯­',
                    'spanish': 'è¥¿ç­ç‰™è¯­',
                    'italian': 'æ„å¤§åˆ©è¯­',
                    'russian': 'ä¿„è¯­',
                    'portuguese': 'è‘¡è„ç‰™è¯­',
                    'arabic': 'é˜¿æ‹‰ä¼¯è¯­',
                    'hindi': 'å°åœ°è¯­',
                    'thai': 'æ³°è¯­',
                    'vietnamese': 'è¶Šå—è¯­',
                    'malay': 'é©¬æ¥è¯­',
                    'indonesian': 'å°å°¼è¯­',
                    'filipino': 'è²å¾‹å®¾è¯­'
                }
            }
        },
        computed: {
            searchResults() {
                // æ ¹æ®å½“å‰é€‰æ‹©çš„ç±»å‹è¿”å›å¯¹åº”çš„ç»“æœ
                const typeMap = {
                    'track': 'tracks',
                    'playlist': 'playlists', 
                    'album': 'albums',
                    'artist': 'artists'
                };
                return this.allSearchResults[typeMap[this.searchOptions.searchType]] || [];
            }
        },
        methods: {
            async search() {
                if (!this.searchQuery.trim()) return;
                
                // æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
                this.selectedItems = [];
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºSpotify URL
                if (this.isSpotifyUrl(this.searchQuery.trim())) {
                    await this.handleSpotifyUrl();
                } else {
                    // æ™®é€šæœç´¢
                    await this.searchCurrentType();
                }
            },
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºSpotify URL
            isSpotifyUrl(query) {
                return query.includes('spotify.com/') || query.includes('spotify:');
            },
            
            // å¤„ç†Spotify URL
            async handleSpotifyUrl() {
                try {
                    this.$root.showSuccess('æ£€æµ‹åˆ°Spotifyé“¾æ¥ï¼Œæ­£åœ¨è§£æ...');
                    
                    const parseResponse = await window.api.parseSpotifyUrl(this.searchQuery.trim());
                    
                    if (parseResponse.type === 'playlist') {
                        // åˆ‡æ¢åˆ°æ­Œå•æ¨¡å¼å¹¶æ˜¾ç¤ºè§£æç»“æœ
                        this.searchOptions.searchType = 'playlist';
                        this.allSearchResults.playlists = [{
                            id: parseResponse.tracks[0]?.id || 'parsed',
                            name: parseResponse.name,
                            description: parseResponse.description,
                            total_tracks: parseResponse.total_tracks,
                            spotify_url: this.searchQuery.trim(),
                            owner: 'Spotify',
                            is_public: true,
                            tracks: parseResponse.tracks  // ä¿å­˜è§£æçš„æ­Œæ›²åˆ—è¡¨
                        }];
                        this.hasSearched = true;
                        this.$root.showSuccess(`æˆåŠŸè§£ææ­Œå• "${parseResponse.name}"ï¼ŒåŒ…å« ${parseResponse.total_tracks} é¦–æ­Œæ›²`);
                        
                    } else if (parseResponse.type === 'album') {
                        // åˆ‡æ¢åˆ°ä¸“è¾‘æ¨¡å¼å¹¶æ˜¾ç¤ºè§£æç»“æœ
                        this.searchOptions.searchType = 'album';
                        this.allSearchResults.albums = [{
                            id: parseResponse.tracks[0]?.id || 'parsed',
                            name: parseResponse.name,
                            artist: parseResponse.artist,
                            total_tracks: parseResponse.total_tracks,
                            spotify_url: this.searchQuery.trim(),
                            tracks: parseResponse.tracks  // ä¿å­˜è§£æçš„æ­Œæ›²åˆ—è¡¨
                        }];
                        this.hasSearched = true;
                        this.$root.showSuccess(`æˆåŠŸè§£æä¸“è¾‘ "${parseResponse.name}"ï¼ŒåŒ…å« ${parseResponse.total_tracks} é¦–æ­Œæ›²`);
                        
                    } else if (parseResponse.type === 'track') {
                        // åˆ‡æ¢åˆ°æ­Œæ›²æ¨¡å¼å¹¶æ˜¾ç¤ºè§£æç»“æœ
                        this.searchOptions.searchType = 'track';
                        this.allSearchResults.tracks = [parseResponse.data];
                        this.hasSearched = true;
                        this.$root.showSuccess(`æˆåŠŸè§£ææ­Œæ›² "${parseResponse.data.title}"`);
                    }
                    
                } catch (error) {
                    this.$root.showError('è§£æSpotifyé“¾æ¥å¤±è´¥: ' + error.message);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå›åˆ°æ™®é€šæœç´¢
                    await this.searchCurrentType();
                }
            },
            
            async searchCurrentType() {
                if (!this.searchQuery.trim()) return;
                
                try {
                    const currentType = this.searchOptions.searchType;
                    
                    if (currentType === 'track') {
                        // æœç´¢æ­Œæ›²
                        const response = await window.api.searchMusic(this.searchQuery, this.searchOptions);
                        this.allSearchResults.tracks = response.data?.tracks || response.tracks || [];
                    } else {
                        // æœç´¢å…¶ä»–ç±»å‹
                        const response = await window.api.searchMultiType(this.searchQuery, [currentType], this.searchOptions.limit);
                        
                        // æ­£ç¡®å¤„ç†å“åº”æ•°æ®
                        if (currentType === 'playlist') {
                            this.allSearchResults.playlists = response.playlists || [];
                        } else if (currentType === 'album') {
                            this.allSearchResults.albums = response.albums || [];
                        } else if (currentType === 'artist') {
                            this.allSearchResults.artists = response.artists || [];
                        }
                    }
                    
                    this.hasSearched = true;
                    console.log(`æœç´¢${currentType}å®Œæˆï¼Œç»“æœæ•°é‡:`, this.searchResults.length);
                    
                } catch (error) {
                    console.error('æœç´¢é”™è¯¯:', error);
                    this.$root.showError('æœç´¢å¤±è´¥: ' + error.message);
                }
            },
            
            getSearchTypeText() {
                const type = this.searchTypes.find(t => t.key === this.searchOptions.searchType);
                return type ? type.name : '';
            },
            
            async switchSearchType(typeKey) {
                this.searchOptions.searchType = typeKey;
                this.selectedItems = []; // åˆ‡æ¢ç±»å‹æ—¶æ¸…ç©ºé€‰æ‹©
                
                // å¦‚æœå·²ç»æœç´¢è¿‡ï¼Œè‡ªåŠ¨è·å–æ–°ç±»å‹çš„ç»“æœ
                if (this.hasSearched && this.searchQuery.trim()) {
                    await this.searchCurrentType();
                }
            },
            
            getResultCount(typeKey) {
                const typeMap = {
                    'track': 'tracks',
                    'playlist': 'playlists',
                    'album': 'albums', 
                    'artist': 'artists'
                };
                return this.allSearchResults[typeMap[typeKey]]?.length || 0;
            },
            
            async addToLibrary(track) {
                try {
                    await window.api.addToLibrary(track.id, {
                        category: 'æœç´¢æ”¶è—',
                        country: track.country,
                        language: track.language,
                        tags: `æœç´¢,${track.artist || ''},${track.album || ''}`,
                        notes: `æ¥è‡ªæœç´¢ç»“æœ: ${track.title} - ${track.artist}`
                    });
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`"${track.title}" å·²æ·»åŠ åˆ°æ”¶è—åº“`);
                } catch (error) {
                    this.$root.showError('æ·»åŠ å¤±è´¥: ' + error.message);
                }
            },
            
            async downloadTrack(track) {
                try {
                    const response = await window.api.downloadSingle(track.id);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            playPreview(track) {
                this.$root.currentTrack = track;
            },
            
            async importPlaylist(playlist) {
                // æ˜¾ç¤ºè‡ªå®šä¹‰å¯¼å…¥è®¾ç½®æ¨¡æ€æ¡†
                this.playlistImportModal = {
                    show: true,
                    playlist: playlist,
                    settings: {
                        category: `Spotifyæ­Œå•`,
                        customCountry: 'korea',  // é»˜è®¤éŸ©å›½
                        customRegion: '',
                        tags: `æ­Œå•,${playlist.name},${playlist.owner || ''}`,
                        notes: `æ¥è‡ªSpotifyæ­Œå•: ${playlist.name}`
                    }
                };
            },
            
            async confirmPlaylistImport() {
                try {
                    const playlist = this.playlistImportModal.playlist;
                    const settings = this.playlistImportModal.settings;
                    
                    let tracks = [];
                    
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è§£æçš„æ­Œæ›²åˆ—è¡¨ï¼ˆæ¥è‡ªURLè§£æï¼‰
                    if (playlist.tracks && playlist.tracks.length > 0) {
                        tracks = playlist.tracks;
                    } else {
                        // è§£æSpotifyæ­Œå•è·å–æ­Œæ›²åˆ—è¡¨
                        const playlistUrl = playlist.spotify_url || `https://open.spotify.com/playlist/${playlist.id}`;
                        const parseResponse = await window.api.parseSpotifyUrl(playlistUrl);
                        
                        if (!parseResponse.tracks || parseResponse.tracks.length === 0) {
                            this.$root.showError('æ­Œå•ä¸­æ²¡æœ‰å¯å¯¼å…¥çš„æ­Œæ›²');
                            return;
                        }
                        tracks = parseResponse.tracks;
                    }
                    
                    // ç›´æ¥æ·»åŠ åˆ°æ”¶è—åº“ï¼ˆä½¿ç”¨è‡ªå®šä¹‰è®¾ç½®ï¼‰
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const track of tracks) {
                        try {
                            await window.api.addToLibrary(track.id, {
                                category: settings.category,
                                tags: settings.tags,
                                notes: settings.notes,
                                custom_country: this.countryMap[settings.customCountry] || settings.customCountry,
                                custom_region: settings.customRegion,
                                custom_language: this.languageMap[settings.customLanguage] || settings.customLanguage
                            });
                            successCount++;
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    
                    this.playlistImportModal.show = false;
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`æ­Œå• "${playlist.name}" å·²å¯¼å…¥æ”¶è—åº“ï¼ŒæˆåŠŸ ${successCount} é¦–${errorCount > 0 ? `ï¼Œå¤±è´¥ ${errorCount} é¦–` : ''}`);
                    
                } catch (error) {
                    this.$root.showError('å¯¼å…¥æ­Œå•å¤±è´¥: ' + error.message);
                }
            },
            
            async importAlbum(album) {
                try {
                    // ç®€åŒ–å¯¼å…¥ï¼šç›´æ¥æ·»åŠ åˆ°æ”¶è—åº“
                    await window.api.addToLibrary(album.id, {
                        category: `ä¸“è¾‘`,
                        tags: `ä¸“è¾‘,${album.artist || ''},${album.total_tracks || 0}é¦–`,
                        notes: `æ¥è‡ªSpotifyä¸“è¾‘: ${album.name} (${album.release_date?.slice(0,4) || ''})`
                    });
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`ä¸“è¾‘ "${album.name}" å·²æ·»åŠ åˆ°æ”¶è—åº“`);
                } catch (error) {
                    this.$root.showError('å¯¼å…¥ä¸“è¾‘å¤±è´¥: ' + error.message);
                }
            },
            
            async searchArtistTracks(artist) {
                try {
                    // æœç´¢è‰ºäººçš„çƒ­é—¨æ­Œæ›²
                    this.searchQuery = artist.name;
                    this.searchOptions.searchType = 'track';
                    await this.search();
                    this.$root.showSuccess(`æ­£åœ¨æ˜¾ç¤º ${artist.name} çš„çƒ­é—¨æ­Œæ›²`);
                } catch (error) {
                    this.$root.showError('è·å–è‰ºäººæ­Œæ›²å¤±è´¥: ' + error.message);
                }
            },
            
            formatFollowers(count) {
                if (!count) return '0';
                if (count > 1000000) {
                    return (count / 1000000).toFixed(1) + 'M';
                } else if (count > 1000) {
                    return (count / 1000).toFixed(1) + 'K';
                }
                return count.toString();
            },
            
            // æ‰¹é‡æ“ä½œæ–¹æ³•
            toggleSelectAll() {
                if (this.selectedItems.length === this.searchResults.length) {
                    this.selectedItems = [];
                } else {
                    this.selectedItems = this.searchResults.map(item => item.id);
                }
            },
            
            // åé€‰
            invertSelection() {
                const allIds = this.searchResults.map(item => item.id);
                const currentSelected = new Set(this.selectedItems);
                this.selectedItems = allIds.filter(id => !currentSelected.has(id));
            },
            
            // åœ°åŒºåˆ†ç»„å˜æ›´å¤„ç†
            onRegionGroupChange() {
                if (this.searchOptions.regionGroup) {
                    // é€‰æ‹©åœ°åŒºåˆ†ç»„æ—¶æ¸…ç©ºå•ä¸ªå›½å®¶é€‰æ‹©
                    this.searchOptions.countryFilter = '';
                }
            },
            
            showLibraryImportModal() {
                this.importToLibraryModal = true;
            },
            
            // å¿«é€Ÿæ‰¹é‡æ“ä½œï¼ˆä½¿ç”¨é»˜è®¤è®¾ç½®ï¼‰
            async quickBatchImport() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // ä¿å­˜é€‰ä¸­é¡¹ç›®å‰¯æœ¬
                    const selectedItemIds = [...this.selectedItems];
                    
                    // è½¬æ¢é»˜è®¤è®¾ç½®ä¸­çš„å›½å®¶å’Œè¯­è¨€å€¼ä¸ºä¸­æ–‡
                    const convertedSettings = {
                        ...this.defaultImportSettings,
                        country: this.countryMap[this.defaultImportSettings.country] || this.defaultImportSettings.country,
                        language: this.languageMap[this.defaultImportSettings.language] || this.defaultImportSettings.language
                    };
                    
                    // è°ƒç”¨åç«¯APIå¯åŠ¨æ‰¹é‡ä»»åŠ¡
                    const response = await window.api.startBatchImport({
                        items: selectedItemIds,
                        search_type: this.searchOptions.searchType,
                        settings: convertedSettings
                    });
                    
                    // åˆ›å»ºæœ¬åœ°ä»»åŠ¡è·Ÿè¸ª
                    const taskId = this.createBatchTask('library_import', selectedItemIds.length, response.task_id);
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    this.pollTaskStatus(response.task_id);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    this.importToLibraryModal = false;
                    
                    // æ¸…ç©ºé€‰æ‹©
                    const selectedCount = selectedItemIds.length;
                    this.selectedItems = [];
                    
                    this.$root.showSuccess(`å·²å¯åŠ¨æ‰¹é‡å¯¼å…¥ä»»åŠ¡ï¼Œå…± ${selectedCount} é¡¹ã€‚å¯åœ¨ä»»åŠ¡æ æŸ¥çœ‹è¿›åº¦ã€‚`);
                    
                } catch (error) {
                    this.$root.showError('å¯åŠ¨æ‰¹é‡ä»»åŠ¡å¤±è´¥: ' + error.message);
                }
            },
            
            // è‡ªå®šä¹‰æ‰¹é‡æ“ä½œï¼ˆå¯é…ç½®è®¾ç½®ï¼‰
            async confirmLibraryImport() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // ä¿å­˜é€‰ä¸­é¡¹ç›®å‰¯æœ¬
                    const selectedItemIds = [...this.selectedItems];
                    
                    // ä¿å­˜ä¸ºé»˜è®¤è®¾ç½®
                    if (this.libraryImportSettings.saveAsDefault) {
                        this.defaultImportSettings = { ...this.libraryImportSettings };
                        delete this.defaultImportSettings.saveAsDefault;
                        localStorage.setItem('defaultImportSettings', JSON.stringify(this.defaultImportSettings));
                    }
                    
                    // è½¬æ¢å›½å®¶å’Œè¯­è¨€å€¼ä¸ºä¸­æ–‡
                    const convertedSettings = {
                        ...this.libraryImportSettings,
                        country: this.countryMap[this.libraryImportSettings.country] || this.libraryImportSettings.country,
                        language: this.languageMap[this.libraryImportSettings.language] || this.libraryImportSettings.language
                    };
                    
                    // è°ƒç”¨åç«¯APIå¯åŠ¨æ‰¹é‡ä»»åŠ¡
                    const response = await window.api.startBatchImport({
                        items: selectedItemIds,
                        search_type: this.searchOptions.searchType,
                        settings: convertedSettings
                    });
                    
                    // åˆ›å»ºæœ¬åœ°ä»»åŠ¡è·Ÿè¸ª
                    const taskId = this.createBatchTask('library_import', selectedItemIds.length, response.task_id);
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    this.pollTaskStatus(response.task_id);
                    
                    this.importToLibraryModal = false;
                    const selectedCount = selectedItemIds.length;
                    this.selectedItems = [];
                    
                    this.$root.showSuccess(`å·²å¯åŠ¨æ‰¹é‡å¯¼å…¥ä»»åŠ¡ï¼Œå…± ${selectedCount} é¡¹ã€‚å¯åœ¨ä»»åŠ¡æ æŸ¥çœ‹è¿›åº¦ã€‚`);
                    
                } catch (error) {
                    this.$root.showError('å¯åŠ¨æ‰¹é‡ä»»åŠ¡å¤±è´¥: ' + error.message);
                }
            },
            
            // åˆ›å»ºæ‰¹é‡ä»»åŠ¡
            createBatchTask(type, total, celeryTaskId = null) {
                const taskId = celeryTaskId || Date.now().toString();
                const task = {
                    id: taskId,
                    celeryTaskId: celeryTaskId,
                    type: type,
                    total: total,
                    completed: 0,
                    failed: 0,
                    failedItems: [],
                    showFailureDetails: false,
                    status: 'running',
                    startTime: new Date(),
                    endTime: null
                };
                
                this.$root.batchTasks.push(task);
                this.$root.showBatchProgress = true;
                
                return taskId;
            },
            
            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            async pollTaskStatus(celeryTaskId) {
                const pollInterval = setInterval(async () => {
                    try {
                        const status = await window.api.getTaskStatus(celeryTaskId);
                        const task = this.$root.batchTasks.find(t => t.celeryTaskId === celeryTaskId);
                        
                        if (task) {
                            task.status = status.status;
                            
                            if (status.progress) {
                                task.completed = status.progress.completed || 0;
                                task.failed = status.progress.failed || 0;
                                task.total = status.progress.total || task.total;
                            }
                            
                            if (status.result) {
                                task.completed = status.result.completed || 0;
                                task.failed = status.result.failed || 0;
                                task.failedItems = status.result.failed_items || [];
                            }
                            
                            // ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥æ—¶åœæ­¢è½®è¯¢
                            if (status.status === 'success' || status.status === 'failure') {
                                clearInterval(pollInterval);
                                task.endTime = new Date();
                                
                                if (status.status === 'success') {
                                    let message = `æ‰¹é‡ä»»åŠ¡å®Œæˆï¼æˆåŠŸ ${task.completed} é¡¹`;
                                    if (task.failed > 0) {
                                        message += `ï¼Œå¤±è´¥ ${task.failed} é¡¹`;
                                        if (task.failedItems && task.failedItems.length > 0) {
                                            const failureReasons = task.failedItems.map(item => 
                                                `${item.item_id}: ${item.error}`
                                            ).join('\n');
                                            console.log('å¤±è´¥è¯¦æƒ…:', failureReasons);
                                        }
                                    }
                                    this.$root.showSuccess(message);
                                    this.$emit('song-added-to-library');
                                } else {
                                    this.$root.showError(`æ‰¹é‡ä»»åŠ¡å¤±è´¥: ${status.error || 'æœªçŸ¥é”™è¯¯'}`);
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                        // ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
                    }
                }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
                
                // 5åˆ†é’Ÿååœæ­¢è½®è¯¢
                setTimeout(() => {
                    clearInterval(pollInterval);
                }, 300000);
            },
            
            // å…³é—­æ‰¹é‡ä»»åŠ¡è¿›åº¦çª—å£
            closeBatchProgress() {
                this.$root.showBatchProgress = false;
            },
            
            // å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
            cancelBatchTask(taskId) {
                const task = this.$root.batchTasks.find(t => t.id === taskId);
                if (task && task.status === 'running') {
                    task.status = 'cancelled';
                    task.endTime = new Date();
                }
            },
            
            // è·å–ä»»åŠ¡çŠ¶æ€æ–‡æœ¬
            getTaskStatusText(status) {
                const statusMap = {
                    'running': 'è¿›è¡Œä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'failed': 'å·²å¤±è´¥', 
                    'cancelled': 'å·²å–æ¶ˆ'
                };
                return statusMap[status] || status;
            },
            
            // è·å–ä»»åŠ¡è¿›åº¦ç™¾åˆ†æ¯”
            getTaskProgress(task) {
                if (task.total === 0) return 0;
                return Math.round(((task.completed + task.failed) / task.total) * 100);
            },
            
            async batchImportToPlaylist() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const itemId of this.selectedItems) {
                        const item = this.searchResults.find(r => r.id === itemId);
                        if (!item) continue;
                        
                        try {
                            if (this.searchOptions.searchType === 'playlist') {
                                await this.importPlaylist(item);
                            } else if (this.searchOptions.searchType === 'album') {
                                await this.importAlbum(item);
                            }
                            successCount++;
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    
                    this.selectedItems = [];
                    
                    if (successCount > 0) {
                        this.$root.showSuccess(`æˆåŠŸå¯¼å…¥ ${successCount} ä¸ª${this.getSearchTypeText()}${errorCount > 0 ? `ï¼Œ${errorCount} ä¸ªå¤±è´¥` : ''}`);
                    }
                    
                } catch (error) {
                    this.$root.showError('æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            }
        },
        mounted() {
            // ä»localStorageåŠ è½½é»˜è®¤è®¾ç½®
            const savedSettings = localStorage.getItem('defaultImportSettings');
            if (savedSettings) {
                try {
                    this.defaultImportSettings = { ...JSON.parse(savedSettings) };
                } catch (error) {
                    console.log('åŠ è½½é»˜è®¤è®¾ç½®å¤±è´¥:', error);
                }
            }
        }
    });
    
    // æ”¶è—åº“ç»„ä»¶
    app.component('library-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-bookmark text-blue-600 mr-2"></i>éŸ³ä¹æ”¶è—åº“
                    </h2>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div v-if="stats" class="text-sm text-gray-600">
                        å…± {{ stats.total_songs }} é¦– | 
                        å·²ä¸‹è½½ {{ stats.downloaded_songs }} é¦– |
                        å¯è¯•å¬ {{ stats.preview_available }} é¦–
                    </div>
                </div>
                
                <!-- ç­›é€‰å™¨ -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-3">ç­›é€‰æ¡ä»¶</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <select v-model="filters.regionGroup" @change="onRegionGroupChange" class="px-3 py-2 border rounded">
                            <option value="">æ‰€æœ‰åœ°åŒº</option>
                            <option value="asia">äºšæ´²</option>
                            <option value="eastasia">ä¸œäºš</option>
                            <option value="japankorea">æ—¥éŸ©</option>
                            <option value="southeast">ä¸œå—äºš</option>
                            <option value="southasia">å—äºš</option>
                            <option value="europe">æ¬§æ´²</option>
                            <option value="westerneurope">è¥¿æ¬§</option>
                            <option value="easterneurope">ä¸œæ¬§</option>
                            <option value="northamerica">åŒ—ç¾</option>
                            <option value="southamerica">å—ç¾</option>
                            <option value="oceania">å¤§æ´‹æ´²</option>
                            <option value="middleeast">ä¸­ä¸œ</option>
                            <option value="africa">éæ´²</option>
                        </select>
                        
                        <select v-model="filters.country" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">æ‰€æœ‰å›½å®¶</option>
                            <option value="ä¸­å›½">ä¸­å›½</option>
                            <option value="éŸ©å›½">éŸ©å›½</option>
                            <option value="æ—¥æœ¬">æ—¥æœ¬</option>
                            <option value="ç¾å›½">ç¾å›½</option>
                            <option value="è‹±å›½">è‹±å›½</option>
                            <option value="åœŸè€³å…¶">åœŸè€³å…¶</option>
                            <option value="å°æ¹¾">å°æ¹¾</option>
                            <option value="æ³°å›½">æ³°å›½</option>
                            <option value="è¶Šå—">è¶Šå—</option>
                            <option value="æ–°åŠ å¡">æ–°åŠ å¡</option>
                            <option value="é©¬æ¥è¥¿äºš">é©¬æ¥è¥¿äºš</option>
                            <option value="å°åº¦å°¼è¥¿äºš">å°åº¦å°¼è¥¿äºš</option>
                            <option value="è²å¾‹å®¾">è²å¾‹å®¾</option>
                            <option value="å°åº¦">å°åº¦</option>
                            <option value="åŠ æ‹¿å¤§">åŠ æ‹¿å¤§</option>
                            <option value="æ¾³å¤§åˆ©äºš">æ¾³å¤§åˆ©äºš</option>
                            <option value="æ³•å›½">æ³•å›½</option>
                            <option value="å¾·å›½">å¾·å›½</option>
                            <option value="è¥¿ç­ç‰™">è¥¿ç­ç‰™</option>
                            <option value="æ„å¤§åˆ©">æ„å¤§åˆ©</option>
                            <option value="ä¿„ç½—æ–¯">ä¿„ç½—æ–¯</option>
                            <option value="å·´è¥¿">å·´è¥¿</option>
                            <option value="å¢¨è¥¿å“¥">å¢¨è¥¿å“¥</option>
                            <option value="é˜¿æ ¹å»·">é˜¿æ ¹å»·</option>
                        </select>
                        
                        <select v-model="filters.language" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">æ‰€æœ‰è¯­è¨€</option>
                            <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                            <option value="éŸ©è¯­">éŸ©è¯­</option>
                            <option value="æ—¥è¯­">æ—¥è¯­</option>
                            <option value="è‹±è¯­">è‹±è¯­</option>
                            <option value="åœŸè€³å…¶è¯­">åœŸè€³å…¶è¯­</option>
                            <option value="æ³•è¯­">æ³•è¯­</option>
                            <option value="å¾·è¯­">å¾·è¯­</option>
                            <option value="è¥¿ç­ç‰™è¯­">è¥¿ç­ç‰™è¯­</option>
                            <option value="æ„å¤§åˆ©è¯­">æ„å¤§åˆ©è¯­</option>
                            <option value="ä¿„è¯­">ä¿„è¯­</option>
                            <option value="è‘¡è„ç‰™è¯­">è‘¡è„ç‰™è¯­</option>
                            <option value="é˜¿æ‹‰ä¼¯è¯­">é˜¿æ‹‰ä¼¯è¯­</option>
                            <option value="å°åœ°è¯­">å°åœ°è¯­</option>
                            <option value="æ³°è¯­">æ³°è¯­</option>
                            <option value="è¶Šå—è¯­">è¶Šå—è¯­</option>
                            <option value="é©¬æ¥è¯­">é©¬æ¥è¯­</option>
                            <option value="å°å°¼è¯­">å°å°¼è¯­</option>
                            <option value="è²å¾‹å®¾è¯­">è²å¾‹å®¾è¯­</option>
                        </select>
                        
                        <select v-model="filters.has_preview" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">è¯•å¬çŠ¶æ€</option>
                            <option value="true">å¯è¯•å¬</option>
                            <option value="false">ä¸å¯è¯•å¬</option>
                        </select>
                        
                        <select v-model="filters.is_downloaded" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">ä¸‹è½½çŠ¶æ€</option>
                            <option value="true">å·²ä¸‹è½½</option>
                            <option value="false">æœªä¸‹è½½</option>
                        </select>
                    </div>
                </div>
                
                <!-- å…¨é€‰å’Œæ‰¹é‡æ“ä½œ -->
                <div class="mb-4 space-y-3">
                    <!-- é€‰æ‹©ç»Ÿè®¡å’Œæ‰¹é‡æ“ä½œæŒ‰é’® -->
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700">
                                å½“å‰é¡µï¼š{{ libraryItems.length }} é¦– | 
                                æ€»è®¡ï¼š{{ totalItems }} é¦–
                                <span v-if="selectedItems.length > 0" class="text-blue-700">
                                    | å·²é€‰æ‹©ï¼š{{ selectedItems.length }} é¦–
                                </span>
                            </span>
                        </div>
                        
                        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                        <div v-if="selectedItems.length > 0" class="flex space-x-2">
                            <button @click="batchDownload" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                <i class="fas fa-download mr-2"></i>æ‰¹é‡ä¸‹è½½
                            </button>
                            <button @click="showCreatePlaylistModal" 
                                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                                <i class="fas fa-list-music mr-2"></i>æ·»åŠ åˆ°æ­Œå•
                            </button>
                            <button @click="clearSelection" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                                å–æ¶ˆé€‰æ‹©
                            </button>
                        </div>
                    </div>
                    
                    <!-- å…¨é€‰é€‰é¡¹ -->
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   :checked="selectedItems.length === libraryItems.length && libraryItems.length > 0"
                                   @change="toggleSelectCurrentPage"
                                   class="mr-2">
                            å…¨é€‰å½“å‰é¡µ ({{ libraryItems.length }} é¦–)
                        </label>
                        
                        <button @click="selectAllResults" 
                                :disabled="isSelectingAll"
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 transition">
                            <i class="fas fa-check-double mr-1"></i>
                            {{ isSelectingAll ? 'æ­£åœ¨åŠ è½½...' : 'å…¨é€‰æ‰€æœ‰ç»“æœ (' + totalItems + ' é¦–)' }}
                        </button>
                        
                        <button v-if="selectedItems.length > 0" 
                                @click="invertSelection" 
                                class="px-3 py-1 text-sm bg-orange-500 text-white rounded hover:bg-orange-600 transition"
                                title="åé€‰å½“å‰é€‰æ‹©">
                            <i class="fas fa-exchange-alt mr-1"></i>åé€‰
                        </button>
                        
                        <button v-if="selectedItems.length > 0" 
                                @click="clearSelection" 
                                class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-1"></i>æ¸…ç©ºé€‰æ‹©
                        </button>
                    </div>
                </div>
                
                <!-- æ”¶è—åˆ—è¡¨ -->
                <div v-if="libraryItems.length > 0" class="space-y-4">
                    <div v-for="item in libraryItems" :key="item.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="item.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                
                                <!-- ä¸“è¾‘å°é¢ -->
                                <img v-if="item.song.album_art" 
                                     :src="item.song.album_art" 
                                     :alt="item.song.album"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400 text-2xl"></i>
                                </div>
                                
                                <!-- æ­Œæ›²ä¿¡æ¯ -->
                                <div>
                                    <h4 class="font-semibold">
                                        {{ item.song.title }}
                                        <span v-if="item.is_downloaded" class="ml-2 text-green-600">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                    </h4>
                                    <p class="text-sm text-gray-600">{{ item.song.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ item.song.album }} 
                                        <span v-if="item.song.year">({{ item.song.year }})</span>
                                        <span v-if="item.song.country" class="ml-2">
                                            <i class="fas fa-globe text-gray-400"></i> {{ item.song.country }}
                                        </span>
                                        <span v-if="item.category" class="ml-2">
                                            <i class="fas fa-folder text-gray-400"></i> {{ item.category }}
                                        </span>
                                    </p>
                                    <p v-if="item.tags" class="text-xs text-gray-400 mt-1">
                                        <i class="fas fa-tags mr-1"></i>{{ item.tags }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <button v-if="item.song.preview_url" 
                                        @click="playPreview(item.song)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-play"></i>
                                </button>
                                
                                <button v-if="!item.is_downloaded" 
                                        @click="downloadItem(item)"
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download"></i>
                                </button>
                                
                                <button @click="removeFromLibrary(item.id)"
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div v-else class="text-center py-12 text-gray-500">
                    <i class="fas fa-bookmark text-6xl mb-4"></i>
                    <p class="text-lg">æ”¶è—åº“æ˜¯ç©ºçš„</p>
                    <p class="text-sm mt-2">ä»æœç´¢ç»“æœä¸­æ·»åŠ æ­Œæ›²åˆ°æ”¶è—åº“</p>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div v-if="totalPages > 1" class="mt-6 flex justify-center space-x-2">
                    <button v-for="page in totalPages" :key="page"
                            @click="currentPage = page; loadLibrary()"
                            :class="currentPage === page ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded hover:opacity-80 transition">
                        {{ page }}
                    </button>
                </div>
                
                <!-- åˆ›å»º/æ·»åŠ åˆ°æ­Œå•æ¨¡æ€æ¡† -->
                <div v-if="showPlaylistModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">æ·»åŠ åˆ°æ­Œå•</h3>
                        
                        <div class="space-y-4">
                            <!-- é€‰æ‹©ç°æœ‰æ­Œå• -->
                            <div v-if="availablePlaylists.length > 0">
                                <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç°æœ‰æ­Œå•</label>
                                <select v-model="selectedPlaylistId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">-- é€‰æ‹©æ­Œå• --</option>
                                    <option v-for="playlist in availablePlaylists" :key="playlist.id" :value="playlist.id">
                                        {{ playlist.name }} ({{ playlist.song_count }} é¦–)
                                    </option>
                                </select>
                            </div>
                            
                            <!-- åˆ†éš”çº¿ -->
                            <div v-if="availablePlaylists.length > 0" class="flex items-center">
                                <div class="flex-1 border-t border-gray-300"></div>
                                <span class="px-3 text-sm text-gray-500">æˆ–è€…</span>
                                <div class="flex-1 border-t border-gray-300"></div>
                            </div>
                            
                            <!-- åˆ›å»ºæ–°æ­Œå• -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ›å»ºæ–°æ­Œå•</label>
                                <input v-model="newPlaylistName" 
                                       type="text" 
                                       placeholder="è¾“å…¥æ–°æ­Œå•åç§°"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ­Œå•æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea v-model="newPlaylistDescription" 
                                          placeholder="è¾“å…¥æ­Œå•æè¿°"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <span class="text-sm text-gray-500">å°†æ·»åŠ  {{ selectedItems.length }} é¦–æ­Œæ›²</span>
                            <div class="flex space-x-3">
                                <button @click="hidePlaylistModal" 
                                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                    å–æ¶ˆ
                                </button>
                                <button @click="confirmAddToPlaylist" 
                                        :disabled="!selectedPlaylistId && !newPlaylistName"
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition">
                                    ç¡®è®¤æ·»åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        data() {
            return {
                libraryItems: [],
                selectedItems: [],
                allSelectedSongs: [], // å­˜å‚¨å…¨é€‰æ—¶çš„æ‰€æœ‰æ­Œæ›²æ•°æ®
                stats: null,
                currentPage: 1,
                perPage: 20,
                totalItems: 0,
                filters: {
                    regionGroup: '',
                    country: '',
                    language: '',
                    has_preview: '',
                    is_downloaded: ''
                },
                // åœ°åŒºåˆ†ç»„æ˜ å°„
                regionGroupMapping: {
                    'asia': ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬', 'å°æ¹¾', 'æ³°å›½', 'è¶Šå—', 'æ–°åŠ å¡', 'é©¬æ¥è¥¿äºš', 'å°åº¦å°¼è¥¿äºš', 'è²å¾‹å®¾', 'å°åº¦'],
                    'eastasia': ['ä¸­å›½', 'éŸ©å›½', 'æ—¥æœ¬', 'å°æ¹¾'],
                    'japankorea': ['éŸ©å›½', 'æ—¥æœ¬'],
                    'southeast': ['æ³°å›½', 'è¶Šå—', 'æ–°åŠ å¡', 'é©¬æ¥è¥¿äºš', 'å°åº¦å°¼è¥¿äºš', 'è²å¾‹å®¾'],
                    'southasia': ['å°åº¦'],
                    'europe': ['è‹±å›½', 'æ³•å›½', 'å¾·å›½', 'è¥¿ç­ç‰™', 'æ„å¤§åˆ©', 'ä¿„ç½—æ–¯'],
                    'westerneurope': ['è‹±å›½', 'æ³•å›½', 'å¾·å›½', 'è¥¿ç­ç‰™', 'æ„å¤§åˆ©'],
                    'easterneurope': ['ä¿„ç½—æ–¯'],
                    'northamerica': ['ç¾å›½', 'åŠ æ‹¿å¤§'],
                    'southamerica': ['å·´è¥¿', 'å¢¨è¥¿å“¥', 'é˜¿æ ¹å»·'],
                    'oceania': ['æ¾³å¤§åˆ©äºš'],
                    'middleeast': ['åœŸè€³å…¶'],
                    'africa': []
                },
                // æ­Œå•ç›¸å…³
                showPlaylistModal: false,
                availablePlaylists: [],
                selectedPlaylistId: '',
                newPlaylistName: '',
                newPlaylistDescription: '',
                
                // å…¨é€‰ç›¸å…³
                isSelectingAll: false
            }
        },
        computed: {
            totalPages() {
                return Math.ceil(this.totalItems / this.perPage);
            }
        },
        mounted() {
            this.loadLibrary();
            this.loadStats();
        },
        methods: {
            // åœ°åŒºåˆ†ç»„æ”¹å˜æ—¶çš„å¤„ç†
            onRegionGroupChange() {
                if (this.filters.regionGroup) {
                    // æ¸…ç©ºå•ç‹¬çš„å›½å®¶ç­›é€‰ï¼Œè®©åœ°åŒºåˆ†ç»„ç”Ÿæ•ˆ
                    this.filters.country = '';
                }
                this.loadLibrary();
            },
            
            async loadLibrary() {
                try {
                    const params = {
                        page: this.currentPage,
                        per_page: this.perPage,
                        ...this.filters
                    };
                    
                    const response = await window.api.getLibrary(params);
                    const data = response.data || response;
                    this.libraryItems = data.entries || [];
                    this.totalItems = data.total || 0;
                } catch (error) {
                    this.$root.showError('åŠ è½½æ”¶è—åº“å¤±è´¥: ' + error.message);
                }
            },
            
            async loadStats() {
                try {
                    const response = await window.api.getLibraryStats();
                    this.stats = response.data || response;
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                }
            },
            
            async downloadItem(item) {
                try {
                    const response = await window.api.downloadFromLibrary([item.id]);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            async batchDownload() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    const response = await window.api.downloadFromLibrary(this.selectedItems);
                    this.$emit('download-started', response);
                    this.clearSelection();
                } catch (error) {
                    this.$root.showError('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            // å…¨é€‰/å–æ¶ˆå…¨é€‰å½“å‰é¡µ
            toggleSelectCurrentPage() {
                if (this.selectedItems.length === this.libraryItems.length && this.libraryItems.length > 0) {
                    // å¦‚æœå½“å‰é¡µå…¨é€‰äº†ï¼Œåˆ™å–æ¶ˆå½“å‰é¡µé€‰æ‹©
                    const currentPageIds = this.libraryItems.map(item => item.id);
                    this.selectedItems = this.selectedItems.filter(id => !currentPageIds.includes(id));
                } else {
                    // é€‰æ‹©å½“å‰é¡µæ‰€æœ‰é¡¹ç›®
                    const currentPageIds = this.libraryItems.map(item => item.id);
                    const newSelected = [...this.selectedItems];
                    currentPageIds.forEach(id => {
                        if (!newSelected.includes(id)) {
                            newSelected.push(id);
                        }
                    });
                    this.selectedItems = newSelected;
                }
            },
            
            // å…¨é€‰æ‰€æœ‰ç»“æœ
            async selectAllResults() {
                if (this.isSelectingAll) return;
                
                this.isSelectingAll = true;
                try {
                    // ä½¿ç”¨å½“å‰çš„ç­›é€‰æ¡ä»¶è·å–æ‰€æœ‰ç»“æœ
                    const params = {
                        per_page: this.totalItems, // è·å–æ‰€æœ‰ç»“æœ
                        page: 1,
                        ...this.filters
                    };
                    
                    const response = await window.api.getLibrary(params);
                    const allEntries = response.data?.entries || [];
                    
                    // å­˜å‚¨æ‰€æœ‰æ­Œæ›²æ•°æ®ï¼Œç”¨äºåç»­å¤„ç†
                    this.allSelectedSongs = allEntries;
                    
                    // é€‰æ‹©æ‰€æœ‰ç»“æœçš„ID
                    this.selectedItems = allEntries.map(entry => entry.id);
                    
                    this.$root.showSuccess(`å·²é€‰æ‹©æ‰€æœ‰ ${this.selectedItems.length} é¦–æ­Œæ›²`);
                    
                } catch (error) {
                    this.$root.showError('å…¨é€‰å¤±è´¥: ' + error.message);
                } finally {
                    this.isSelectingAll = false;
                }
            },
            
            // æ˜¾ç¤ºæ­Œå•é€‰æ‹©æ¨¡æ€æ¡†
            async showCreatePlaylistModal() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // åŠ è½½ç”¨æˆ·çš„æ­Œå•åˆ—è¡¨
                    const response = await window.api.getPlaylists();
                    this.availablePlaylists = response.data?.playlists || [];
                    this.showPlaylistModal = true;
                } catch (error) {
                    this.$root.showError('åŠ è½½æ­Œå•åˆ—è¡¨å¤±è´¥: ' + error.message);
                }
            },
            
            // éšè—æ­Œå•æ¨¡æ€æ¡†
            hidePlaylistModal() {
                this.showPlaylistModal = false;
                this.selectedPlaylistId = '';
                this.newPlaylistName = '';
                this.newPlaylistDescription = '';
            },
            
            // åŠ è½½å¯ç”¨æ­Œå•åˆ—è¡¨
            async loadAvailablePlaylists() {
                try {
                    const response = await window.api.getPlaylists();
                    this.availablePlaylists = response.data?.playlists || [];
                } catch (error) {
                    console.error('åŠ è½½æ­Œå•åˆ—è¡¨å¤±è´¥:', error);
                }
            },
            
            // ç¡®è®¤æ·»åŠ åˆ°æ­Œå•
            async confirmAddToPlaylist() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    let playlistId = this.selectedPlaylistId;
                    let playlistName = '';
                    
                    // å¦‚æœæ˜¯åˆ›å»ºæ–°æ­Œå•
                    if (!playlistId && this.newPlaylistName) {
                        const createResponse = await window.api.createPlaylist(
                            this.newPlaylistName, 
                            this.newPlaylistDescription
                        );
                        playlistId = createResponse.data.id;
                        playlistName = this.newPlaylistName;
                    } else if (playlistId) {
                        const playlist = this.availablePlaylists.find(p => p.id == playlistId);
                        playlistName = playlist ? playlist.name : 'æœªçŸ¥æ­Œå•';
                    }
                    
                    if (playlistId) {
                        // è·å–é€‰ä¸­é¡¹å¯¹åº”çš„æ­Œæ›²ID
                        let songIds = [];
                        
                        // å¦‚æœæœ‰å…¨é€‰çš„æ­Œæ›²æ•°æ®ï¼Œä½¿ç”¨å…¨é€‰æ•°æ®
                        if (this.allSelectedSongs.length > 0) {
                            songIds = this.allSelectedSongs
                                .filter(song => this.selectedItems.includes(song.id))
                                .map(song => song.song.database_id)
                                .filter(id => id !== null);
                        } else {
                            // å¦åˆ™ä»å½“å‰é¡µé¢æ•°æ®ä¸­è·å–
                            songIds = this.selectedItems.map(libraryId => {
                                const item = this.libraryItems.find(lib => lib.id === libraryId);
                                return item ? item.song.database_id : null;
                            }).filter(id => id !== null);
                        }
                        
                        // æ·»åŠ æ­Œæ›²åˆ°æ­Œå•
                        await window.api.addSongsToPlaylist(playlistId, songIds);
                        
                        this.$root.showSuccess(`æˆåŠŸæ·»åŠ  ${songIds.length} é¦–æ­Œæ›²åˆ°æ­Œå• "${playlistName}"`);
                        
                        // å¦‚æœåˆ›å»ºäº†æ–°æ­Œå•ï¼Œåˆ·æ–°æ­Œå•åˆ—è¡¨
                        if (this.newPlaylistName) {
                            await this.loadAvailablePlaylists();
                            // é€šçŸ¥æ ¹ç»„ä»¶åˆ·æ–°æ­Œå•åˆ—è¡¨
                            this.$root.loadPlaylists();
                        }
                        
                        this.hidePlaylistModal();
                        this.clearSelection();
                    }
                } catch (error) {
                    this.$root.showError('æ·»åŠ åˆ°æ­Œå•å¤±è´¥: ' + error.message);
                }
            },
            
            async createPlaylistFromSelected() {
                // è¿™ä¸ªæ–¹æ³•ç°åœ¨ç”± showCreatePlaylistModal æ›¿ä»£
                this.showCreatePlaylistModal();
            },
            
            async removeFromLibrary(id) {
                if (!confirm('ç¡®å®šè¦ä»æ”¶è—åº“ä¸­åˆ é™¤å—ï¼Ÿ')) return;
                
                try {
                    await window.api.deleteFromLibrary(id);
                    this.$root.showSuccess('å·²ä»æ”¶è—åº“åˆ é™¤');
                    this.loadLibrary();
                    this.loadStats();
                } catch (error) {
                    this.$root.showError('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            },
            
            // åé€‰
            invertSelection() {
                const allIds = this.libraryItems.map(item => item.id);
                const currentSelected = new Set(this.selectedItems);
                this.selectedItems = allIds.filter(id => !currentSelected.has(id));
            },
            
            clearSelection() {
                this.selectedItems = [];
                this.allSelectedSongs = []; // æ¸…ç©ºå…¨é€‰æ•°æ®
            },
            
            playPreview(song) {
                this.$root.currentTrack = song;
            }
        }
    });
    
    // æ­Œå•ç»„ä»¶
    app.component('playlists-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-list-music text-blue-600 mr-2"></i>æˆ‘çš„æ­Œå•
                    </h2>
                    <button @click="createPlaylist" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>åˆ›å»ºæ­Œå•
                    </button>
                </div>
                
                <!-- æ­Œå•åˆ—è¡¨è§†å›¾ -->
                <div v-if="!selectedPlaylist && playlists && playlists.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="playlist in playlists" :key="playlist.id" 
                         class="border rounded-lg p-4 hover:shadow-lg transition card-hover cursor-pointer"
                         @click="viewPlaylist(playlist)">
                        <div class="flex items-center space-x-4 mb-3">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white">
                                <i class="fas fa-music text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg">{{ playlist.name }}</h3>
                                <p class="text-sm text-gray-600">{{ playlist.song_count || playlist.total_tracks || 0 }} é¦–æ­Œæ›²</p>
                            </div>
                        </div>
                        
                        <p v-if="playlist.description" class="text-sm text-gray-500 mb-3">
                            {{ playlist.description }}
                        </p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">
                                åˆ›å»ºäº {{ formatDate(playlist.created_at) }}
                            </span>
                            <div class="space-x-2">
                                <button @click.stop="viewPlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button v-if="$root.isAuthenticated" 
                                        @click.stop="downloadPlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button v-if="$root.isAuthenticated" 
                                        @click.stop="deletePlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­Œå•è¯¦æƒ…è§†å›¾ -->
                <div v-if="selectedPlaylist" class="space-y-6">
                    <!-- æ­Œå•å¤´éƒ¨ä¿¡æ¯ -->
                    <div class="flex items-center justify-between p-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-20 h-20 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-music text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">{{ selectedPlaylist.name }}</h2>
                                <p class="text-blue-100">{{ selectedPlaylist.song_count }} é¦–æ­Œæ›²</p>
                                <p v-if="selectedPlaylist.description" class="text-blue-100 text-sm mt-1">
                                    {{ selectedPlaylist.description }}
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <!-- æ’­æ”¾å…¨éƒ¨ä¸‹æ‹‰èœå• -->
                            <div class="relative" v-click-outside="closePlayMenu">
                                <button @click="showPlayMenu = !showPlayMenu" 
                                        :disabled="!selectedPlaylist.songs || selectedPlaylist.songs.length === 0"
                                        class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition disabled:opacity-50 flex items-center">
                                    <i class="fas fa-play mr-2"></i>æ’­æ”¾å…¨éƒ¨
                                    <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                                
                                <!-- æ’­æ”¾é€‰é¡¹èœå• -->
                                <div v-if="showPlayMenu" class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border z-50 min-w-48">
                                    <button @click="playAllSongs('preview')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                                        <i class="fas fa-headphones mr-2 text-green-600"></i>
                                        <span>æ’­æ”¾è¯•å¬ç‰ˆæœ¬</span>
                                        <span class="ml-auto text-xs text-gray-500">({{ getPreviewCount() }} é¦–)</span>
                                    </button>
                                    <button @click="playAllSongs('downloaded')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                                        <i class="fas fa-play mr-2 text-blue-600"></i>
                                        <span>æ’­æ”¾ä¸‹è½½ç‰ˆæœ¬</span>
                                        <span class="ml-auto text-xs text-gray-500">({{ getDownloadedCount() }} é¦–)</span>
                                    </button>
                                    <button @click="playAllSongs('mixed')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center border-t">
                                        <i class="fas fa-random mr-2 text-purple-600"></i>
                                        <span>æ··åˆæ’­æ”¾</span>
                                        <span class="ml-auto text-xs text-gray-500">(ä¼˜å…ˆä¸‹è½½ç‰ˆæœ¬)</span>
                                    </button>
                                </div>
                            </div>
                            <button @click="downloadPlaylist(selectedPlaylist)" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
                                <i class="fas fa-download mr-2"></i>ä¸‹è½½æ­Œå•
                            </button>
                            <button @click="copyApiLink" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition"
                                    title="å¤åˆ¶APIæ¥å£é“¾æ¥">
                                <i class="fas fa-code mr-2"></i>APIé“¾æ¥
                            </button>
                            <button @click="selectedPlaylist = null" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
                                <i class="fas fa-arrow-left mr-2"></i>è¿”å›åˆ—è¡¨
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
                    <div v-if="selectedPlaylist.songs && selectedPlaylist.songs.length > 0" class="flex items-center justify-between mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700">
                                æ­Œæ›²æ€»æ•°ï¼š{{ selectedPlaylist.songs.length }} é¦–
                                <span v-if="selectedSongs.length > 0" class="text-blue-700">
                                    | å·²é€‰æ‹©ï¼š{{ selectedSongs.length }} é¦–
                                </span>
                            </span>
                        </div>
                        
                        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       :checked="selectedSongs.length === selectedPlaylist.songs.length && selectedPlaylist.songs.length > 0"
                                       @change="toggleSelectAllSongs"
                                       class="mr-2">
                                å…¨é€‰
                            </label>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="invertSongSelection" 
                                    class="px-3 py-1 text-sm bg-orange-500 text-white rounded hover:bg-orange-600 transition"
                                    title="åé€‰å½“å‰é€‰æ‹©">
                                <i class="fas fa-exchange-alt mr-1"></i>åé€‰
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="batchDownloadSongs" 
                                    class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                <i class="fas fa-download mr-1"></i>æ‰¹é‡ä¸‹è½½
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="batchRemoveSongs" 
                                    class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                <i class="fas fa-trash mr-1"></i>æ‰¹é‡ç§»é™¤
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="clearSongSelection" 
                                    class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-1"></i>æ¸…ç©ºé€‰æ‹©
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ­Œæ›²åˆ—è¡¨ -->
                    <div v-if="selectedPlaylist.songs && selectedPlaylist.songs.length > 0" class="space-y-2">
                        <div v-for="(song, index) in selectedPlaylist.songs" :key="song.id" 
                             class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition">
                            <div class="flex items-center space-x-4">
                                <!-- é€‰æ‹©æ¡† -->
                                <input type="checkbox" 
                                       :value="song.id" 
                                       v-model="selectedSongs"
                                       class="w-4 h-4 text-blue-600">
                                
                                <!-- åºå· -->
                                <div class="w-8 text-center text-gray-500">{{ index + 1 }}</div>
                                
                                <!-- ä¸“è¾‘å°é¢ -->
                                <img v-if="song.album_art_url" 
                                     :src="song.album_art_url" 
                                     :alt="song.album"
                                     class="w-12 h-12 rounded object-cover">
                                <div v-else class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400"></i>
                                </div>
                                
                                <!-- æ­Œæ›²ä¿¡æ¯ -->
                                <div class="flex-1">
                                    <h4 class="font-semibold">{{ song.title }}</h4>
                                    <p class="text-sm text-gray-600">{{ song.artist }}</p>
                                    <p class="text-xs text-gray-500">{{ song.album }}</p>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span v-if="song.is_downloaded" class="inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                            <i class="fas fa-check-circle mr-1"></i>å·²ä¸‹è½½
                                        </span>
                                        <span v-if="song.preview_url" class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                            <i class="fas fa-headphones mr-1"></i>å¯è¯•å¬
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- æ—¶é•¿ -->
                                <div class="text-sm text-gray-500">
                                    {{ formatDuration(song.duration) }}
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex items-center space-x-2">
                                <!-- æ’­æ”¾æŒ‰é’®ç»„ -->
                                <div class="flex items-center space-x-1">
                                    <button v-if="song.preview_url" 
                                            @click="playSong(song, 'preview')"
                                            class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition"
                                            title="æ’­æ”¾è¯•å¬">
                                        <i class="fas fa-headphones"></i>
                                    </button>
                                    <button v-if="song.is_downloaded && song.file_url" 
                                            @click="playSong(song, 'downloaded')"
                                            class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                                            title="æ’­æ”¾ä¸‹è½½ç‰ˆæœ¬">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                
                                <button @click="downloadSong(song)"
                                        :class="song.is_downloaded ? 'bg-gray-500 hover:bg-gray-600' : 'bg-purple-600 hover:bg-purple-700'"
                                        class="px-3 py-1 text-sm text-white rounded transition"
                                        :title="song.is_downloaded ? 'é‡æ–°ä¸‹è½½' : 'ä¸‹è½½æ­Œæ›²'">
                                    <i class="fas fa-download"></i>
                                </button>
                                
                                <button @click="removeSongFromPlaylist(song)"
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition"
                                        title="ä»æ­Œå•ç§»é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç©ºæ­Œå•æç¤º -->
                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-music text-6xl mb-4"></i>
                        <p class="text-lg">æ­Œå•æ˜¯ç©ºçš„</p>
                        <p class="text-sm mt-2">ä»æ”¶è—åº“æ·»åŠ æ­Œæ›²åˆ°è¿™ä¸ªæ­Œå•</p>
                    </div>
                </div>
                
                <!-- ç©ºæ­Œå•åˆ—è¡¨æç¤º -->
                <div v-else-if="!selectedPlaylist && (!playlists || playlists.length === 0)" class="text-center py-12 text-gray-500">
                    <i class="fas fa-list-music text-6xl mb-4"></i>
                    <p class="text-lg">è¿˜æ²¡æœ‰åˆ›å»ºæ­Œå•</p>
                    <p class="text-sm mt-2">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªæ­Œå•</p>
                </div>
            </div>
        `,
        props: ['playlists'],
        data() {
            return {
                selectedPlaylist: null,  // å½“å‰æŸ¥çœ‹çš„æ­Œå•è¯¦æƒ…
                showPlayMenu: false,     // æ’­æ”¾èœå•æ˜¾ç¤ºçŠ¶æ€
                selectedSongs: []        // é€‰ä¸­çš„æ­Œæ›²IDåˆ—è¡¨
            }
        },
        methods: {
            createPlaylist() {
                const name = prompt('è¯·è¾“å…¥æ­Œå•åç§°:');
                if (!name) return;
                
                api.createPlaylist(name).then(() => {
                    this.$emit('playlist-updated');
                }).catch(error => {
                    this.$root.showError('åˆ›å»ºå¤±è´¥: ' + error.message);
                });
            },
            
            async viewPlaylist(playlist) {
                try {
                    // è·å–æ­Œå•è¯¦æƒ…
                    const response = await window.api.getPlaylistDetail(playlist.id);
                    this.selectedPlaylist = response.data;
                } catch (error) {
                    this.$root.showError('åŠ è½½æ­Œå•è¯¦æƒ…å¤±è´¥: ' + error.message);
                }
            },
            
            async downloadPlaylist(playlist) {
                // æ£€æŸ¥æƒé™
                if (!this.$root.requireAuth('ä¸‹è½½æ­Œå•')) return;
                
                try {
                    const response = await window.api.downloadPlaylist(playlist.id);
                    this.$emit('download-started', response);
                    this.$root.showSuccess(`æ­Œå• "${playlist.name}" ä¸‹è½½å·²å¯åŠ¨`);
                    
                    // 5ç§’ååˆ·æ–°æ­Œå•è¯¦æƒ…ä»¥æ›´æ–°ä¸‹è½½çŠ¶æ€
                    setTimeout(async () => {
                        if (this.selectedPlaylist && this.selectedPlaylist.id === playlist.id) {
                            await this.viewPlaylist(this.selectedPlaylist);
                        }
                    }, 5000);
                } catch (error) {
                    this.$root.showError('ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            deletePlaylist(playlist) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ­Œå• "${playlist.name}" å—ï¼Ÿ`)) return;
                
                api.deletePlaylist(playlist.id).then(() => {
                    this.$emit('playlist-updated');
                }).catch(error => {
                    this.$root.showError('åˆ é™¤å¤±è´¥: ' + error.message);
                });
            },
            
            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('zh-CN');
            },
            
            // æ ¼å¼åŒ–æ—¶é•¿
            formatDuration(seconds) {
                if (!seconds) return '--:--';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            },
            
            // æ’­æ”¾å•é¦–æ­Œæ›²
            playSong(song, mode = 'preview') {
                let audioUrl = null;
                let trackTitle = song.title;
                
                if (mode === 'downloaded' && song.is_downloaded && song.file_url) {
                    // æ’­æ”¾ä¸‹è½½çš„æ–‡ä»¶
                    audioUrl = song.file_url; // ç›´æ¥ä½¿ç”¨APIæä¾›çš„URL
                    trackTitle += ' (ä¸‹è½½ç‰ˆæœ¬)';
                } else if (song.preview_url) {
                    // æ’­æ”¾è¯•å¬ç‰ˆæœ¬
                    audioUrl = song.preview_url;
                    trackTitle += ' (è¯•å¬ç‰ˆæœ¬)';
                } else {
                    this.$root.showError('æ­¤æ­Œæ›²æš‚æ— å¯æ’­æ”¾ç‰ˆæœ¬');
                    return;
                }
                
                this.$root.currentTrack = {
                    id: song.spotify_id,
                    title: trackTitle,
                    artist: song.artist,
                    album: song.album,
                    album_art: song.album_art_url,
                    audio_url: audioUrl,
                    preview_url: song.preview_url,
                    duration: song.duration,
                    mode: mode
                };
            },
            
            // æ’­æ”¾æ‰€æœ‰æ­Œæ›²
            playAllSongs(mode = 'mixed') {
                this.showPlayMenu = false;
                let playableSongs = [];
                
                if (mode === 'preview') {
                    playableSongs = this.selectedPlaylist.songs.filter(song => song.preview_url);
                } else if (mode === 'downloaded') {
                    playableSongs = this.selectedPlaylist.songs.filter(song => song.is_downloaded && song.file_url);
                } else { // mixed mode
                    playableSongs = this.selectedPlaylist.songs.filter(song => 
                        (song.is_downloaded && song.file_url) || song.preview_url
                    );
                }
                
                if (playableSongs.length > 0) {
                    // åˆ›å»ºæ’­æ”¾é˜Ÿåˆ—
                    const playlist = playableSongs.map((song, index) => ({
                        ...song,
                        playMode: mode === 'mixed' 
                            ? (song.is_downloaded && song.file_url ? 'downloaded' : 'preview')
                            : mode,
                        queueIndex: index
                    }));
                    
                    // å¼€å§‹æ’­æ”¾ç¬¬ä¸€é¦–
                    this.playPlaylist(playlist);
                    
                    const modeText = {
                        'preview': 'è¯•å¬ç‰ˆæœ¬',
                        'downloaded': 'ä¸‹è½½ç‰ˆæœ¬', 
                        'mixed': 'æ··åˆæ¨¡å¼'
                    };
                    
                    this.$root.showSuccess(`å¼€å§‹æ’­æ”¾æ­Œå•(${modeText[mode]})ï¼Œå…± ${playableSongs.length} é¦–æ­Œæ›²`);
                } else {
                    const errorText = {
                        'preview': 'æ²¡æœ‰å¯è¯•å¬çš„æ­Œæ›²',
                        'downloaded': 'æ²¡æœ‰å·²ä¸‹è½½çš„æ­Œæ›²',
                        'mixed': 'æ²¡æœ‰å¯æ’­æ”¾çš„æ­Œæ›²'
                    };
                    this.$root.showError(`æ­Œå•ä¸­${errorText[mode]}`);
                }
            },
            
            // æ’­æ”¾æ­Œå•é˜Ÿåˆ—
            playPlaylist(playlist) {
                this.$root.currentPlaylist = playlist;
                this.$root.currentPlaylistIndex = 0;
                this.playSong(playlist[0], playlist[0].playMode);
            },
            
            // è·å–è¯•å¬ç‰ˆæœ¬æ•°é‡
            getPreviewCount() {
                return this.selectedPlaylist?.songs?.filter(song => song.preview_url).length || 0;
            },
            
            // è·å–ä¸‹è½½ç‰ˆæœ¬æ•°é‡
            getDownloadedCount() {
                return this.selectedPlaylist?.songs?.filter(song => song.is_downloaded && song.file_url).length || 0;
            },
            
            // å…³é—­æ’­æ”¾èœå•
            closePlayMenu() {
                this.showPlayMenu = false;
            },
            
            // å¤åˆ¶APIé“¾æ¥
            async copyApiLink() {
                if (!this.selectedPlaylist) return;
                
                const baseUrl = window.location.origin;
                const apiUrl = `${baseUrl}/api/playlists/${this.selectedPlaylist.id}`;
                
                try {
                    await navigator.clipboard.writeText(apiUrl);
                    this.$root.showSuccess('APIæ¥å£é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    
                    // æ˜¾ç¤ºAPIä½¿ç”¨è¯´æ˜
                    this.$root.showApiInfo(apiUrl, this.selectedPlaylist);
                } catch (error) {
                    // é™çº§æ–¹æ¡ˆï¼šé€‰æ‹©æ–‡æœ¬
                    this.selectText(apiUrl);
                    this.$root.showSuccess('APIé“¾æ¥å·²é€‰ä¸­ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            },
            
            // é€‰æ‹©æ–‡æœ¬çš„é™çº§æ–¹æ¡ˆ
            selectText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.body.removeChild(textArea);
            },
            
            // ä¸‹è½½å•é¦–æ­Œæ›²
            async downloadSong(song) {
                try {
                    const response = await window.api.downloadSingle(song.spotify_id);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            // æ­Œæ›²é€‰æ‹©ç›¸å…³æ–¹æ³•
            toggleSelectAllSongs() {
                if (this.selectedSongs.length === this.selectedPlaylist.songs.length) {
                    this.selectedSongs = [];
                } else {
                    this.selectedSongs = this.selectedPlaylist.songs.map(song => song.id);
                }
            },
            
            // åé€‰æ­Œæ›²
            invertSongSelection() {
                const allSongIds = this.selectedPlaylist.songs.map(song => song.id);
                const currentSelected = new Set(this.selectedSongs);
                this.selectedSongs = allSongIds.filter(id => !currentSelected.has(id));
            },
            
            // æ¸…ç©ºæ­Œæ›²é€‰æ‹©
            clearSongSelection() {
                this.selectedSongs = [];
            },
            
            // æ‰¹é‡ä¸‹è½½æ­Œæ›²
            async batchDownloadSongs() {
                if (this.selectedSongs.length === 0) return;
                
                try {
                    const selectedSongData = this.selectedPlaylist.songs.filter(song => 
                        this.selectedSongs.includes(song.id)
                    );
                    
                    // è·å–æ”¶è—åº“IDåˆ—è¡¨
                    const libraryIds = selectedSongData
                        .filter(song => song.library_info?.library_id)
                        .map(song => song.library_info.library_id);
                    
                    if (libraryIds.length > 0) {
                        // ä½¿ç”¨æ”¶è—åº“æ‰¹é‡ä¸‹è½½API
                        const response = await window.api.downloadFromLibrary(libraryIds);
                        this.$emit('download-started', response);
                        this.$root.showSuccess(`å·²å¼€å§‹æ‰¹é‡ä¸‹è½½ ${libraryIds.length} é¦–æ­Œæ›²`);
                        
                        // 5ç§’ååˆ·æ–°æ­Œå•è¯¦æƒ…ä»¥æ›´æ–°ä¸‹è½½çŠ¶æ€
                        setTimeout(async () => {
                            await this.viewPlaylist(this.selectedPlaylist);
                        }, 5000);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ”¶è—åº“IDï¼Œé€ä¸ªä¸‹è½½ï¼ˆåŠ å»¶è¿Ÿé¿å…409å†²çªï¼‰
                        let successCount = 0;
                        for (let i = 0; i < selectedSongData.length; i++) {
                            try {
                                await this.downloadSong(selectedSongData[i]);
                                successCount++;
                                // æ·»åŠ å»¶è¿Ÿé¿å…409å†²çª
                                if (i < selectedSongData.length - 1) {
                                    await new Promise(resolve => setTimeout(resolve, 200));
                                }
                            } catch (error) {
                                console.warn(`ä¸‹è½½æ­Œæ›² "${selectedSongData[i].title}" å¤±è´¥:`, error.message);
                                this.$root.showError(`ä¸‹è½½ "${selectedSongData[i].title}" å¤±è´¥: ${error.message}`);
                            }
                        }
                        if (successCount > 0) {
                            this.$root.showSuccess(`å·²å¼€å§‹ä¸‹è½½ ${successCount} é¦–æ­Œæ›²`);
                        }
                    }
                    
                    this.clearSongSelection();
                } catch (error) {
                    this.$root.showError('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            },
            
            // æ‰¹é‡ç§»é™¤æ­Œæ›²
            async batchRemoveSongs() {
                if (this.selectedSongs.length === 0) return;
                
                if (!confirm(`ç¡®å®šè¦ä»æ­Œå•ä¸­ç§»é™¤ ${this.selectedSongs.length} é¦–æ­Œæ›²å—ï¼Ÿ`)) return;
                
                try {
                    for (const songId of this.selectedSongs) {
                        await window.api.removeSongFromPlaylist(this.selectedPlaylist.id, songId);
                    }
                    
                    this.$root.showSuccess(`å·²ç§»é™¤ ${this.selectedSongs.length} é¦–æ­Œæ›²`);
                    this.clearSongSelection();
                    // é‡æ–°åŠ è½½æ­Œå•è¯¦æƒ…
                    await this.viewPlaylist(this.selectedPlaylist);
                } catch (error) {
                    this.$root.showError('æ‰¹é‡ç§»é™¤å¤±è´¥: ' + error.message);
                }
            },
            
            // ä»æ­Œå•ç§»é™¤æ­Œæ›²
            async removeSongFromPlaylist(song) {
                if (!confirm(`ç¡®å®šè¦ä»æ­Œå•ä¸­ç§»é™¤ "${song.title}" å—ï¼Ÿ`)) return;
                
                try {
                    await window.api.removeSongFromPlaylist(this.selectedPlaylist.id, song.id);
                    this.$root.showSuccess('æ­Œæ›²å·²ä»æ­Œå•ç§»é™¤');
                    // é‡æ–°åŠ è½½æ­Œå•è¯¦æƒ…
                    await this.viewPlaylist(this.selectedPlaylist);
                } catch (error) {
                    this.$root.showError('ç§»é™¤å¤±è´¥: ' + error.message);
                }
            }
        }
    });
    
    // ä¸‹è½½ç»„ä»¶
    app.component('download-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-download text-blue-600 mr-2"></i>ä¸‹è½½ç®¡ç†
                    </h2>
                    <div v-if="downloadTasks && downloadTasks.length > 0" class="space-x-2">
                        <button @click="clearTasks('completed')" 
                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            <i class="fas fa-check-circle mr-1"></i>æ¸…é™¤å·²å®Œæˆ
                        </button>
                        <button @click="clearTasks('failed')" 
                                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            <i class="fas fa-exclamation-circle mr-1"></i>æ¸…é™¤å¤±è´¥
                        </button>
                        <button @click="clearAllTasks" 
                                class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                            <i class="fas fa-trash mr-1"></i>æ¸…é™¤å…¨éƒ¨
                        </button>
                    </div>
                </div>
                
                <div v-if="downloadTasks && downloadTasks.length > 0" class="space-y-4">
                    <div v-for="task in downloadTasks" :key="task.id" 
                         class="border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-semibold">{{ task.song_title }}</h4>
                                <p class="text-sm text-gray-600">{{ task.artist }}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span :class="getStatusClass(task.status)" class="px-3 py-1 rounded-full text-sm">
                                    {{ getStatusText(task.status) }}
                                </span>
                                <button v-if="task.status === 'pending' || task.status === 'downloading'" 
                                        @click="cancelTask(task.id)"
                                        class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div v-if="task.status === 'downloading'" class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full progress-bar" 
                                 :style="{width: task.progress + '%'}"></div>
                        </div>
                        
                        <!-- é”™è¯¯ä¿¡æ¯ -->
                        <p v-if="task.error_message" class="text-sm text-red-600 mt-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            {{ task.error_message }}
                        </p>
                    </div>
                </div>
                
                <div v-else class="text-center py-12 text-gray-500">
                    <i class="fas fa-download text-6xl mb-4"></i>
                    <p class="text-lg">æ²¡æœ‰ä¸‹è½½ä»»åŠ¡</p>
                </div>
            </div>
        `,
        props: ['downloadTasks'],
        methods: {
            getStatusClass(status) {
                const classes = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'downloading': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'failed': 'bg-red-100 text-red-800',
                    'cancelled': 'bg-gray-100 text-gray-800'
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            },
            
            getStatusText(status) {
                const texts = {
                    'pending': 'ç­‰å¾…ä¸­',
                    'downloading': 'ä¸‹è½½ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'failed': 'å¤±è´¥',
                    'cancelled': 'å·²å–æ¶ˆ'
                };
                return texts[status] || status;
            },
            
            async cancelTask(taskId) {
                try {
                    await window.api.cancelDownloadTask(taskId);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('å–æ¶ˆå¤±è´¥: ' + error.message);
                }
            },
            
            async clearTasks(status) {
                try {
                    const statusText = {
                        'completed': 'å·²å®Œæˆ',
                        'failed': 'å¤±è´¥',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    
                    if (!confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰${statusText[status]}çš„ä»»åŠ¡è®°å½•å—ï¼Ÿ`)) return;
                    
                    const response = await window.api.clearDownloadTasks(status);
                    this.$root.showSuccess(response.message);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('æ¸…é™¤å¤±è´¥: ' + error.message);
                }
            },
            
            async clearAllTasks() {
                if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¸‹è½½ä»»åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
                
                try {
                    const response = await window.api.clearDownloadTasks();
                    this.$root.showSuccess(response.message);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('æ¸…é™¤å¤±è´¥: ' + error.message);
                }
            }
        }
    });
    
    // éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶
    app.component('music-player', {
        template: `
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-30">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <img v-if="currentTrack.album_art" 
                             :src="currentTrack.album_art" 
                             class="w-12 h-12 rounded">
                        <div>
                            <h4 class="font-semibold">{{ currentTrack.title }}</h4>
                            <p class="text-sm text-gray-600">{{ currentTrack.artist }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <audio ref="audioPlayer" 
                               :src="currentTrack.audio_url || currentTrack.preview_url" 
                               @ended="$emit('track-ended')"
                               autoplay
                               controls
                               class="h-8">
                        </audio>
                        
                        <button @click="$emit('track-ended')" 
                                class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `,
        props: ['currentTrack']
    });
    
    // é€šçŸ¥ç»„ä»¶
    app.component('notification-component', {
        template: `
            <div class="fixed top-20 right-4 z-50 space-y-2">
                <transition-group name="fade">
                    <div v-for="notification in notifications" 
                         :key="notification.id"
                         :class="getNotificationClass(notification.type)"
                         class="rounded-lg shadow-lg min-w-80 max-w-96 relative overflow-hidden">
                        
                        <!-- é€šçŸ¥å†…å®¹ -->
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center">
                                    <i :class="getTypeIcon(notification.type)" class="mr-2"></i>
                                    <span class="font-medium text-sm">{{ getTypeText(notification.type) }}</span>
                                </div>
                                <button @click="$emit('dismiss', notification.id)" 
                                        class="text-white text-opacity-70 hover:text-opacity-100 transition-opacity">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-sm whitespace-pre-line">{{ notification.message }}</div>
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="h-1 bg-black bg-opacity-30">
                            <div class="h-full bg-white bg-opacity-80 transition-all duration-100 ease-linear"
                                 :style="{ width: getProgressWidth(notification.id) + '%' }">
                            </div>
                        </div>
                    </div>
                </transition-group>
            </div>
        `,
        props: ['notifications'],
        data() {
            return {
                activeTimers: new Map(), // å­˜å‚¨æ´»åŠ¨çš„å®šæ—¶å™¨
                progressTimers: new Map(), // å­˜å‚¨è¿›åº¦æ¡å®šæ—¶å™¨
                progressValues: new Map() // å­˜å‚¨è¿›åº¦å€¼
            }
        },
        watch: {
            notifications: {
                handler(newNotifications, oldNotifications) {
                    // æ£€æŸ¥æ–°å¢çš„é€šçŸ¥
                    const oldIds = (oldNotifications || []).map(n => n.id);
                    const newItems = newNotifications.filter(n => !oldIds.includes(n.id));
                    
                    // ä¸ºæ¯ä¸ªæ–°é€šçŸ¥è®¾ç½®è‡ªåŠ¨å…³é—­
                    newItems.forEach(notification => {
                        // å¦‚æœå·²ç»æœ‰å®šæ—¶å™¨ï¼Œå…ˆæ¸…é™¤
                        if (this.activeTimers.has(notification.id)) {
                            clearTimeout(this.activeTimers.get(notification.id));
                        }
                        
                        // è·å–è‡ªåŠ¨å…³é—­æ—¶é—´
                        let autoCloseTime = notification.duration || 5000; // é»˜è®¤5ç§’
                        
                        // æ ¹æ®ç±»å‹è®¾ç½®é»˜è®¤æ—¶é—´
                        if (!notification.duration) {
                            switch (notification.type) {
                                case 'success':
                                    autoCloseTime = 2500; // æˆåŠŸæ¶ˆæ¯2.5ç§’
                                    break;
                                case 'error':
                                    autoCloseTime = 6000; // é”™è¯¯æ¶ˆæ¯6ç§’
                                    break;
                                case 'warning':
                                    autoCloseTime = 4000; // è­¦å‘Šæ¶ˆæ¯4ç§’
                                    break;
                                case 'info':
                                    autoCloseTime = 8000; // ä¿¡æ¯æ¶ˆæ¯8ç§’
                                    break;
                                default:
                                    autoCloseTime = 3000;
                            }
                        }
                        
                        // è®¾ç½®ä¸»å®šæ—¶å™¨
                        const timer = setTimeout(() => {
                            this.$emit('dismiss', notification.id);
                            this.activeTimers.delete(notification.id);
                            this.progressTimers.delete(notification.id);
                            this.progressValues.delete(notification.id);
                        }, autoCloseTime);
                        
                        this.activeTimers.set(notification.id, timer);
                        
                        // è®¾ç½®è¿›åº¦æ¡åŠ¨ç”»
                        this.progressValues.set(notification.id, 100);
                        const progressInterval = setInterval(() => {
                            const elapsed = Date.now() - notification.createdAt;
                            const progress = Math.max(0, 100 - (elapsed / autoCloseTime) * 100);
                            this.progressValues.set(notification.id, progress);
                            
                            if (progress <= 0) {
                                clearInterval(progressInterval);
                                this.progressTimers.delete(notification.id);
                            }
                        }, 50);
                        
                        this.progressTimers.set(notification.id, progressInterval);
                    });
                    
                    // æ¸…ç†å·²åˆ é™¤é€šçŸ¥çš„å®šæ—¶å™¨
                    const currentIds = newNotifications.map(n => n.id);
                    this.activeTimers.forEach((timer, id) => {
                        if (!currentIds.includes(id)) {
                            clearTimeout(timer);
                            this.activeTimers.delete(id);
                        }
                    });
                    
                    this.progressTimers.forEach((timer, id) => {
                        if (!currentIds.includes(id)) {
                            clearInterval(timer);
                            this.progressTimers.delete(id);
                            this.progressValues.delete(id);
                        }
                    });
                },
                deep: true
            }
        },
        beforeUnmount() {
            // ç»„ä»¶é”€æ¯å‰æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
            this.activeTimers.forEach(timer => clearTimeout(timer));
            this.activeTimers.clear();
            
            this.progressTimers.forEach(timer => clearInterval(timer));
            this.progressTimers.clear();
            this.progressValues.clear();
        },
        methods: {
            getNotificationClass(type) {
                const classes = {
                    'success': 'bg-green-600 text-white',
                    'error': 'bg-red-600 text-white',
                    'warning': 'bg-yellow-600 text-white',
                    'info': 'bg-blue-600 text-white'
                };
                return classes[type] || classes.info;
            },
            
            getTypeIcon(type) {
                const icons = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle'
                };
                return icons[type] || icons.info;
            },
            
            getTypeText(type) {
                const texts = {
                    'success': 'æˆåŠŸ',
                    'error': 'é”™è¯¯',
                    'warning': 'è­¦å‘Š',
                    'info': 'ä¿¡æ¯'
                };
                return texts[type] || texts.info;
            },
            
            getProgressWidth(notificationId) {
                return this.progressValues.get(notificationId) || 100;
            }
        }
    });

    // æŒ‚è½½åº”ç”¨
    app.mount('#app');
    </script>
</body>
</html>