<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Downloader - Èü≥‰πê‰∏ãËΩΩÂô®</title>
    <!-- ÈÖçÁΩÆÊñá‰ª∂ -->
    <script src="/js/config/env.js?v=20250620"></script>
    <!-- Â§ñÈÉ®‰æùËµñ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Â∑•ÂÖ∑ÂíåÊúçÂä° -->
    <script src="/js/utils/constants.js?v=20250620"></script>
    <script src="/js/utils/helpers.js?v=20250620"></script>
    <script src="/js/services/api.js?v=20250620"></script>
    <!-- ‰∏ªÂ∫îÁî®ÂàùÂßãÂåñ -->
    <script src="/js/main.js?v=20250620"></script>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Ëá™ÂÆö‰πâÊ†∑Âºè -->
    <link rel="stylesheet" href="/css/main.css?v=20250620">
    <style>
        /* Ëá™ÂÆö‰πâÊ†∑Âºè */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        
        /* Âπ≥ÊªëÁöÑÊï∞ÊçÆÊõ¥Êñ∞ */
        .download-task-item {
            transition: all 0.3s ease;
        }
        
        /* Èò≤Ê≠¢Èó™ÁÉÅÁöÑÈÄöÁî®Ê†∑Âºè */
        .no-flash {
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Èü≥‰πêÊí≠ÊîæËøõÂ∫¶Êù° */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Âç°ÁâáÊÇ¨ÂÅúÊïàÊûú */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- ÂØºËà™Ê†è -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-music text-blue-600 mr-2"></i>
                            Music Downloader
                        </h1>
                    </div>
                    
                    <!-- ÂØºËà™ËèúÂçï -->
                    <div class="flex items-center space-x-6">
                        <button @click="activeTab = 'search'" 
                                :class="activeTab === 'search' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition">
                            <i class="fas fa-search mr-1"></i>ÊêúÁ¥¢
                        </button>
                        <button @click="activeTab = 'library'" 
                                :class="activeTab === 'library' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-bookmark mr-1"></i>Êî∂ËóèÂ∫ì
                            <span v-if="libraryStats?.total_songs > 0" 
                                  class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ libraryStats.total_songs }}
                            </span>
                        </button>
                        <button @click="activeTab = 'playlists'" 
                                :class="activeTab === 'playlists' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition">
                            <i class="fas fa-list-music mr-1"></i>Ê≠åÂçï
                        </button>
                        <button @click="activeTab = 'downloads'" 
                                :class="activeTab === 'downloads' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-download mr-1"></i>‰∏ãËΩΩ
                            <span v-if="pendingDownloads > 0" 
                                  class="absolute -top-1 -right-2 bg-green-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ pendingDownloads }}
                            </span>
                        </button>
                        <button @click="showBatchProgress = !showBatchProgress" 
                                :class="showBatchProgress ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'"
                                class="px-3 py-4 hover:text-blue-600 transition relative">
                            <i class="fas fa-tasks mr-1"></i>‰ªªÂä°
                            <span v-if="activeBatchTasksCount > 0" 
                                  class="absolute -top-1 -right-2 bg-orange-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                {{ activeBatchTasksCount }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- Áî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
                    <div class="flex items-center space-x-4">
                        <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->
                        <div v-if="isAuthenticated" class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <i class="fas fa-user-circle text-blue-600"></i>
                                <span>{{ currentUser?.username }}</span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">{{ currentUser?.role }}</span>
                            </div>
                            <button @click="logout" 
                                    class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition">
                                <i class="fas fa-sign-out-alt mr-1"></i>ÁôªÂá∫
                            </button>
                        </div>
                        
                        <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
                        <div v-else class="flex items-center space-x-3">
                            <span class="text-sm text-gray-500">Ê∏∏ÂÆ¢Ê®°ÂºèÔºàÂè™ËØªÔºâ</span>
                            <a href="/login.html" 
                               class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                <i class="fas fa-sign-in-alt mr-1"></i>ÁÆ°ÁêÜÂëòÁôªÂΩï
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- ÊêúÁ¥¢ÁªÑ‰ª∂ -->
            <search-component v-if="activeTab === 'search'" 
                            @song-added-to-library="onSongAddedToLibrary"
                            @playlist-imported="onPlaylistImported">
            </search-component>

            <!-- Êî∂ËóèÂ∫ìÁªÑ‰ª∂ -->
            <library-component v-if="activeTab === 'library'"
                             @playlist-created="onPlaylistCreated"
                             @download-started="onDownloadStarted">
            </library-component>

            <!-- Ê≠åÂçïÁªÑ‰ª∂ -->
            <playlists-component v-if="activeTab === 'playlists'"
                               :playlists="playlists"
                               @playlist-updated="loadPlaylists"
                               @download-started="onDownloadStarted">
            </playlists-component>

            <!-- ‰∏ãËΩΩÁªÑ‰ª∂ -->
            <download-component v-if="activeTab === 'downloads'"
                              :download-tasks="downloadTasks"
                              @task-updated="loadDownloadTasks">
            </download-component>
        </main>

        <!-- Èü≥‰πêÊí≠ÊîæÂô®ÁªÑ‰ª∂ -->
        <music-player v-if="currentTrack" 
                     :current-track="currentTrack"
                     @track-ended="onTrackEnded">
        </music-player>

        <!-- ÈÄöÁü•ÁªÑ‰ª∂ -->
        <notification-component :notifications="notifications"
                              @dismiss="dismissNotification">
        </notification-component>
    </div>

    <!-- Vue Â∫îÁî®ËÑöÊú¨ -->
    <script>
    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                // Áî®Êà∑ËÆ§ËØÅÁä∂ÊÄÅ
                isAuthenticated: false,
                currentUser: null,
                
                // ÂΩìÂâçÊ¥ªÂä®Ê†áÁ≠æ
                activeTab: 'search',
                
                // Âä†ËΩΩÁä∂ÊÄÅ
                isLoading: false,
                
                // ÈÄöÁü•Ê∂àÊÅØ
                notifications: [],
                notificationIdCounter: 0,
                
                // Ê≠åÂçïÂàóË°®
                playlists: [],
                
                // ‰∏ãËΩΩ‰ªªÂä°
                downloadTasks: [],
                
                // ÂæÖÂ§ÑÁêÜ‰∏ãËΩΩÊï∞
                pendingDownloads: 0,
                
                // ÂΩìÂâçÊí≠ÊîæÊ≠åÊõ≤
                currentTrack: null,
                
                // Êí≠ÊîæÂàóË°®ÈòüÂàóÁÆ°ÁêÜ
                currentPlaylist: null,
                currentPlaylistIndex: -1,
                
                // Êî∂ËóèÂ∫ìÁªüËÆ°
                libraryStats: null,
                
                // ÊâπÈáè‰ªªÂä°Áä∂ÊÄÅË∑üË∏™
                batchTasks: [],
                showBatchProgress: false
            }
        },
        
        computed: {
            activeBatchTasksCount() {
                return this.batchTasks.filter(task => task.status === 'running').length;
            }
        },
        
        mounted() {
            // Ê£ÄÊü•Áî®Êà∑ËÆ§ËØÅÁä∂ÊÄÅ
            this.checkAuthStatus();
            
            // ÂàùÂßãÂåñÊï∞ÊçÆ
            this.loadPlaylists();
            this.loadDownloadTasks();
            this.loadLibraryStats();
            
            // ÁõëÂê¨Âä†ËΩΩÁä∂ÊÄÅ
            window.addEventListener('api-loading', (e) => {
                this.isLoading = e.detail;
            });
            
            // ÂÆöÊúüÂà∑Êñ∞‰∏ãËΩΩ‰ªªÂä°ÔºàÊô∫ËÉΩÊõ¥Êñ∞Ôºå‰∏çÈó™ÁÉÅÔºâ
            setInterval(() => {
                if (this.activeTab === 'downloads' || this.pendingDownloads > 0) {
                    this.updateDownloadTasksSilent();
                }
            }, 3000);
        },
        
        methods: {
            // Âä†ËΩΩÊ≠åÂçïÂàóË°®
            async loadPlaylists() {
                try {
                    const response = await api.getPlaylists();
                    this.playlists = response.data?.playlists || [];
                } catch (error) {
                    this.showError('Âä†ËΩΩÊ≠åÂçïÂ§±Ë¥•: ' + error.message);
                }
            },
            
            // Âä†ËΩΩ‰∏ãËΩΩ‰ªªÂä°
            async loadDownloadTasks() {
                try {
                    const response = await api.getDownloadTasks();
                    this.downloadTasks = response.tasks || [];
                    
                    // ËÆ°ÁÆóÂæÖÂ§ÑÁêÜ‰ªªÂä°Êï∞
                    this.pendingDownloads = this.downloadTasks.filter(
                        task => ['pending', 'downloading'].includes(task.status)
                    ).length;
                } catch (error) {
                    this.showError('Âä†ËΩΩ‰∏ãËΩΩ‰ªªÂä°Â§±Ë¥•: ' + error.message);
                }
            },
            
            // ÈùôÈªòÊõ¥Êñ∞‰∏ãËΩΩ‰ªªÂä°Ôºà‰∏çÈó™ÁÉÅÔºâ
            async updateDownloadTasksSilent() {
                try {
                    const response = await api.getDownloadTasks();
                    const newTasks = response.tasks || [];
                    
                    // Êô∫ËÉΩÊõ¥Êñ∞ÔºöÂè™Êõ¥Êñ∞ÂèòÂåñÁöÑ‰ªªÂä°
                    newTasks.forEach(newTask => {
                        const existingIndex = this.downloadTasks.findIndex(t => t.id === newTask.id);
                        if (existingIndex !== -1) {
                            // ‰ΩøÁî®Vue.setÁ°Æ‰øùÂìçÂ∫îÂºèÊõ¥Êñ∞
                            Vue.set(this.downloadTasks, existingIndex, newTask);
                        } else {
                            // Êñ∞‰ªªÂä°Ê∑ªÂä†Âà∞ÂºÄÂ§¥
                            this.downloadTasks.unshift(newTask);
                        }
                    });
                    
                    // ÁßªÈô§Â∑≤Áªè‰∏çÂ≠òÂú®ÁöÑ‰ªªÂä°
                    const newTaskIds = new Set(newTasks.map(t => t.id));
                    this.downloadTasks = this.downloadTasks.filter(t => newTaskIds.has(t.id));
                    
                    // Êõ¥Êñ∞ÂæÖÂ§ÑÁêÜ‰ªªÂä°Êï∞
                    this.pendingDownloads = this.downloadTasks.filter(
                        task => ['pending', 'downloading'].includes(task.status)
                    ).length;
                } catch (error) {
                    console.error('Êõ¥Êñ∞‰∏ãËΩΩ‰ªªÂä°Â§±Ë¥•:', error);
                }
            },
            
            // Âä†ËΩΩÊî∂ËóèÂ∫ìÁªüËÆ°
            async loadLibraryStats() {
                try {
                    const response = await api.getLibraryStats();
                    this.libraryStats = response.data || response;
                } catch (error) {
                    this.showError('Âä†ËΩΩÊî∂ËóèÂ∫ìÁªüËÆ°Â§±Ë¥•: ' + error.message);
                }
            },
            
            // Ê≠åÊõ≤Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì
            onSongAddedToLibrary() {
                this.showSuccess('Â∑≤Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì');
                this.loadLibraryStats();
            },
            
            // Ê≠åÂçïÂàõÂª∫ÊàêÂäü
            onPlaylistCreated(playlist) {
                this.showSuccess(`Ê≠åÂçï "${playlist.name}" ÂàõÂª∫ÊàêÂäü`);
                this.loadPlaylists();
                this.activeTab = 'playlists';
            },
            
            // Êí≠ÊîæÂàóË°®ÂØºÂÖ•Â§ÑÁêÜ
            onPlaylistImported(playlist) {
                this.showSuccess(`Êí≠ÊîæÂàóË°® "${playlist.name}" ÂØºÂÖ•ÊàêÂäü`);
                this.loadPlaylists();
            },
            
            // ‰∏ãËΩΩÂºÄÂßã
            onDownloadStarted(info) {
                this.showSuccess(info.message || '‰∏ãËΩΩ‰ªªÂä°Â∑≤ÂàõÂª∫');
                this.loadDownloadTasks();
                this.activeTab = 'downloads';
            },
            
            // Êõ≤ÁõÆÊí≠ÊîæÁªìÊùü
            onTrackEnded() {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊí≠ÊîæÂàóË°®Ê≠£Âú®Êí≠Êîæ
                if (this.currentPlaylist && this.currentPlaylist.length > 0 && this.currentPlaylistIndex >= 0) {
                    // Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñÊ≠å
                    this.currentPlaylistIndex++;
                    
                    if (this.currentPlaylistIndex < this.currentPlaylist.length) {
                        // ËøòÊúâ‰∏ã‰∏ÄÈ¶ñÊ≠åÔºåÁªßÁª≠Êí≠Êîæ
                        const nextSong = this.currentPlaylist[this.currentPlaylistIndex];
                        const mode = nextSong.playMode || 'preview';
                        
                        // ‰ΩøÁî®Áõ∏ÂêåÁöÑÊí≠ÊîæÈÄªËæë
                        let audioUrl = null;
                        let trackTitle = nextSong.title;
                        
                        if (mode === 'downloaded' && nextSong.is_downloaded && nextSong.file_url) {
                            audioUrl = nextSong.file_url;
                            trackTitle += ' (‰∏ãËΩΩÁâàÊú¨)';
                        } else if (nextSong.preview_url) {
                            audioUrl = nextSong.preview_url;
                            trackTitle += ' (ËØïÂê¨ÁâàÊú¨)';
                        }
                        
                        if (audioUrl) {
                            this.currentTrack = {
                                id: nextSong.spotify_id,
                                title: trackTitle,
                                artist: nextSong.artist,
                                album: nextSong.album,
                                album_art: nextSong.album_art_url,
                                audio_url: audioUrl,
                                preview_url: nextSong.preview_url,
                                duration: nextSong.duration,
                                mode: mode
                            };
                        } else {
                            // ÂΩìÂâçÊ≠åÊõ≤Êó†Ê≥ïÊí≠ÊîæÔºåË∑≥Âà∞‰∏ã‰∏ÄÈ¶ñ
                            this.onTrackEnded();
                        }
                    } else {
                        // Êí≠ÊîæÂàóË°®ÁªìÊùü
                        this.currentTrack = null;
                        this.currentPlaylist = null;
                        this.currentPlaylistIndex = -1;
                        this.showSuccess('Êí≠ÊîæÂàóË°®Êí≠ÊîæÂÆåÊàê');
                    }
                } else {
                    // ÂçïÊõ≤Êí≠ÊîæÁªìÊùü
                    this.currentTrack = null;
                }
            },
            
            // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            showSuccess(message) {
                this.notificationIdCounter++;
                
                // ÈôêÂà∂ÊúÄÂ§ßÈÄöÁü•Êï∞ÈáèÔºåÈò≤Ê≠¢Â†ÜÁßØ
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ÁßªÈô§ÊúÄÊóßÁöÑÈÄöÁü•
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'success',
                    message: message,
                    createdAt: Date.now()
                });
            },
            
            // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
            showError(message) {
                this.notificationIdCounter++;
                
                // ÈôêÂà∂ÊúÄÂ§ßÈÄöÁü•Êï∞ÈáèÔºåÈò≤Ê≠¢Â†ÜÁßØ
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ÁßªÈô§ÊúÄÊóßÁöÑÈÄöÁü•
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'error',
                    message: message,
                    createdAt: Date.now()
                });
            },
            
            // ÊòæÁ§∫API‰ø°ÊÅØ
            showApiInfo(apiUrl, playlist) {
                const message = `APIÊé•Âè£ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ

üìã **Êé•Âè£Âú∞ÂùÄ**: ${apiUrl}

üìñ **ËØ¶ÁªÜÊñáÊ°£**: ËÆøÈóÆ /docs Êü•ÁúãÂÆåÊï¥APIÊñáÊ°£Âíå‰ΩøÁî®Á§∫‰æã

üí° **Âø´ÈÄü‰ΩøÁî®**: 
- ÊîØÊåÅGETËØ∑Ê±ÇÁõ¥Êé•Ëé∑ÂèñJSONÊï∞ÊçÆ
- ÊîØÊåÅË∑®ÂüüËØ∑Ê±ÇÔºåÂèØÁõ¥Êé•Âú®LaravelÈ°πÁõÆ‰∏≠‰ΩøÁî®
- ËøîÂõûÂÆåÊï¥ÁöÑÊ≠åÊõ≤ÂÖÉÊï∞ÊçÆÔºåÂåÖÊã¨Â∞ÅÈù¢„ÄÅËØïÂê¨ÈìæÊé•„ÄÅ‰∏ãËΩΩÁä∂ÊÄÅÁ≠â`;

                // ÂàõÂª∫ÁÆÄÊ¥ÅÁöÑÈÄöÁü•
                this.notificationIdCounter++;
                
                // ÈôêÂà∂ÊúÄÂ§ßÈÄöÁü•Êï∞ÈáèÔºåÈò≤Ê≠¢Â†ÜÁßØ
                const MAX_NOTIFICATIONS = 5;
                if (this.notifications.length >= MAX_NOTIFICATIONS) {
                    // ÁßªÈô§ÊúÄÊóßÁöÑÈÄöÁü•
                    const oldestNotification = this.notifications.shift();
                    if (oldestNotification) {
                        this.dismissNotification(oldestNotification.id);
                    }
                }
                
                this.notifications.push({
                    id: `notification_${this.notificationIdCounter}_${Date.now()}`,
                    type: 'success',
                    message: message,
                    duration: 8000, // 8ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
                    createdAt: Date.now()
                });
            },
            
            // ÂÖ≥Èó≠ÈÄöÁü•
            dismissNotification(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index > -1) {
                    this.notifications.splice(index, 1);
                }
            },
            
            // ============= ËÆ§ËØÅÁõ∏ÂÖ≥ÊñπÊ≥ï =============
            
            // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            async checkAuthStatus() {
                const token = localStorage.getItem('auth_token');
                const userInfo = localStorage.getItem('user_info');
                
                if (!token) {
                    this.isAuthenticated = false;
                    this.currentUser = null;
                    return;
                }
                
                try {
                    // È™åËØÅtokenÊòØÂê¶ÊúâÊïà
                    const response = await axios.get('/api/auth/me', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    
                    this.isAuthenticated = true;
                    this.currentUser = response.data;
                    
                    // ËÆæÁΩÆaxiosÈªòËÆ§header
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    
                } catch (error) {
                    // tokenÊó†ÊïàÔºåÊ∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®
                    this.logout();
                }
            },
            
            // ÁôªÂá∫
            logout() {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
                delete axios.defaults.headers.common['Authorization'];
                this.isAuthenticated = false;
                this.currentUser = null;
                
                // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
                window.location.href = '/login.html';
            },
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅËÆ§ËØÅÁöÑÊìç‰Ωú
            requireAuth(action) {
                if (!this.isAuthenticated) {
                    this.showError('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçËøõË°åÊ≠§Êìç‰Ωú');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }
                return true;
            }
        }
    });

    // Ê≥®ÂÜåÂÖ®Â±ÄÁªÑ‰ª∂
    
    // ÊêúÁ¥¢ÁªÑ‰ª∂
    app.component('search-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6">
                    <i class="fas fa-search text-blue-600 mr-2"></i>Èü≥‰πêÊêúÁ¥¢
                </h2>
                
                <!-- ÊêúÁ¥¢Ê°Ü -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <input v-model="searchQuery" 
                               @keyup.enter="search"
                               type="text" 
                               placeholder="ÊêúÁ¥¢Ê≠åÊõ≤„ÄÅËâ∫‰∫∫„ÄÅ‰∏ìËæë„ÄÅÊ≠åÂçï..."
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button @click="search" 
                                :disabled="!searchQuery"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition">
                            <i class="fas fa-search mr-2"></i>ÊêúÁ¥¢
                        </button>
                    </div>
                    
                    <!-- ÊêúÁ¥¢Á±ªÂûãÊ†áÁ≠æ -->
                    <div class="mt-4 flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">ÊêúÁ¥¢Á±ªÂûã:</span>
                        <button v-for="type in searchTypes" :key="type.key"
                                @click="switchSearchType(type.key)"
                                :class="searchOptions.searchType === type.key ? 
                                    'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 text-sm rounded-full transition">
                            <i :class="type.icon" class="mr-1"></i>{{ type.name }}
                            <span v-if="hasSearched" class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-white bg-opacity-20">
                                {{ getResultCount(type.key) }}
                            </span>
                        </button>
                    </div>
                    
                    <!-- ÊêúÁ¥¢ÈÄâÈ°π -->
                    <div class="mt-4 space-y-3">
                        <!-- Á¨¨‰∏ÄË°åÔºöÂü∫Á°ÄÈÄâÈ°π -->
                        <div class="flex items-center space-x-4 text-sm">
                            <label v-if="searchOptions.searchType === 'track'" class="flex items-center">
                                <input v-model="searchOptions.previewOnly" type="checkbox" class="mr-2">
                                ‰ªÖÊòæÁ§∫ÂèØËØïÂê¨
                            </label>
                            <select v-model="searchOptions.regionGroup" @change="onRegionGroupChange" class="px-3 py-1 border rounded">
                                <option value="">ÊâÄÊúâÂú∞Âå∫</option>
                                <option value="asia">‰∫öÊ¥≤</option>
                                <option value="eastasia">‰∏ú‰∫ö</option>
                                <option value="japankorea">Êó•Èü©</option>
                                <option value="southeast">‰∏úÂçó‰∫ö</option>
                                <option value="southasia">Âçó‰∫ö</option>
                                <option value="europe">Ê¨ßÊ¥≤</option>
                                <option value="westerneurope">Ë•øÊ¨ß</option>
                                <option value="easterneurope">‰∏úÊ¨ß</option>
                                <option value="northamerica">ÂåóÁæé</option>
                                <option value="southamerica">ÂçóÁæé</option>
                                <option value="oceania">Â§ßÊ¥ãÊ¥≤</option>
                                <option value="middleeast">‰∏≠‰∏ú</option>
                                <option value="africa">ÈùûÊ¥≤</option>
                            </select>
                            <select v-model="searchOptions.countryFilter" class="px-3 py-1 border rounded">
                                <option value="">ÊâÄÊúâÂõΩÂÆ∂</option>
                                <option value="china">‰∏≠ÂõΩ</option>
                                <option value="korea">Èü©ÂõΩ</option>
                                <option value="japan">Êó•Êú¨</option>
                                <option value="usa">ÁæéÂõΩ</option>
                                <option value="uk">Ëã±ÂõΩ</option>
                                <option value="turkey">ÂúüËÄ≥ÂÖ∂</option>
                                <option value="taiwan">Âè∞Êπæ</option>
                                <option value="thailand">Ê≥∞ÂõΩ</option>
                                <option value="vietnam">Ë∂äÂçó</option>
                                <option value="singapore">Êñ∞Âä†Âù°</option>
                                <option value="malaysia">È©¨Êù•Ë•ø‰∫ö</option>
                                <option value="indonesia">Âç∞Â∫¶Â∞ºË•ø‰∫ö</option>
                                <option value="philippines">Ëè≤ÂæãÂÆæ</option>
                                <option value="india">Âç∞Â∫¶</option>
                                <option value="canada">Âä†ÊãøÂ§ß</option>
                                <option value="australia">Êæ≥Â§ßÂà©‰∫ö</option>
                                <option value="france">Ê≥ïÂõΩ</option>
                                <option value="germany">Âæ∑ÂõΩ</option>
                                <option value="spain">Ë•øÁè≠Áâô</option>
                                <option value="italy">ÊÑèÂ§ßÂà©</option>
                                <option value="russia">‰øÑÁΩóÊñØ</option>
                                <option value="brazil">Â∑¥Ë•ø</option>
                                <option value="mexico">Â¢®Ë•øÂì•</option>
                                <option value="argentina">ÈòøÊ†πÂª∑</option>
                            </select>
                            <select v-model="searchOptions.limit" class="px-3 py-1 border rounded">
                                <option value="10">10Êù°ÁªìÊûú</option>
                                <option value="20">20Êù°ÁªìÊûú</option>
                                <option value="50">50Êù°ÁªìÊûú</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ÊêúÁ¥¢ÁªìÊûú -->
                <div v-if="searchResults.length > 0" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold">
                            {{ getSearchTypeText() }}ÊêúÁ¥¢ÁªìÊûú ({{ searchResults.length }})
                        </h3>
                        
                        <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       :checked="selectedItems.length === searchResults.length && searchResults.length > 0"
                                       @change="toggleSelectAll"
                                       class="mr-2">
                                ÂÖ®ÈÄâ
                            </label>
                            <button v-if="selectedItems.length > 0" 
                                    @click="invertSelection" 
                                    class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition"
                                    title="ÂèçÈÄâÂΩìÂâçÈÄâÊã©">
                                <i class="fas fa-exchange-alt mr-1"></i>ÂèçÈÄâ
                            </button>
                            <span v-if="selectedItems.length > 0" class="text-sm text-gray-600">
                                Â∑≤ÈÄâÊã© {{ selectedItems.length }} È°π
                            </span>
                            
                            <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
                            <div v-if="selectedItems.length > 0" class="flex space-x-2">
                                <!-- Áªü‰∏ÄÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆ -->
                                <button @click="showLibraryImportModal" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                                        title="ÊâπÈáèÂØºÂÖ•Âà∞Êî∂ËóèÂ∫ì">
                                    <i class="fas fa-bookmark mr-1"></i>ÊâπÈáèÊî∂Ëóè
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ê≠åÊõ≤ÁªìÊûú -->
                    <div v-if="searchOptions.searchType === 'track'" v-for="track in searchResults" :key="track.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="track.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- ‰∏ìËæëÂ∞ÅÈù¢ -->
                                <img v-if="track.album_art_url" 
                                     :src="track.album_art_url" 
                                     :alt="track.album"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400 text-2xl"></i>
                                </div>
                                
                                <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
                                <div>
                                    <h4 class="font-semibold">{{ track.title }}</h4>
                                    <p class="text-sm text-gray-600">{{ track.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ track.album }} 
                                        <span v-if="track.year">({{ track.year }})</span>
                                        <span v-if="track.country" class="ml-2">
                                            <i class="fas fa-globe text-gray-400"></i> {{ track.country }}
                                        </span>
                                        <span v-if="track.preview_url" class="ml-2 text-green-600">
                                            <i class="fas fa-play-circle"></i> ÂèØËØïÂê¨
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <!-- ËØïÂê¨ÊåâÈíÆ -->
                                <button v-if="track.preview_url" 
                                        @click="playPreview(track)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-play mr-1"></i>ËØïÂê¨
                                </button>
                                
                                <!-- Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì -->
                                <button @click="addToLibrary(track)"
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-bookmark mr-1"></i>Êî∂Ëóè
                                </button>
                                
                                <!-- Áõ¥Êé•‰∏ãËΩΩ -->
                                <button @click="downloadTrack(track)"
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download mr-1"></i>‰∏ãËΩΩ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ê≠åÂçïÁªìÊûú -->
                    <div v-if="searchOptions.searchType === 'playlist'" v-for="playlist in searchResults" :key="playlist.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="playlist.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- Ê≠åÂçïÂ∞ÅÈù¢ -->
                                <img v-if="playlist.image_url" 
                                     :src="playlist.image_url" 
                                     :alt="playlist.name"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-purple-400 to-pink-400 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-list-music text-white text-2xl"></i>
                                </div>
                                
                                <!-- Ê≠åÂçï‰ø°ÊÅØ -->
                                <div>
                                    <h4 class="font-semibold">{{ playlist.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ playlist.owner }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ playlist.total_tracks }} È¶ñÊ≠åÊõ≤
                                        <span v-if="playlist.description" class="ml-2">{{ playlist.description }}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <button @click="importPlaylist(playlist)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-plus mr-1"></i>ÂØºÂÖ•Ê≠åÂçï
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‰∏ìËæëÁªìÊûú -->
                    <div v-if="searchOptions.searchType === 'album'" v-for="album in searchResults" :key="album.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="album.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- ‰∏ìËæëÂ∞ÅÈù¢ -->
                                <img v-if="album.image_url" 
                                     :src="album.image_url" 
                                     :alt="album.name"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-blue-400 to-indigo-400 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-compact-disc text-white text-2xl"></i>
                                </div>
                                
                                <!-- ‰∏ìËæë‰ø°ÊÅØ -->
                                <div>
                                    <h4 class="font-semibold">{{ album.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ album.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ album.total_tracks }} È¶ñÊ≠åÊõ≤
                                        <span v-if="album.release_date" class="ml-2">({{ album.release_date.slice(0,4) }})</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <button @click="importAlbum(album)"
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-plus mr-1"></i>ÂØºÂÖ•‰∏ìËæë
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ëâ∫‰∫∫ÁªìÊûú -->
                    <div v-if="searchOptions.searchType === 'artist'" v-for="artist in searchResults" :key="artist.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition card-hover">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="artist.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                <!-- Ëâ∫‰∫∫Â§¥ÂÉè -->
                                <img v-if="artist.image_url" 
                                     :src="artist.image_url" 
                                     :alt="artist.name"
                                     class="w-16 h-16 rounded-full object-cover">
                                <div v-else class="w-16 h-16 bg-gradient-to-br from-green-400 to-teal-400 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-music text-white text-2xl"></i>
                                </div>
                                
                                <!-- Ëâ∫‰∫∫‰ø°ÊÅØ -->
                                <div>
                                    <h4 class="font-semibold">{{ artist.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ formatFollowers(artist.followers) }} ÂÖ≥Ê≥®ËÄÖ</p>
                                    <p class="text-xs text-gray-500">
                                        ÊµÅË°åÂ∫¶: {{ artist.popularity }}/100
                                        <span v-if="artist.genres && artist.genres.length" class="ml-2">
                                            {{ artist.genres.slice(0,2).join(', ') }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <button @click="searchArtistTracks(artist)"
                                        class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                    <i class="fas fa-music mr-1"></i>Êü•ÁúãÁÉ≠Èó®Ê≠åÊõ≤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Êó†ÁªìÊûúÊèêÁ§∫ -->
                <div v-else-if="hasSearched" class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p>Êú™ÊâæÂà∞Áõ∏ÂÖ≥Èü≥‰πê</p>
                </div>
                
                <!-- Êî∂ËóèÂ∫ìÂØºÂÖ•Ê®°ÊÄÅÊ°Ü -->
                <div v-if="importToLibraryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">ÊâπÈáèÊ∑ªÂä†Âà∞Êî∂ËóèÂ∫ì</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÁ±ª</label>
                                <input v-model="libraryImportSettings.category" 
                                       type="text" 
                                       placeholder="Â¶ÇÔºöK-POP, ÊµÅË°åÈü≥‰πêÁ≠â"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂõΩÂÆ∂</label>
                                <select v-model="libraryImportSettings.country" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">ÈÄâÊã©ÂõΩÂÆ∂</option>
                                    <option value="china">‰∏≠ÂõΩ</option>
                                    <option value="korea">Èü©ÂõΩ</option>
                                    <option value="japan">Êó•Êú¨</option>
                                    <option value="usa">ÁæéÂõΩ</option>
                                    <option value="uk">Ëã±ÂõΩ</option>
                                    <option value="turkey">ÂúüËÄ≥ÂÖ∂</option>
                                    <option value="taiwan">Âè∞Êπæ</option>
                                    <option value="thailand">Ê≥∞ÂõΩ</option>
                                    <option value="vietnam">Ë∂äÂçó</option>
                                    <option value="singapore">Êñ∞Âä†Âù°</option>
                                    <option value="malaysia">È©¨Êù•Ë•ø‰∫ö</option>
                                    <option value="indonesia">Âç∞Â∫¶Â∞ºË•ø‰∫ö</option>
                                    <option value="philippines">Ëè≤ÂæãÂÆæ</option>
                                    <option value="india">Âç∞Â∫¶</option>
                                    <option value="canada">Âä†ÊãøÂ§ß</option>
                                    <option value="australia">Êæ≥Â§ßÂà©‰∫ö</option>
                                    <option value="france">Ê≥ïÂõΩ</option>
                                    <option value="germany">Âæ∑ÂõΩ</option>
                                    <option value="spain">Ë•øÁè≠Áâô</option>
                                    <option value="italy">ÊÑèÂ§ßÂà©</option>
                                    <option value="russia">‰øÑÁΩóÊñØ</option>
                                    <option value="brazil">Â∑¥Ë•ø</option>
                                    <option value="mexico">Â¢®Ë•øÂì•</option>
                                    <option value="argentina">ÈòøÊ†πÂª∑</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ËØ≠Ë®Ä</label>
                                <select v-model="libraryImportSettings.language" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">ÈÄâÊã©ËØ≠Ë®Ä</option>
                                    <option value="chinese">‰∏≠Êñá</option>
                                    <option value="korean">Èü©ËØ≠</option>
                                    <option value="japanese">Êó•ËØ≠</option>
                                    <option value="english">Ëã±ËØ≠</option>
                                    <option value="turkish">ÂúüËÄ≥ÂÖ∂ËØ≠</option>
                                    <option value="french">Ê≥ïËØ≠</option>
                                    <option value="german">Âæ∑ËØ≠</option>
                                    <option value="spanish">Ë•øÁè≠ÁâôËØ≠</option>
                                    <option value="italian">ÊÑèÂ§ßÂà©ËØ≠</option>
                                    <option value="russian">‰øÑËØ≠</option>
                                    <option value="portuguese">Ëë°ËêÑÁâôËØ≠</option>
                                    <option value="arabic">ÈòøÊãâ‰ºØËØ≠</option>
                                    <option value="hindi">Âç∞Âú∞ËØ≠</option>
                                    <option value="thai">Ê≥∞ËØ≠</option>
                                    <option value="vietnamese">Ë∂äÂçóËØ≠</option>
                                    <option value="malay">È©¨Êù•ËØ≠</option>
                                    <option value="indonesian">Âç∞Â∞ºËØ≠</option>
                                    <option value="filipino">Ëè≤ÂæãÂÆæËØ≠</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ê†áÁ≠æ</label>
                                <input v-model="libraryImportSettings.tags" 
                                       type="text" 
                                       placeholder="Áî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶ÇÔºöËàûÊõ≤,ËäÇÂ•èÊÑüÂº∫"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â§áÊ≥®</label>
                                <textarea v-model="libraryImportSettings.notes" 
                                          placeholder="Ê∑ªÂä†Â§áÊ≥®‰ø°ÊÅØ"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <!-- ‰øùÂ≠ò‰∏∫ÈªòËÆ§ËÆæÁΩÆÈÄâÈ°π -->
                            <div class="border-t pt-4">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           v-model="libraryImportSettings.saveAsDefault"
                                           class="mr-2">
                                    <span class="text-sm text-gray-700">‰øùÂ≠ò‰∏∫ÈªòËÆ§ËÆæÁΩÆÔºà‰∏ãÊ¨°Âø´ÈÄüÊî∂ËóèÊó∂‰ΩøÁî®Ôºâ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <!-- ÂΩìÂâçÈªòËÆ§ËÆæÁΩÆÊèêÁ§∫ -->
                            <div class="text-xs text-gray-500">
                                <p>ÈªòËÆ§ËÆæÁΩÆÔºö</p>
                                <p>{{ defaultImportSettings.category || 'Êó†ÂàÜÁ±ª' }} | {{ countryMap[defaultImportSettings.country] || defaultImportSettings.country || 'Êó†ÂõΩÂÆ∂' }} | {{ languageMap[defaultImportSettings.language] || defaultImportSettings.language || 'Êó†ËØ≠Ë®Ä' }}</p>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button @click="importToLibraryModal = false" 
                                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                    ÂèñÊ∂à
                                </button>
                                <button @click="quickBatchImport" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                                        title="‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆÂø´ÈÄüÂØºÂÖ•">
                                    <i class="fas fa-flash mr-1"></i>Âø´ÈÄüÊî∂Ëóè
                                </button>
                                <button @click="confirmLibraryImport" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    Á°ÆËÆ§Ê∑ªÂä† ({{ selectedItems.length }} È°π)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ê≠åÂçïÂØºÂÖ•ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
                <div v-if="playlistImportModal.show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">Ê≠åÂçïÂØºÂÖ•ËÆæÁΩÆ</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ê≠åÂçïÂêçÁß∞</label>
                                <p class="text-gray-600">{{ playlistImportModal.playlist?.name }}</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÁ±ª</label>
                                <input v-model="playlistImportModal.settings.category" 
                                       type="text" 
                                       placeholder="Â¶ÇÔºöÈü©ÂõΩÊ≠åÂçï, ÂúüËÄ≥ÂÖ∂Èü≥‰πêÁ≠â"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ëá™ÂÆö‰πâÂõΩÂÆ∂/Âú∞Âå∫</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <select v-model="playlistImportModal.settings.customCountry" 
                                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">ÈÄâÊã©ÂõΩÂÆ∂</option>
                                        <option value="china">‰∏≠ÂõΩ</option>
                                        <option value="korea">Èü©ÂõΩ</option>
                                        <option value="japan">Êó•Êú¨</option>
                                        <option value="usa">ÁæéÂõΩ</option>
                                        <option value="uk">Ëã±ÂõΩ</option>
                                        <option value="turkey">ÂúüËÄ≥ÂÖ∂</option>
                                        <option value="taiwan">Âè∞Êπæ</option>
                                        <option value="thailand">Ê≥∞ÂõΩ</option>
                                        <option value="vietnam">Ë∂äÂçó</option>
                                        <option value="singapore">Êñ∞Âä†Âù°</option>
                                        <option value="malaysia">È©¨Êù•Ë•ø‰∫ö</option>
                                        <option value="indonesia">Âç∞Â∫¶Â∞ºË•ø‰∫ö</option>
                                        <option value="philippines">Ëè≤ÂæãÂÆæ</option>
                                        <option value="india">Âç∞Â∫¶</option>
                                        <option value="canada">Âä†ÊãøÂ§ß</option>
                                        <option value="australia">Êæ≥Â§ßÂà©‰∫ö</option>
                                        <option value="france">Ê≥ïÂõΩ</option>
                                        <option value="germany">Âæ∑ÂõΩ</option>
                                        <option value="spain">Ë•øÁè≠Áâô</option>
                                        <option value="italy">ÊÑèÂ§ßÂà©</option>
                                        <option value="russia">‰øÑÁΩóÊñØ</option>
                                        <option value="brazil">Â∑¥Ë•ø</option>
                                        <option value="mexico">Â¢®Ë•øÂì•</option>
                                        <option value="argentina">ÈòøÊ†πÂª∑</option>
                                    </select>
                                    
                                    <input v-model="playlistImportModal.settings.customRegion" 
                                           type="text" 
                                           placeholder="Ëá™ÂÆö‰πâÂú∞Âå∫"
                                           class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Ëá™ÂÆö‰πâÂú∞Âå∫‰ø°ÊÅØÔºå‰∏éÊ≠åÊõ≤ÂéüÊúâÂõΩÂÆ∂‰ø°ÊÅØÂàÜÂºÄÂ≠òÂÇ®</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ëá™ÂÆö‰πâËØ≠Ë®Ä</label>
                                <select v-model="playlistImportModal.settings.customLanguage" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">ÈÄâÊã©ËØ≠Ë®Ä</option>
                                    <option value="chinese">‰∏≠Êñá</option>
                                    <option value="korean">Èü©ËØ≠</option>
                                    <option value="japanese">Êó•ËØ≠</option>
                                    <option value="english">Ëã±ËØ≠</option>
                                    <option value="turkish">ÂúüËÄ≥ÂÖ∂ËØ≠</option>
                                    <option value="french">Ê≥ïËØ≠</option>
                                    <option value="german">Âæ∑ËØ≠</option>
                                    <option value="spanish">Ë•øÁè≠ÁâôËØ≠</option>
                                    <option value="italian">ÊÑèÂ§ßÂà©ËØ≠</option>
                                    <option value="russian">‰øÑËØ≠</option>
                                    <option value="portuguese">Ëë°ËêÑÁâôËØ≠</option>
                                    <option value="arabic">ÈòøÊãâ‰ºØËØ≠</option>
                                    <option value="hindi">Âç∞Âú∞ËØ≠</option>
                                    <option value="thai">Ê≥∞ËØ≠</option>
                                    <option value="vietnamese">Ë∂äÂçóËØ≠</option>
                                    <option value="malay">È©¨Êù•ËØ≠</option>
                                    <option value="indonesian">Âç∞Â∞ºËØ≠</option>
                                    <option value="filipino">Ëè≤ÂæãÂÆæËØ≠</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Ëá™ÂÆö‰πâËØ≠Ë®Ä‰ø°ÊÅØÔºå‰∏éÊ≠åÊõ≤Ëá™Âä®Ê£ÄÊµãÁöÑËØ≠Ë®ÄÂàÜÂºÄÂ≠òÂÇ®</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ê†áÁ≠æ</label>
                                <input v-model="playlistImportModal.settings.tags" 
                                       type="text" 
                                       placeholder="Áî®ÈÄóÂè∑ÂàÜÈöîÔºåÂ¶ÇÔºöÊµÅË°å,ËàûÊõ≤,2024"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â§áÊ≥®</label>
                                <textarea v-model="playlistImportModal.settings.notes" 
                                          placeholder="Ê∑ªÂä†Â§áÊ≥®‰ø°ÊÅØ"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-6">
                            <button @click="playlistImportModal.show = false" 
                                    class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                ÂèñÊ∂à
                            </button>
                            <button @click="confirmPlaylistImport" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                Á°ÆËÆ§ÂØºÂÖ•Âà∞Êî∂ËóèÂ∫ì
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊâπÈáè‰ªªÂä°ËøõÂ∫¶Á™óÂè£ -->
                <div v-if="$root.showBatchProgress" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg border p-4 w-80 z-50">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-800">ÊâπÈáè‰ªªÂä°ËøõÂ∫¶</h4>
                        <button @click="closeBatchProgress" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3 max-h-60 overflow-y-auto">
                        <div v-for="task in $root.batchTasks" :key="task.id" class="border rounded p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">
                                    {{ task.type === 'library_import' ? 'ÊâπÈáèÊî∂Ëóè' : 'ÊâπÈáè‰ªªÂä°' }}
                                </span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs px-2 py-1 rounded" 
                                          :class="{
                                            'bg-blue-100 text-blue-800': task.status === 'running',
                                            'bg-green-100 text-green-800': task.status === 'completed',
                                            'bg-red-100 text-red-800': task.status === 'failed',
                                            'bg-gray-100 text-gray-800': task.status === 'cancelled'
                                          }">
                                        {{ getTaskStatusText(task.status) }}
                                    </span>
                                    <button v-if="task.status === 'running'" 
                                            @click="cancelBatchTask(task.id)"
                                            class="text-xs text-red-600 hover:text-red-800">
                                        ÂèñÊ∂à
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ËøõÂ∫¶Êù° -->
                            <div class="mb-2">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>{{ task.completed }} / {{ task.total }}</span>
                                    <span>{{ getTaskProgress(task) }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                         :style="{ width: getTaskProgress(task) + '%' }"></div>
                                </div>
                            </div>
                            
                            <!-- ‰ªªÂä°ËØ¶ÊÉÖ -->
                            <div class="text-xs text-gray-500">
                                <p v-if="task.failed > 0" class="text-red-600">
                                    Â§±Ë¥•: {{ task.failed }} È°π
                                    <button v-if="task.failedItems && task.failedItems.length > 0" 
                                            @click="task.showFailureDetails = !task.showFailureDetails"
                                            class="ml-1 text-blue-600 hover:text-blue-800">
                                        {{ task.showFailureDetails ? 'ÈöêËóè' : 'Êü•Áúã' }}ËØ¶ÊÉÖ
                                    </button>
                                </p>
                                <!-- Â§±Ë¥•ËØ¶ÊÉÖ -->
                                <div v-if="task.showFailureDetails && task.failedItems" 
                                     class="mt-2 p-2 bg-red-50 rounded text-xs max-h-20 overflow-y-auto">
                                    <div v-for="item in task.failedItems" :key="item.item_id" class="mb-1">
                                        <strong>{{ item.item_id }}:</strong> {{ item.error }}
                                    </div>
                                </div>
                                <p>ÂºÄÂßãÊó∂Èó¥: {{ task.startTime.toLocaleTimeString() }}</p>
                                <p v-if="task.endTime">ÁªìÊùüÊó∂Èó¥: {{ task.endTime.toLocaleTimeString() }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        data() {
            return {
                searchQuery: '',
                allSearchResults: {
                    tracks: [],
                    playlists: [],
                    albums: [],
                    artists: []
                },
                hasSearched: false,
                searchOptions: {
                    searchType: 'track',
                    previewOnly: false,
                    regionGroup: '',
                    countryFilter: '',
                    limit: 20
                },
                searchTypes: [
                    { key: 'track', name: 'Ê≠åÊõ≤', icon: 'fas fa-music' },
                    { key: 'playlist', name: 'Ê≠åÂçï', icon: 'fas fa-list-music' },
                    { key: 'album', name: '‰∏ìËæë', icon: 'fas fa-compact-disc' },
                    { key: 'artist', name: 'Ê≠åÊâã', icon: 'fas fa-user-music' }
                ],
                selectedItems: [],
                showBatchActions: false,
                importToLibraryModal: false,
                libraryImportSettings: {
                    category: '',
                    country: '',
                    language: '',
                    tags: '',
                    notes: '',
                    // ‰øùÂ≠òÈªòËÆ§ËÆæÁΩÆ
                    saveAsDefault: false
                },
                // ÈªòËÆ§ÊâπÈáèÂØºÂÖ•ËÆæÁΩÆ
                defaultImportSettings: {
                    category: 'SpotifyÂØºÂÖ•',
                    country: 'korea',
                    language: 'korean',
                    tags: 'ÊâπÈáèÂØºÂÖ•',
                    notes: ''
                },
                // Ê≠åÂçïÂØºÂÖ•ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
                playlistImportModal: {
                    show: false,
                    playlist: null,
                    settings: {
                        category: '',
                        customCountry: '',
                        customRegion: '',
                        customLanguage: '',
                        tags: '',
                        notes: ''
                    }
                },
                // Âú∞Âå∫ÂàÜÁªÑÊò†Â∞Ñ
                regionGroupMapping: {
                    'asia': ['‰∏≠ÂõΩ', 'Èü©ÂõΩ', 'Êó•Êú¨', 'Âè∞Êπæ', 'Ê≥∞ÂõΩ', 'Ë∂äÂçó', 'Êñ∞Âä†Âù°', 'È©¨Êù•Ë•ø‰∫ö', 'Âç∞Â∫¶Â∞ºË•ø‰∫ö', 'Ëè≤ÂæãÂÆæ', 'Âç∞Â∫¶'],
                    'eastasia': ['‰∏≠ÂõΩ', 'Èü©ÂõΩ', 'Êó•Êú¨', 'Âè∞Êπæ'],
                    'japankorea': ['Èü©ÂõΩ', 'Êó•Êú¨'],
                    'southeast': ['Ê≥∞ÂõΩ', 'Ë∂äÂçó', 'Êñ∞Âä†Âù°', 'È©¨Êù•Ë•ø‰∫ö', 'Âç∞Â∫¶Â∞ºË•ø‰∫ö', 'Ëè≤ÂæãÂÆæ'],
                    'southasia': ['Âç∞Â∫¶'],
                    'europe': ['Ëã±ÂõΩ', 'Ê≥ïÂõΩ', 'Âæ∑ÂõΩ', 'Ë•øÁè≠Áâô', 'ÊÑèÂ§ßÂà©', '‰øÑÁΩóÊñØ'],
                    'westerneurope': ['Ëã±ÂõΩ', 'Ê≥ïÂõΩ', 'Âæ∑ÂõΩ', 'Ë•øÁè≠Áâô', 'ÊÑèÂ§ßÂà©'],
                    'easterneurope': ['‰øÑÁΩóÊñØ'],
                    'northamerica': ['ÁæéÂõΩ', 'Âä†ÊãøÂ§ß'],
                    'southamerica': ['Â∑¥Ë•ø', 'Â¢®Ë•øÂì•', 'ÈòøÊ†πÂª∑'],
                    'oceania': ['Êæ≥Â§ßÂà©‰∫ö'],
                    'middleeast': ['ÂúüËÄ≥ÂÖ∂'],
                    'africa': []
                },
                // ÂõΩÂÆ∂Ëã±ÊñáÂà∞‰∏≠ÊñáÊò†Â∞Ñ
                countryMap: {
                    'china': '‰∏≠ÂõΩ',
                    'korea': 'Èü©ÂõΩ',
                    'japan': 'Êó•Êú¨',
                    'usa': 'ÁæéÂõΩ',
                    'uk': 'Ëã±ÂõΩ',
                    'turkey': 'ÂúüËÄ≥ÂÖ∂',
                    'taiwan': 'Âè∞Êπæ',
                    'thailand': 'Ê≥∞ÂõΩ',
                    'vietnam': 'Ë∂äÂçó',
                    'singapore': 'Êñ∞Âä†Âù°',
                    'malaysia': 'È©¨Êù•Ë•ø‰∫ö',
                    'indonesia': 'Âç∞Â∫¶Â∞ºË•ø‰∫ö',
                    'philippines': 'Ëè≤ÂæãÂÆæ',
                    'india': 'Âç∞Â∫¶',
                    'canada': 'Âä†ÊãøÂ§ß',
                    'australia': 'Êæ≥Â§ßÂà©‰∫ö',
                    'france': 'Ê≥ïÂõΩ',
                    'germany': 'Âæ∑ÂõΩ',
                    'spain': 'Ë•øÁè≠Áâô',
                    'italy': 'ÊÑèÂ§ßÂà©',
                    'russia': '‰øÑÁΩóÊñØ',
                    'brazil': 'Â∑¥Ë•ø',
                    'mexico': 'Â¢®Ë•øÂì•',
                    'argentina': 'ÈòøÊ†πÂª∑'
                },
                // ËØ≠Ë®ÄËã±ÊñáÂà∞‰∏≠ÊñáÊò†Â∞Ñ
                languageMap: {
                    'chinese': '‰∏≠Êñá',
                    'korean': 'Èü©ËØ≠',
                    'japanese': 'Êó•ËØ≠',
                    'english': 'Ëã±ËØ≠',
                    'turkish': 'ÂúüËÄ≥ÂÖ∂ËØ≠',
                    'french': 'Ê≥ïËØ≠',
                    'german': 'Âæ∑ËØ≠',
                    'spanish': 'Ë•øÁè≠ÁâôËØ≠',
                    'italian': 'ÊÑèÂ§ßÂà©ËØ≠',
                    'russian': '‰øÑËØ≠',
                    'portuguese': 'Ëë°ËêÑÁâôËØ≠',
                    'arabic': 'ÈòøÊãâ‰ºØËØ≠',
                    'hindi': 'Âç∞Âú∞ËØ≠',
                    'thai': 'Ê≥∞ËØ≠',
                    'vietnamese': 'Ë∂äÂçóËØ≠',
                    'malay': 'È©¨Êù•ËØ≠',
                    'indonesian': 'Âç∞Â∞ºËØ≠',
                    'filipino': 'Ëè≤ÂæãÂÆæËØ≠'
                }
            }
        },
        computed: {
            searchResults() {
                // Ê†πÊçÆÂΩìÂâçÈÄâÊã©ÁöÑÁ±ªÂûãËøîÂõûÂØπÂ∫îÁöÑÁªìÊûú
                const typeMap = {
                    'track': 'tracks',
                    'playlist': 'playlists', 
                    'album': 'albums',
                    'artist': 'artists'
                };
                return this.allSearchResults[typeMap[this.searchOptions.searchType]] || [];
            }
        },
        methods: {
            async search() {
                if (!this.searchQuery.trim()) return;
                
                // Ê∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©
                this.selectedItems = [];
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Spotify URL
                if (this.isSpotifyUrl(this.searchQuery.trim())) {
                    await this.handleSpotifyUrl();
                } else {
                    // ÊôÆÈÄöÊêúÁ¥¢
                    await this.searchCurrentType();
                }
            },
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Spotify URL
            isSpotifyUrl(query) {
                return query.includes('spotify.com/') || query.includes('spotify:');
            },
            
            // Â§ÑÁêÜSpotify URL
            async handleSpotifyUrl() {
                try {
                    this.$root.showSuccess('Ê£ÄÊµãÂà∞SpotifyÈìæÊé•ÔºåÊ≠£Âú®Ëß£Êûê...');
                    
                    const parseResponse = await api.parseSpotifyUrl(this.searchQuery.trim());
                    
                    if (parseResponse.type === 'playlist') {
                        // ÂàáÊç¢Âà∞Ê≠åÂçïÊ®°ÂºèÂπ∂ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
                        this.searchOptions.searchType = 'playlist';
                        this.allSearchResults.playlists = [{
                            id: parseResponse.tracks[0]?.id || 'parsed',
                            name: parseResponse.name,
                            description: parseResponse.description,
                            total_tracks: parseResponse.total_tracks,
                            spotify_url: this.searchQuery.trim(),
                            owner: 'Spotify',
                            is_public: true,
                            tracks: parseResponse.tracks  // ‰øùÂ≠òËß£ÊûêÁöÑÊ≠åÊõ≤ÂàóË°®
                        }];
                        this.hasSearched = true;
                        this.$root.showSuccess(`ÊàêÂäüËß£ÊûêÊ≠åÂçï "${parseResponse.name}"ÔºåÂåÖÂê´ ${parseResponse.total_tracks} È¶ñÊ≠åÊõ≤`);
                        
                    } else if (parseResponse.type === 'album') {
                        // ÂàáÊç¢Âà∞‰∏ìËæëÊ®°ÂºèÂπ∂ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
                        this.searchOptions.searchType = 'album';
                        this.allSearchResults.albums = [{
                            id: parseResponse.tracks[0]?.id || 'parsed',
                            name: parseResponse.name,
                            artist: parseResponse.artist,
                            total_tracks: parseResponse.total_tracks,
                            spotify_url: this.searchQuery.trim(),
                            tracks: parseResponse.tracks  // ‰øùÂ≠òËß£ÊûêÁöÑÊ≠åÊõ≤ÂàóË°®
                        }];
                        this.hasSearched = true;
                        this.$root.showSuccess(`ÊàêÂäüËß£Êûê‰∏ìËæë "${parseResponse.name}"ÔºåÂåÖÂê´ ${parseResponse.total_tracks} È¶ñÊ≠åÊõ≤`);
                        
                    } else if (parseResponse.type === 'track') {
                        // ÂàáÊç¢Âà∞Ê≠åÊõ≤Ê®°ÂºèÂπ∂ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
                        this.searchOptions.searchType = 'track';
                        this.allSearchResults.tracks = [parseResponse.data];
                        this.hasSearched = true;
                        this.$root.showSuccess(`ÊàêÂäüËß£ÊûêÊ≠åÊõ≤ "${parseResponse.data.title}"`);
                    }
                    
                } catch (error) {
                    this.$root.showError('Ëß£ÊûêSpotifyÈìæÊé•Â§±Ë¥•: ' + error.message);
                    // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåÂõûÂà∞ÊôÆÈÄöÊêúÁ¥¢
                    await this.searchCurrentType();
                }
            },
            
            async searchCurrentType() {
                if (!this.searchQuery.trim()) return;
                
                try {
                    const currentType = this.searchOptions.searchType;
                    
                    if (currentType === 'track') {
                        // ÊêúÁ¥¢Ê≠åÊõ≤
                        const response = await api.searchMusic(this.searchQuery, this.searchOptions);
                        this.allSearchResults.tracks = response.data?.tracks || response.tracks || [];
                    } else {
                        // ÊêúÁ¥¢ÂÖ∂‰ªñÁ±ªÂûã
                        const response = await api.searchMultiType(this.searchQuery, [currentType], this.searchOptions.limit);
                        
                        // Ê≠£Á°ÆÂ§ÑÁêÜÂìçÂ∫îÊï∞ÊçÆ
                        if (currentType === 'playlist') {
                            this.allSearchResults.playlists = response.playlists || [];
                        } else if (currentType === 'album') {
                            this.allSearchResults.albums = response.albums || [];
                        } else if (currentType === 'artist') {
                            this.allSearchResults.artists = response.artists || [];
                        }
                    }
                    
                    this.hasSearched = true;
                    console.log(`ÊêúÁ¥¢${currentType}ÂÆåÊàêÔºåÁªìÊûúÊï∞Èáè:`, this.searchResults.length);
                    
                } catch (error) {
                    console.error('ÊêúÁ¥¢ÈîôËØØ:', error);
                    this.$root.showError('ÊêúÁ¥¢Â§±Ë¥•: ' + error.message);
                }
            },
            
            getSearchTypeText() {
                const type = this.searchTypes.find(t => t.key === this.searchOptions.searchType);
                return type ? type.name : '';
            },
            
            async switchSearchType(typeKey) {
                this.searchOptions.searchType = typeKey;
                this.selectedItems = []; // ÂàáÊç¢Á±ªÂûãÊó∂Ê∏ÖÁ©∫ÈÄâÊã©
                
                // Â¶ÇÊûúÂ∑≤ÁªèÊêúÁ¥¢ËøáÔºåËá™Âä®Ëé∑ÂèñÊñ∞Á±ªÂûãÁöÑÁªìÊûú
                if (this.hasSearched && this.searchQuery.trim()) {
                    await this.searchCurrentType();
                }
            },
            
            getResultCount(typeKey) {
                const typeMap = {
                    'track': 'tracks',
                    'playlist': 'playlists',
                    'album': 'albums', 
                    'artist': 'artists'
                };
                return this.allSearchResults[typeMap[typeKey]]?.length || 0;
            },
            
            async addToLibrary(track) {
                try {
                    await api.addToLibrary(track.id, {
                        category: 'ÊêúÁ¥¢Êî∂Ëóè',
                        country: track.country,
                        language: track.language,
                        tags: `ÊêúÁ¥¢,${track.artist || ''},${track.album || ''}`,
                        notes: `Êù•Ëá™ÊêúÁ¥¢ÁªìÊûú: ${track.title} - ${track.artist}`
                    });
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`"${track.title}" Â∑≤Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì`);
                } catch (error) {
                    this.$root.showError('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
                }
            },
            
            async downloadTrack(track) {
                try {
                    const response = await api.downloadSingle(track.id);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            playPreview(track) {
                this.$root.currentTrack = track;
            },
            
            async importPlaylist(playlist) {
                // ÊòæÁ§∫Ëá™ÂÆö‰πâÂØºÂÖ•ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
                this.playlistImportModal = {
                    show: true,
                    playlist: playlist,
                    settings: {
                        category: `SpotifyÊ≠åÂçï`,
                        customCountry: 'korea',  // ÈªòËÆ§Èü©ÂõΩ
                        customRegion: '',
                        tags: `Ê≠åÂçï,${playlist.name},${playlist.owner || ''}`,
                        notes: `Êù•Ëá™SpotifyÊ≠åÂçï: ${playlist.name}`
                    }
                };
            },
            
            async confirmPlaylistImport() {
                try {
                    const playlist = this.playlistImportModal.playlist;
                    const settings = this.playlistImportModal.settings;
                    
                    let tracks = [];
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâËß£ÊûêÁöÑÊ≠åÊõ≤ÂàóË°®ÔºàÊù•Ëá™URLËß£ÊûêÔºâ
                    if (playlist.tracks && playlist.tracks.length > 0) {
                        tracks = playlist.tracks;
                    } else {
                        // Ëß£ÊûêSpotifyÊ≠åÂçïËé∑ÂèñÊ≠åÊõ≤ÂàóË°®
                        const playlistUrl = playlist.spotify_url || `https://open.spotify.com/playlist/${playlist.id}`;
                        const parseResponse = await api.parseSpotifyUrl(playlistUrl);
                        
                        if (!parseResponse.tracks || parseResponse.tracks.length === 0) {
                            this.$root.showError('Ê≠åÂçï‰∏≠Ê≤°ÊúâÂèØÂØºÂÖ•ÁöÑÊ≠åÊõ≤');
                            return;
                        }
                        tracks = parseResponse.tracks;
                    }
                    
                    // Áõ¥Êé•Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ìÔºà‰ΩøÁî®Ëá™ÂÆö‰πâËÆæÁΩÆÔºâ
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const track of tracks) {
                        try {
                            await api.addToLibrary(track.id, {
                                category: settings.category,
                                tags: settings.tags,
                                notes: settings.notes,
                                custom_country: this.countryMap[settings.customCountry] || settings.customCountry,
                                custom_region: settings.customRegion,
                                custom_language: this.languageMap[settings.customLanguage] || settings.customLanguage
                            });
                            successCount++;
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    
                    this.playlistImportModal.show = false;
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`Ê≠åÂçï "${playlist.name}" Â∑≤ÂØºÂÖ•Êî∂ËóèÂ∫ìÔºåÊàêÂäü ${successCount} È¶ñ${errorCount > 0 ? `ÔºåÂ§±Ë¥• ${errorCount} È¶ñ` : ''}`);
                    
                } catch (error) {
                    this.$root.showError('ÂØºÂÖ•Ê≠åÂçïÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async importAlbum(album) {
                try {
                    // ÁÆÄÂåñÂØºÂÖ•ÔºöÁõ¥Êé•Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì
                    await api.addToLibrary(album.id, {
                        category: `‰∏ìËæë`,
                        tags: `‰∏ìËæë,${album.artist || ''},${album.total_tracks || 0}È¶ñ`,
                        notes: `Êù•Ëá™Spotify‰∏ìËæë: ${album.name} (${album.release_date?.slice(0,4) || ''})`
                    });
                    this.$emit('song-added-to-library');
                    this.$root.showSuccess(`‰∏ìËæë "${album.name}" Â∑≤Ê∑ªÂä†Âà∞Êî∂ËóèÂ∫ì`);
                } catch (error) {
                    this.$root.showError('ÂØºÂÖ•‰∏ìËæëÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async searchArtistTracks(artist) {
                try {
                    // ÊêúÁ¥¢Ëâ∫‰∫∫ÁöÑÁÉ≠Èó®Ê≠åÊõ≤
                    this.searchQuery = artist.name;
                    this.searchOptions.searchType = 'track';
                    await this.search();
                    this.$root.showSuccess(`Ê≠£Âú®ÊòæÁ§∫ ${artist.name} ÁöÑÁÉ≠Èó®Ê≠åÊõ≤`);
                } catch (error) {
                    this.$root.showError('Ëé∑ÂèñËâ∫‰∫∫Ê≠åÊõ≤Â§±Ë¥•: ' + error.message);
                }
            },
            
            formatFollowers(count) {
                if (!count) return '0';
                if (count > 1000000) {
                    return (count / 1000000).toFixed(1) + 'M';
                } else if (count > 1000) {
                    return (count / 1000).toFixed(1) + 'K';
                }
                return count.toString();
            },
            
            // ÊâπÈáèÊìç‰ΩúÊñπÊ≥ï
            toggleSelectAll() {
                if (this.selectedItems.length === this.searchResults.length) {
                    this.selectedItems = [];
                } else {
                    this.selectedItems = this.searchResults.map(item => item.id);
                }
            },
            
            // ÂèçÈÄâ
            invertSelection() {
                const allIds = this.searchResults.map(item => item.id);
                const currentSelected = new Set(this.selectedItems);
                this.selectedItems = allIds.filter(id => !currentSelected.has(id));
            },
            
            // Âú∞Âå∫ÂàÜÁªÑÂèòÊõ¥Â§ÑÁêÜ
            onRegionGroupChange() {
                if (this.searchOptions.regionGroup) {
                    // ÈÄâÊã©Âú∞Âå∫ÂàÜÁªÑÊó∂Ê∏ÖÁ©∫Âçï‰∏™ÂõΩÂÆ∂ÈÄâÊã©
                    this.searchOptions.countryFilter = '';
                }
            },
            
            showLibraryImportModal() {
                this.importToLibraryModal = true;
            },
            
            // Âø´ÈÄüÊâπÈáèÊìç‰ΩúÔºà‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆÔºâ
            async quickBatchImport() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // ‰øùÂ≠òÈÄâ‰∏≠È°πÁõÆÂâØÊú¨
                    const selectedItemIds = [...this.selectedItems];
                    
                    // ËΩ¨Êç¢ÈªòËÆ§ËÆæÁΩÆ‰∏≠ÁöÑÂõΩÂÆ∂ÂíåËØ≠Ë®ÄÂÄº‰∏∫‰∏≠Êñá
                    const convertedSettings = {
                        ...this.defaultImportSettings,
                        country: this.countryMap[this.defaultImportSettings.country] || this.defaultImportSettings.country,
                        language: this.languageMap[this.defaultImportSettings.language] || this.defaultImportSettings.language
                    };
                    
                    // Ë∞ÉÁî®ÂêéÁ´ØAPIÂêØÂä®ÊâπÈáè‰ªªÂä°
                    const response = await api.startBatchImport({
                        items: selectedItemIds,
                        search_type: this.searchOptions.searchType,
                        settings: convertedSettings
                    });
                    
                    // ÂàõÂª∫Êú¨Âú∞‰ªªÂä°Ë∑üË∏™
                    const taskId = this.createBatchTask('library_import', selectedItemIds.length, response.task_id);
                    
                    // ÂºÄÂßãËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
                    this.pollTaskStatus(response.task_id);
                    
                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    this.importToLibraryModal = false;
                    
                    // Ê∏ÖÁ©∫ÈÄâÊã©
                    const selectedCount = selectedItemIds.length;
                    this.selectedItems = [];
                    
                    this.$root.showSuccess(`Â∑≤ÂêØÂä®ÊâπÈáèÂØºÂÖ•‰ªªÂä°ÔºåÂÖ± ${selectedCount} È°π„ÄÇÂèØÂú®‰ªªÂä°Ê†èÊü•ÁúãËøõÂ∫¶„ÄÇ`);
                    
                } catch (error) {
                    this.$root.showError('ÂêØÂä®ÊâπÈáè‰ªªÂä°Â§±Ë¥•: ' + error.message);
                }
            },
            
            // Ëá™ÂÆö‰πâÊâπÈáèÊìç‰ΩúÔºàÂèØÈÖçÁΩÆËÆæÁΩÆÔºâ
            async confirmLibraryImport() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // ‰øùÂ≠òÈÄâ‰∏≠È°πÁõÆÂâØÊú¨
                    const selectedItemIds = [...this.selectedItems];
                    
                    // ‰øùÂ≠ò‰∏∫ÈªòËÆ§ËÆæÁΩÆ
                    if (this.libraryImportSettings.saveAsDefault) {
                        this.defaultImportSettings = { ...this.libraryImportSettings };
                        delete this.defaultImportSettings.saveAsDefault;
                        localStorage.setItem('defaultImportSettings', JSON.stringify(this.defaultImportSettings));
                    }
                    
                    // ËΩ¨Êç¢ÂõΩÂÆ∂ÂíåËØ≠Ë®ÄÂÄº‰∏∫‰∏≠Êñá
                    const convertedSettings = {
                        ...this.libraryImportSettings,
                        country: this.countryMap[this.libraryImportSettings.country] || this.libraryImportSettings.country,
                        language: this.languageMap[this.libraryImportSettings.language] || this.libraryImportSettings.language
                    };
                    
                    // Ë∞ÉÁî®ÂêéÁ´ØAPIÂêØÂä®ÊâπÈáè‰ªªÂä°
                    const response = await api.startBatchImport({
                        items: selectedItemIds,
                        search_type: this.searchOptions.searchType,
                        settings: convertedSettings
                    });
                    
                    // ÂàõÂª∫Êú¨Âú∞‰ªªÂä°Ë∑üË∏™
                    const taskId = this.createBatchTask('library_import', selectedItemIds.length, response.task_id);
                    
                    // ÂºÄÂßãËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
                    this.pollTaskStatus(response.task_id);
                    
                    this.importToLibraryModal = false;
                    const selectedCount = selectedItemIds.length;
                    this.selectedItems = [];
                    
                    this.$root.showSuccess(`Â∑≤ÂêØÂä®ÊâπÈáèÂØºÂÖ•‰ªªÂä°ÔºåÂÖ± ${selectedCount} È°π„ÄÇÂèØÂú®‰ªªÂä°Ê†èÊü•ÁúãËøõÂ∫¶„ÄÇ`);
                    
                } catch (error) {
                    this.$root.showError('ÂêØÂä®ÊâπÈáè‰ªªÂä°Â§±Ë¥•: ' + error.message);
                }
            },
            
            // ÂàõÂª∫ÊâπÈáè‰ªªÂä°
            createBatchTask(type, total, celeryTaskId = null) {
                const taskId = celeryTaskId || Date.now().toString();
                const task = {
                    id: taskId,
                    celeryTaskId: celeryTaskId,
                    type: type,
                    total: total,
                    completed: 0,
                    failed: 0,
                    failedItems: [],
                    showFailureDetails: false,
                    status: 'running',
                    startTime: new Date(),
                    endTime: null
                };
                
                this.$root.batchTasks.push(task);
                this.$root.showBatchProgress = true;
                
                return taskId;
            },
            
            // ËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
            async pollTaskStatus(celeryTaskId) {
                const pollInterval = setInterval(async () => {
                    try {
                        const status = await api.getTaskStatus(celeryTaskId);
                        const task = this.$root.batchTasks.find(t => t.celeryTaskId === celeryTaskId);
                        
                        if (task) {
                            task.status = status.status;
                            
                            if (status.progress) {
                                task.completed = status.progress.completed || 0;
                                task.failed = status.progress.failed || 0;
                                task.total = status.progress.total || task.total;
                            }
                            
                            if (status.result) {
                                task.completed = status.result.completed || 0;
                                task.failed = status.result.failed || 0;
                                task.failedItems = status.result.failed_items || [];
                            }
                            
                            // ‰ªªÂä°ÂÆåÊàêÊàñÂ§±Ë¥•Êó∂ÂÅúÊ≠¢ËΩÆËØ¢
                            if (status.status === 'success' || status.status === 'failure') {
                                clearInterval(pollInterval);
                                task.endTime = new Date();
                                
                                if (status.status === 'success') {
                                    let message = `ÊâπÈáè‰ªªÂä°ÂÆåÊàêÔºÅÊàêÂäü ${task.completed} È°π`;
                                    if (task.failed > 0) {
                                        message += `ÔºåÂ§±Ë¥• ${task.failed} È°π`;
                                        if (task.failedItems && task.failedItems.length > 0) {
                                            const failureReasons = task.failedItems.map(item => 
                                                `${item.item_id}: ${item.error}`
                                            ).join('\n');
                                            console.log('Â§±Ë¥•ËØ¶ÊÉÖ:', failureReasons);
                                        }
                                    }
                                    this.$root.showSuccess(message);
                                    this.$emit('song-added-to-library');
                                } else {
                                    this.$root.showError(`ÊâπÈáè‰ªªÂä°Â§±Ë¥•: ${status.error || 'Êú™Áü•ÈîôËØØ'}`);
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.error('ËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        // ÁªßÁª≠ËΩÆËØ¢Ôºå‰∏ç‰∏≠Êñ≠
                    }
                }, 2000); // ÊØè2ÁßíËΩÆËØ¢‰∏ÄÊ¨°
                
                // 5ÂàÜÈíüÂêéÂÅúÊ≠¢ËΩÆËØ¢
                setTimeout(() => {
                    clearInterval(pollInterval);
                }, 300000);
            },
            
            // ÂÖ≥Èó≠ÊâπÈáè‰ªªÂä°ËøõÂ∫¶Á™óÂè£
            closeBatchProgress() {
                this.$root.showBatchProgress = false;
            },
            
            // ÂèñÊ∂àÊ≠£Âú®ËøêË°åÁöÑ‰ªªÂä°
            cancelBatchTask(taskId) {
                const task = this.$root.batchTasks.find(t => t.id === taskId);
                if (task && task.status === 'running') {
                    task.status = 'cancelled';
                    task.endTime = new Date();
                }
            },
            
            // Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅÊñáÊú¨
            getTaskStatusText(status) {
                const statusMap = {
                    'running': 'ËøõË°å‰∏≠',
                    'completed': 'Â∑≤ÂÆåÊàê',
                    'failed': 'Â∑≤Â§±Ë¥•', 
                    'cancelled': 'Â∑≤ÂèñÊ∂à'
                };
                return statusMap[status] || status;
            },
            
            // Ëé∑Âèñ‰ªªÂä°ËøõÂ∫¶ÁôæÂàÜÊØî
            getTaskProgress(task) {
                if (task.total === 0) return 0;
                return Math.round(((task.completed + task.failed) / task.total) * 100);
            },
            
            async batchImportToPlaylist() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const itemId of this.selectedItems) {
                        const item = this.searchResults.find(r => r.id === itemId);
                        if (!item) continue;
                        
                        try {
                            if (this.searchOptions.searchType === 'playlist') {
                                await this.importPlaylist(item);
                            } else if (this.searchOptions.searchType === 'album') {
                                await this.importAlbum(item);
                            }
                            successCount++;
                        } catch (error) {
                            errorCount++;
                        }
                    }
                    
                    this.selectedItems = [];
                    
                    if (successCount > 0) {
                        this.$root.showSuccess(`ÊàêÂäüÂØºÂÖ• ${successCount} ‰∏™${this.getSearchTypeText()}${errorCount > 0 ? `Ôºå${errorCount} ‰∏™Â§±Ë¥•` : ''}`);
                    }
                    
                } catch (error) {
                    this.$root.showError('ÊâπÈáèÂØºÂÖ•Â§±Ë¥•: ' + error.message);
                }
            }
        },
        mounted() {
            // ‰ªélocalStorageÂä†ËΩΩÈªòËÆ§ËÆæÁΩÆ
            const savedSettings = localStorage.getItem('defaultImportSettings');
            if (savedSettings) {
                try {
                    this.defaultImportSettings = { ...JSON.parse(savedSettings) };
                } catch (error) {
                    console.log('Âä†ËΩΩÈªòËÆ§ËÆæÁΩÆÂ§±Ë¥•:', error);
                }
            }
        }
    });
    
    // Êî∂ËóèÂ∫ìÁªÑ‰ª∂
    app.component('library-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-bookmark text-blue-600 mr-2"></i>Èü≥‰πêÊî∂ËóèÂ∫ì
                    </h2>
                    
                    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                    <div v-if="stats" class="text-sm text-gray-600">
                        ÂÖ± {{ stats.total_songs }} È¶ñ | 
                        Â∑≤‰∏ãËΩΩ {{ stats.downloaded_songs }} È¶ñ |
                        ÂèØËØïÂê¨ {{ stats.preview_available }} È¶ñ
                    </div>
                </div>
                
                <!-- Á≠õÈÄâÂô® -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-3">Á≠õÈÄâÊù°‰ª∂</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <select v-model="filters.regionGroup" @change="onRegionGroupChange" class="px-3 py-2 border rounded">
                            <option value="">ÊâÄÊúâÂú∞Âå∫</option>
                            <option value="asia">‰∫öÊ¥≤</option>
                            <option value="eastasia">‰∏ú‰∫ö</option>
                            <option value="japankorea">Êó•Èü©</option>
                            <option value="southeast">‰∏úÂçó‰∫ö</option>
                            <option value="southasia">Âçó‰∫ö</option>
                            <option value="europe">Ê¨ßÊ¥≤</option>
                            <option value="westerneurope">Ë•øÊ¨ß</option>
                            <option value="easterneurope">‰∏úÊ¨ß</option>
                            <option value="northamerica">ÂåóÁæé</option>
                            <option value="southamerica">ÂçóÁæé</option>
                            <option value="oceania">Â§ßÊ¥ãÊ¥≤</option>
                            <option value="middleeast">‰∏≠‰∏ú</option>
                            <option value="africa">ÈùûÊ¥≤</option>
                        </select>
                        
                        <select v-model="filters.country" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">ÊâÄÊúâÂõΩÂÆ∂</option>
                            <option value="‰∏≠ÂõΩ">‰∏≠ÂõΩ</option>
                            <option value="Èü©ÂõΩ">Èü©ÂõΩ</option>
                            <option value="Êó•Êú¨">Êó•Êú¨</option>
                            <option value="ÁæéÂõΩ">ÁæéÂõΩ</option>
                            <option value="Ëã±ÂõΩ">Ëã±ÂõΩ</option>
                            <option value="ÂúüËÄ≥ÂÖ∂">ÂúüËÄ≥ÂÖ∂</option>
                            <option value="Âè∞Êπæ">Âè∞Êπæ</option>
                            <option value="Ê≥∞ÂõΩ">Ê≥∞ÂõΩ</option>
                            <option value="Ë∂äÂçó">Ë∂äÂçó</option>
                            <option value="Êñ∞Âä†Âù°">Êñ∞Âä†Âù°</option>
                            <option value="È©¨Êù•Ë•ø‰∫ö">È©¨Êù•Ë•ø‰∫ö</option>
                            <option value="Âç∞Â∫¶Â∞ºË•ø‰∫ö">Âç∞Â∫¶Â∞ºË•ø‰∫ö</option>
                            <option value="Ëè≤ÂæãÂÆæ">Ëè≤ÂæãÂÆæ</option>
                            <option value="Âç∞Â∫¶">Âç∞Â∫¶</option>
                            <option value="Âä†ÊãøÂ§ß">Âä†ÊãøÂ§ß</option>
                            <option value="Êæ≥Â§ßÂà©‰∫ö">Êæ≥Â§ßÂà©‰∫ö</option>
                            <option value="Ê≥ïÂõΩ">Ê≥ïÂõΩ</option>
                            <option value="Âæ∑ÂõΩ">Âæ∑ÂõΩ</option>
                            <option value="Ë•øÁè≠Áâô">Ë•øÁè≠Áâô</option>
                            <option value="ÊÑèÂ§ßÂà©">ÊÑèÂ§ßÂà©</option>
                            <option value="‰øÑÁΩóÊñØ">‰øÑÁΩóÊñØ</option>
                            <option value="Â∑¥Ë•ø">Â∑¥Ë•ø</option>
                            <option value="Â¢®Ë•øÂì•">Â¢®Ë•øÂì•</option>
                            <option value="ÈòøÊ†πÂª∑">ÈòøÊ†πÂª∑</option>
                        </select>
                        
                        <select v-model="filters.language" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">ÊâÄÊúâËØ≠Ë®Ä</option>
                            <option value="‰∏≠Êñá">‰∏≠Êñá</option>
                            <option value="Èü©ËØ≠">Èü©ËØ≠</option>
                            <option value="Êó•ËØ≠">Êó•ËØ≠</option>
                            <option value="Ëã±ËØ≠">Ëã±ËØ≠</option>
                            <option value="ÂúüËÄ≥ÂÖ∂ËØ≠">ÂúüËÄ≥ÂÖ∂ËØ≠</option>
                            <option value="Ê≥ïËØ≠">Ê≥ïËØ≠</option>
                            <option value="Âæ∑ËØ≠">Âæ∑ËØ≠</option>
                            <option value="Ë•øÁè≠ÁâôËØ≠">Ë•øÁè≠ÁâôËØ≠</option>
                            <option value="ÊÑèÂ§ßÂà©ËØ≠">ÊÑèÂ§ßÂà©ËØ≠</option>
                            <option value="‰øÑËØ≠">‰øÑËØ≠</option>
                            <option value="Ëë°ËêÑÁâôËØ≠">Ëë°ËêÑÁâôËØ≠</option>
                            <option value="ÈòøÊãâ‰ºØËØ≠">ÈòøÊãâ‰ºØËØ≠</option>
                            <option value="Âç∞Âú∞ËØ≠">Âç∞Âú∞ËØ≠</option>
                            <option value="Ê≥∞ËØ≠">Ê≥∞ËØ≠</option>
                            <option value="Ë∂äÂçóËØ≠">Ë∂äÂçóËØ≠</option>
                            <option value="È©¨Êù•ËØ≠">È©¨Êù•ËØ≠</option>
                            <option value="Âç∞Â∞ºËØ≠">Âç∞Â∞ºËØ≠</option>
                            <option value="Ëè≤ÂæãÂÆæËØ≠">Ëè≤ÂæãÂÆæËØ≠</option>
                        </select>
                        
                        <select v-model="filters.has_preview" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">ËØïÂê¨Áä∂ÊÄÅ</option>
                            <option value="true">ÂèØËØïÂê¨</option>
                            <option value="false">‰∏çÂèØËØïÂê¨</option>
                        </select>
                        
                        <select v-model="filters.is_downloaded" @change="loadLibrary" class="px-3 py-2 border rounded">
                            <option value="">‰∏ãËΩΩÁä∂ÊÄÅ</option>
                            <option value="true">Â∑≤‰∏ãËΩΩ</option>
                            <option value="false">Êú™‰∏ãËΩΩ</option>
                        </select>
                    </div>
                </div>
                
                <!-- ÂÖ®ÈÄâÂíåÊâπÈáèÊìç‰Ωú -->
                <div class="mb-4 space-y-3">
                    <!-- ÈÄâÊã©ÁªüËÆ°ÂíåÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700">
                                ÂΩìÂâçÈ°µÔºö{{ libraryItems.length }} È¶ñ | 
                                ÊÄªËÆ°Ôºö{{ totalItems }} È¶ñ
                                <span v-if="selectedItems.length > 0" class="text-blue-700">
                                    | Â∑≤ÈÄâÊã©Ôºö{{ selectedItems.length }} È¶ñ
                                </span>
                            </span>
                        </div>
                        
                        <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
                        <div v-if="selectedItems.length > 0" class="flex space-x-2">
                            <button @click="batchDownload" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                <i class="fas fa-download mr-2"></i>ÊâπÈáè‰∏ãËΩΩ
                            </button>
                            <button @click="showCreatePlaylistModal" 
                                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
                                <i class="fas fa-list-music mr-2"></i>Ê∑ªÂä†Âà∞Ê≠åÂçï
                            </button>
                            <button @click="clearSelection" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                                ÂèñÊ∂àÈÄâÊã©
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÂÖ®ÈÄâÈÄâÈ°π -->
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   :checked="selectedItems.length === libraryItems.length && libraryItems.length > 0"
                                   @change="toggleSelectCurrentPage"
                                   class="mr-2">
                            ÂÖ®ÈÄâÂΩìÂâçÈ°µ ({{ libraryItems.length }} È¶ñ)
                        </label>
                        
                        <button @click="selectAllResults" 
                                :disabled="isSelectingAll"
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400 transition">
                            <i class="fas fa-check-double mr-1"></i>
                            {{ isSelectingAll ? 'Ê≠£Âú®Âä†ËΩΩ...' : 'ÂÖ®ÈÄâÊâÄÊúâÁªìÊûú (' + totalItems + ' È¶ñ)' }}
                        </button>
                        
                        <button v-if="selectedItems.length > 0" 
                                @click="invertSelection" 
                                class="px-3 py-1 text-sm bg-orange-500 text-white rounded hover:bg-orange-600 transition"
                                title="ÂèçÈÄâÂΩìÂâçÈÄâÊã©">
                            <i class="fas fa-exchange-alt mr-1"></i>ÂèçÈÄâ
                        </button>
                        
                        <button v-if="selectedItems.length > 0" 
                                @click="clearSelection" 
                                class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-1"></i>Ê∏ÖÁ©∫ÈÄâÊã©
                        </button>
                    </div>
                </div>
                
                <!-- Êî∂ËóèÂàóË°® -->
                <div v-if="libraryItems.length > 0" class="space-y-4">
                    <div v-for="item in libraryItems" :key="item.id" 
                         class="border rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="item.id" 
                                       v-model="selectedItems"
                                       class="w-4 h-4 text-blue-600">
                                
                                <!-- ‰∏ìËæëÂ∞ÅÈù¢ -->
                                <img v-if="item.song.album_art" 
                                     :src="item.song.album_art" 
                                     :alt="item.song.album"
                                     class="w-16 h-16 rounded-lg object-cover">
                                <div v-else class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400 text-2xl"></i>
                                </div>
                                
                                <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
                                <div>
                                    <h4 class="font-semibold">
                                        {{ item.song.title }}
                                        <span v-if="item.is_downloaded" class="ml-2 text-green-600">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                    </h4>
                                    <p class="text-sm text-gray-600">{{ item.song.artist }}</p>
                                    <p class="text-xs text-gray-500">
                                        {{ item.song.album }} 
                                        <span v-if="item.song.year">({{ item.song.year }})</span>
                                        <span v-if="item.song.country" class="ml-2">
                                            <i class="fas fa-globe text-gray-400"></i> {{ item.song.country }}
                                        </span>
                                        <span v-if="item.category" class="ml-2">
                                            <i class="fas fa-folder text-gray-400"></i> {{ item.category }}
                                        </span>
                                    </p>
                                    <p v-if="item.tags" class="text-xs text-gray-400 mt-1">
                                        <i class="fas fa-tags mr-1"></i>{{ item.tags }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <button v-if="item.song.preview_url" 
                                        @click="playPreview(item.song)"
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                                    <i class="fas fa-play"></i>
                                </button>
                                
                                <button v-if="!item.is_downloaded" 
                                        @click="downloadItem(item)"
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download"></i>
                                </button>
                                
                                <button @click="removeFromLibrary(item.id)"
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Á©∫Áä∂ÊÄÅ -->
                <div v-else class="text-center py-12 text-gray-500">
                    <i class="fas fa-bookmark text-6xl mb-4"></i>
                    <p class="text-lg">Êî∂ËóèÂ∫ìÊòØÁ©∫ÁöÑ</p>
                    <p class="text-sm mt-2">‰ªéÊêúÁ¥¢ÁªìÊûú‰∏≠Ê∑ªÂä†Ê≠åÊõ≤Âà∞Êî∂ËóèÂ∫ì</p>
                </div>
                
                <!-- ÂàÜÈ°µ -->
                <div v-if="totalPages > 1" class="mt-6 flex justify-center space-x-2">
                    <button v-for="page in totalPages" :key="page"
                            @click="currentPage = page; loadLibrary()"
                            :class="currentPage === page ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded hover:opacity-80 transition">
                        {{ page }}
                    </button>
                </div>
                
                <!-- ÂàõÂª∫/Ê∑ªÂä†Âà∞Ê≠åÂçïÊ®°ÊÄÅÊ°Ü -->
                <div v-if="showPlaylistModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                        <h3 class="text-lg font-semibold mb-4">Ê∑ªÂä†Âà∞Ê≠åÂçï</h3>
                        
                        <div class="space-y-4">
                            <!-- ÈÄâÊã©Áé∞ÊúâÊ≠åÂçï -->
                            <div v-if="availablePlaylists.length > 0">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©Áé∞ÊúâÊ≠åÂçï</label>
                                <select v-model="selectedPlaylistId" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">-- ÈÄâÊã©Ê≠åÂçï --</option>
                                    <option v-for="playlist in availablePlaylists" :key="playlist.id" :value="playlist.id">
                                        {{ playlist.name }} ({{ playlist.song_count }} È¶ñ)
                                    </option>
                                </select>
                            </div>
                            
                            <!-- ÂàÜÈöîÁ∫ø -->
                            <div v-if="availablePlaylists.length > 0" class="flex items-center">
                                <div class="flex-1 border-t border-gray-300"></div>
                                <span class="px-3 text-sm text-gray-500">ÊàñËÄÖ</span>
                                <div class="flex-1 border-t border-gray-300"></div>
                            </div>
                            
                            <!-- ÂàõÂª∫Êñ∞Ê≠åÂçï -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ÂàõÂª∫Êñ∞Ê≠åÂçï</label>
                                <input v-model="newPlaylistName" 
                                       type="text" 
                                       placeholder="ËæìÂÖ•Êñ∞Ê≠åÂçïÂêçÁß∞"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ê≠åÂçïÊèèËø∞ÔºàÂèØÈÄâÔºâ</label>
                                <textarea v-model="newPlaylistDescription" 
                                          placeholder="ËæìÂÖ•Ê≠åÂçïÊèèËø∞"
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <span class="text-sm text-gray-500">Â∞ÜÊ∑ªÂä† {{ selectedItems.length }} È¶ñÊ≠åÊõ≤</span>
                            <div class="flex space-x-3">
                                <button @click="hidePlaylistModal" 
                                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                                    ÂèñÊ∂à
                                </button>
                                <button @click="confirmAddToPlaylist" 
                                        :disabled="!selectedPlaylistId && !newPlaylistName"
                                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition">
                                    Á°ÆËÆ§Ê∑ªÂä†
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        data() {
            return {
                libraryItems: [],
                selectedItems: [],
                allSelectedSongs: [], // Â≠òÂÇ®ÂÖ®ÈÄâÊó∂ÁöÑÊâÄÊúâÊ≠åÊõ≤Êï∞ÊçÆ
                stats: null,
                currentPage: 1,
                perPage: 20,
                totalItems: 0,
                filters: {
                    regionGroup: '',
                    country: '',
                    language: '',
                    has_preview: '',
                    is_downloaded: ''
                },
                // Âú∞Âå∫ÂàÜÁªÑÊò†Â∞Ñ
                regionGroupMapping: {
                    'asia': ['‰∏≠ÂõΩ', 'Èü©ÂõΩ', 'Êó•Êú¨', 'Âè∞Êπæ', 'Ê≥∞ÂõΩ', 'Ë∂äÂçó', 'Êñ∞Âä†Âù°', 'È©¨Êù•Ë•ø‰∫ö', 'Âç∞Â∫¶Â∞ºË•ø‰∫ö', 'Ëè≤ÂæãÂÆæ', 'Âç∞Â∫¶'],
                    'eastasia': ['‰∏≠ÂõΩ', 'Èü©ÂõΩ', 'Êó•Êú¨', 'Âè∞Êπæ'],
                    'japankorea': ['Èü©ÂõΩ', 'Êó•Êú¨'],
                    'southeast': ['Ê≥∞ÂõΩ', 'Ë∂äÂçó', 'Êñ∞Âä†Âù°', 'È©¨Êù•Ë•ø‰∫ö', 'Âç∞Â∫¶Â∞ºË•ø‰∫ö', 'Ëè≤ÂæãÂÆæ'],
                    'southasia': ['Âç∞Â∫¶'],
                    'europe': ['Ëã±ÂõΩ', 'Ê≥ïÂõΩ', 'Âæ∑ÂõΩ', 'Ë•øÁè≠Áâô', 'ÊÑèÂ§ßÂà©', '‰øÑÁΩóÊñØ'],
                    'westerneurope': ['Ëã±ÂõΩ', 'Ê≥ïÂõΩ', 'Âæ∑ÂõΩ', 'Ë•øÁè≠Áâô', 'ÊÑèÂ§ßÂà©'],
                    'easterneurope': ['‰øÑÁΩóÊñØ'],
                    'northamerica': ['ÁæéÂõΩ', 'Âä†ÊãøÂ§ß'],
                    'southamerica': ['Â∑¥Ë•ø', 'Â¢®Ë•øÂì•', 'ÈòøÊ†πÂª∑'],
                    'oceania': ['Êæ≥Â§ßÂà©‰∫ö'],
                    'middleeast': ['ÂúüËÄ≥ÂÖ∂'],
                    'africa': []
                },
                // Ê≠åÂçïÁõ∏ÂÖ≥
                showPlaylistModal: false,
                availablePlaylists: [],
                selectedPlaylistId: '',
                newPlaylistName: '',
                newPlaylistDescription: '',
                
                // ÂÖ®ÈÄâÁõ∏ÂÖ≥
                isSelectingAll: false
            }
        },
        computed: {
            totalPages() {
                return Math.ceil(this.totalItems / this.perPage);
            }
        },
        mounted() {
            this.loadLibrary();
            this.loadStats();
        },
        methods: {
            // Âú∞Âå∫ÂàÜÁªÑÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ
            onRegionGroupChange() {
                if (this.filters.regionGroup) {
                    // Ê∏ÖÁ©∫ÂçïÁã¨ÁöÑÂõΩÂÆ∂Á≠õÈÄâÔºåËÆ©Âú∞Âå∫ÂàÜÁªÑÁîüÊïà
                    this.filters.country = '';
                }
                this.loadLibrary();
            },
            
            async loadLibrary() {
                try {
                    const params = {
                        page: this.currentPage,
                        per_page: this.perPage,
                        ...this.filters
                    };
                    
                    const response = await api.getLibrary(params);
                    const data = response.data || response;
                    this.libraryItems = data.entries || [];
                    this.totalItems = data.total || 0;
                } catch (error) {
                    this.$root.showError('Âä†ËΩΩÊî∂ËóèÂ∫ìÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async loadStats() {
                try {
                    const response = await api.getLibraryStats();
                    this.stats = response.data || response;
                } catch (error) {
                    console.error('Âä†ËΩΩÁªüËÆ°Â§±Ë¥•:', error);
                }
            },
            
            async downloadItem(item) {
                try {
                    const response = await api.downloadFromLibrary([item.id]);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async batchDownload() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    const response = await api.downloadFromLibrary(this.selectedItems);
                    this.$emit('download-started', response);
                    this.clearSelection();
                } catch (error) {
                    this.$root.showError('ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÂΩìÂâçÈ°µ
            toggleSelectCurrentPage() {
                if (this.selectedItems.length === this.libraryItems.length && this.libraryItems.length > 0) {
                    // Â¶ÇÊûúÂΩìÂâçÈ°µÂÖ®ÈÄâ‰∫ÜÔºåÂàôÂèñÊ∂àÂΩìÂâçÈ°µÈÄâÊã©
                    const currentPageIds = this.libraryItems.map(item => item.id);
                    this.selectedItems = this.selectedItems.filter(id => !currentPageIds.includes(id));
                } else {
                    // ÈÄâÊã©ÂΩìÂâçÈ°µÊâÄÊúâÈ°πÁõÆ
                    const currentPageIds = this.libraryItems.map(item => item.id);
                    const newSelected = [...this.selectedItems];
                    currentPageIds.forEach(id => {
                        if (!newSelected.includes(id)) {
                            newSelected.push(id);
                        }
                    });
                    this.selectedItems = newSelected;
                }
            },
            
            // ÂÖ®ÈÄâÊâÄÊúâÁªìÊûú
            async selectAllResults() {
                if (this.isSelectingAll) return;
                
                this.isSelectingAll = true;
                try {
                    // ‰ΩøÁî®ÂΩìÂâçÁöÑÁ≠õÈÄâÊù°‰ª∂Ëé∑ÂèñÊâÄÊúâÁªìÊûú
                    const params = {
                        per_page: this.totalItems, // Ëé∑ÂèñÊâÄÊúâÁªìÊûú
                        page: 1,
                        ...this.filters
                    };
                    
                    const response = await api.getLibrary(params);
                    const allEntries = response.data?.entries || [];
                    
                    // Â≠òÂÇ®ÊâÄÊúâÊ≠åÊõ≤Êï∞ÊçÆÔºåÁî®‰∫éÂêéÁª≠Â§ÑÁêÜ
                    this.allSelectedSongs = allEntries;
                    
                    // ÈÄâÊã©ÊâÄÊúâÁªìÊûúÁöÑID
                    this.selectedItems = allEntries.map(entry => entry.id);
                    
                    this.$root.showSuccess(`Â∑≤ÈÄâÊã©ÊâÄÊúâ ${this.selectedItems.length} È¶ñÊ≠åÊõ≤`);
                    
                } catch (error) {
                    this.$root.showError('ÂÖ®ÈÄâÂ§±Ë¥•: ' + error.message);
                } finally {
                    this.isSelectingAll = false;
                }
            },
            
            // ÊòæÁ§∫Ê≠åÂçïÈÄâÊã©Ê®°ÊÄÅÊ°Ü
            async showCreatePlaylistModal() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    // Âä†ËΩΩÁî®Êà∑ÁöÑÊ≠åÂçïÂàóË°®
                    const response = await api.getPlaylists();
                    this.availablePlaylists = response.data?.playlists || [];
                    this.showPlaylistModal = true;
                } catch (error) {
                    this.$root.showError('Âä†ËΩΩÊ≠åÂçïÂàóË°®Â§±Ë¥•: ' + error.message);
                }
            },
            
            // ÈöêËóèÊ≠åÂçïÊ®°ÊÄÅÊ°Ü
            hidePlaylistModal() {
                this.showPlaylistModal = false;
                this.selectedPlaylistId = '';
                this.newPlaylistName = '';
                this.newPlaylistDescription = '';
            },
            
            // Âä†ËΩΩÂèØÁî®Ê≠åÂçïÂàóË°®
            async loadAvailablePlaylists() {
                try {
                    const response = await api.getPlaylists();
                    this.availablePlaylists = response.data?.playlists || [];
                } catch (error) {
                    console.error('Âä†ËΩΩÊ≠åÂçïÂàóË°®Â§±Ë¥•:', error);
                }
            },
            
            // Á°ÆËÆ§Ê∑ªÂä†Âà∞Ê≠åÂçï
            async confirmAddToPlaylist() {
                if (this.selectedItems.length === 0) return;
                
                try {
                    let playlistId = this.selectedPlaylistId;
                    let playlistName = '';
                    
                    // Â¶ÇÊûúÊòØÂàõÂª∫Êñ∞Ê≠åÂçï
                    if (!playlistId && this.newPlaylistName) {
                        const createResponse = await api.createPlaylist(
                            this.newPlaylistName, 
                            this.newPlaylistDescription
                        );
                        playlistId = createResponse.data.id;
                        playlistName = this.newPlaylistName;
                    } else if (playlistId) {
                        const playlist = this.availablePlaylists.find(p => p.id == playlistId);
                        playlistName = playlist ? playlist.name : 'Êú™Áü•Ê≠åÂçï';
                    }
                    
                    if (playlistId) {
                        // Ëé∑ÂèñÈÄâ‰∏≠È°πÂØπÂ∫îÁöÑÊ≠åÊõ≤ID
                        let songIds = [];
                        
                        // Â¶ÇÊûúÊúâÂÖ®ÈÄâÁöÑÊ≠åÊõ≤Êï∞ÊçÆÔºå‰ΩøÁî®ÂÖ®ÈÄâÊï∞ÊçÆ
                        if (this.allSelectedSongs.length > 0) {
                            songIds = this.allSelectedSongs
                                .filter(song => this.selectedItems.includes(song.id))
                                .map(song => song.song.database_id)
                                .filter(id => id !== null);
                        } else {
                            // Âê¶Âàô‰ªéÂΩìÂâçÈ°µÈù¢Êï∞ÊçÆ‰∏≠Ëé∑Âèñ
                            songIds = this.selectedItems.map(libraryId => {
                                const item = this.libraryItems.find(lib => lib.id === libraryId);
                                return item ? item.song.database_id : null;
                            }).filter(id => id !== null);
                        }
                        
                        // Ê∑ªÂä†Ê≠åÊõ≤Âà∞Ê≠åÂçï
                        await api.addSongsToPlaylist(playlistId, songIds);
                        
                        this.$root.showSuccess(`ÊàêÂäüÊ∑ªÂä† ${songIds.length} È¶ñÊ≠åÊõ≤Âà∞Ê≠åÂçï "${playlistName}"`);
                        
                        // Â¶ÇÊûúÂàõÂª∫‰∫ÜÊñ∞Ê≠åÂçïÔºåÂà∑Êñ∞Ê≠åÂçïÂàóË°®
                        if (this.newPlaylistName) {
                            await this.loadAvailablePlaylists();
                            // ÈÄöÁü•Ê†πÁªÑ‰ª∂Âà∑Êñ∞Ê≠åÂçïÂàóË°®
                            this.$root.loadPlaylists();
                        }
                        
                        this.hidePlaylistModal();
                        this.clearSelection();
                    }
                } catch (error) {
                    this.$root.showError('Ê∑ªÂä†Âà∞Ê≠åÂçïÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async createPlaylistFromSelected() {
                // Ëøô‰∏™ÊñπÊ≥ïÁé∞Âú®Áî± showCreatePlaylistModal Êõø‰ª£
                this.showCreatePlaylistModal();
            },
            
            async removeFromLibrary(id) {
                if (!confirm('Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ∫ì‰∏≠Âà†Èô§ÂêóÔºü')) return;
                
                try {
                    await api.deleteFromLibrary(id);
                    this.$root.showSuccess('Â∑≤‰ªéÊî∂ËóèÂ∫ìÂà†Èô§');
                    this.loadLibrary();
                    this.loadStats();
                } catch (error) {
                    this.$root.showError('Âà†Èô§Â§±Ë¥•: ' + error.message);
                }
            },
            
            // ÂèçÈÄâ
            invertSelection() {
                const allIds = this.libraryItems.map(item => item.id);
                const currentSelected = new Set(this.selectedItems);
                this.selectedItems = allIds.filter(id => !currentSelected.has(id));
            },
            
            clearSelection() {
                this.selectedItems = [];
                this.allSelectedSongs = []; // Ê∏ÖÁ©∫ÂÖ®ÈÄâÊï∞ÊçÆ
            },
            
            playPreview(song) {
                this.$root.currentTrack = song;
            }
        }
    });
    
    // Ê≠åÂçïÁªÑ‰ª∂
    app.component('playlists-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-list-music text-blue-600 mr-2"></i>ÊàëÁöÑÊ≠åÂçï
                    </h2>
                    <button @click="createPlaylist" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>ÂàõÂª∫Ê≠åÂçï
                    </button>
                </div>
                
                <!-- Ê≠åÂçïÂàóË°®ËßÜÂõæ -->
                <div v-if="!selectedPlaylist && playlists && playlists.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="playlist in playlists" :key="playlist.id" 
                         class="border rounded-lg p-4 hover:shadow-lg transition card-hover cursor-pointer"
                         @click="viewPlaylist(playlist)">
                        <div class="flex items-center space-x-4 mb-3">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white">
                                <i class="fas fa-music text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-lg">{{ playlist.name }}</h3>
                                <p class="text-sm text-gray-600">{{ playlist.song_count || playlist.total_tracks || 0 }} È¶ñÊ≠åÊõ≤</p>
                            </div>
                        </div>
                        
                        <p v-if="playlist.description" class="text-sm text-gray-500 mb-3">
                            {{ playlist.description }}
                        </p>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">
                                ÂàõÂª∫‰∫é {{ formatDate(playlist.created_at) }}
                            </span>
                            <div class="space-x-2">
                                <button @click.stop="viewPlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button v-if="$root.isAuthenticated" 
                                        @click.stop="downloadPlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button v-if="$root.isAuthenticated" 
                                        @click.stop="deletePlaylist(playlist)" 
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ê≠åÂçïËØ¶ÊÉÖËßÜÂõæ -->
                <div v-if="selectedPlaylist" class="space-y-6">
                    <!-- Ê≠åÂçïÂ§¥ÈÉ®‰ø°ÊÅØ -->
                    <div class="flex items-center justify-between p-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-20 h-20 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-music text-3xl"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">{{ selectedPlaylist.name }}</h2>
                                <p class="text-blue-100">{{ selectedPlaylist.song_count }} È¶ñÊ≠åÊõ≤</p>
                                <p v-if="selectedPlaylist.description" class="text-blue-100 text-sm mt-1">
                                    {{ selectedPlaylist.description }}
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <!-- Êí≠ÊîæÂÖ®ÈÉ®‰∏ãÊãâËèúÂçï -->
                            <div class="relative" v-click-outside="closePlayMenu">
                                <button @click="showPlayMenu = !showPlayMenu" 
                                        :disabled="!selectedPlaylist.songs || selectedPlaylist.songs.length === 0"
                                        class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition disabled:opacity-50 flex items-center">
                                    <i class="fas fa-play mr-2"></i>Êí≠ÊîæÂÖ®ÈÉ®
                                    <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                                
                                <!-- Êí≠ÊîæÈÄâÈ°πËèúÂçï -->
                                <div v-if="showPlayMenu" class="absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border z-50 min-w-48">
                                    <button @click="playAllSongs('preview')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                                        <i class="fas fa-headphones mr-2 text-green-600"></i>
                                        <span>Êí≠ÊîæËØïÂê¨ÁâàÊú¨</span>
                                        <span class="ml-auto text-xs text-gray-500">({{ getPreviewCount() }} È¶ñ)</span>
                                    </button>
                                    <button @click="playAllSongs('downloaded')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center">
                                        <i class="fas fa-play mr-2 text-blue-600"></i>
                                        <span>Êí≠Êîæ‰∏ãËΩΩÁâàÊú¨</span>
                                        <span class="ml-auto text-xs text-gray-500">({{ getDownloadedCount() }} È¶ñ)</span>
                                    </button>
                                    <button @click="playAllSongs('mixed')" 
                                            class="w-full px-4 py-2 text-left hover:bg-gray-50 flex items-center border-t">
                                        <i class="fas fa-random mr-2 text-purple-600"></i>
                                        <span>Ê∑∑ÂêàÊí≠Êîæ</span>
                                        <span class="ml-auto text-xs text-gray-500">(‰ºòÂÖà‰∏ãËΩΩÁâàÊú¨)</span>
                                    </button>
                                </div>
                            </div>
                            <button @click="downloadPlaylist(selectedPlaylist)" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
                                <i class="fas fa-download mr-2"></i>‰∏ãËΩΩÊ≠åÂçï
                            </button>
                            <button @click="copyApiLink" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition"
                                    title="Â§çÂà∂APIÊé•Âè£ÈìæÊé•">
                                <i class="fas fa-code mr-2"></i>APIÈìæÊé•
                            </button>
                            <button @click="selectedPlaylist = null" 
                                    class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
                                <i class="fas fa-arrow-left mr-2"></i>ËøîÂõûÂàóË°®
                            </button>
                        </div>
                    </div>
                    
                    <!-- ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
                    <div v-if="selectedPlaylist.songs && selectedPlaylist.songs.length > 0" class="flex items-center justify-between mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700">
                                Ê≠åÊõ≤ÊÄªÊï∞Ôºö{{ selectedPlaylist.songs.length }} È¶ñ
                                <span v-if="selectedSongs.length > 0" class="text-blue-700">
                                    | Â∑≤ÈÄâÊã©Ôºö{{ selectedSongs.length }} È¶ñ
                                </span>
                            </span>
                        </div>
                        
                        <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
                        <div class="flex items-center space-x-2">
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       :checked="selectedSongs.length === selectedPlaylist.songs.length && selectedPlaylist.songs.length > 0"
                                       @change="toggleSelectAllSongs"
                                       class="mr-2">
                                ÂÖ®ÈÄâ
                            </label>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="invertSongSelection" 
                                    class="px-3 py-1 text-sm bg-orange-500 text-white rounded hover:bg-orange-600 transition"
                                    title="ÂèçÈÄâÂΩìÂâçÈÄâÊã©">
                                <i class="fas fa-exchange-alt mr-1"></i>ÂèçÈÄâ
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="batchDownloadSongs" 
                                    class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                <i class="fas fa-download mr-1"></i>ÊâπÈáè‰∏ãËΩΩ
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="batchRemoveSongs" 
                                    class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                                <i class="fas fa-trash mr-1"></i>ÊâπÈáèÁßªÈô§
                            </button>
                            
                            <button v-if="selectedSongs.length > 0" 
                                    @click="clearSongSelection" 
                                    class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-1"></i>Ê∏ÖÁ©∫ÈÄâÊã©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ê≠åÊõ≤ÂàóË°® -->
                    <div v-if="selectedPlaylist.songs && selectedPlaylist.songs.length > 0" class="space-y-2">
                        <div v-for="(song, index) in selectedPlaylist.songs" :key="song.id" 
                             class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition">
                            <div class="flex items-center space-x-4">
                                <!-- ÈÄâÊã©Ê°Ü -->
                                <input type="checkbox" 
                                       :value="song.id" 
                                       v-model="selectedSongs"
                                       class="w-4 h-4 text-blue-600">
                                
                                <!-- Â∫èÂè∑ -->
                                <div class="w-8 text-center text-gray-500">{{ index + 1 }}</div>
                                
                                <!-- ‰∏ìËæëÂ∞ÅÈù¢ -->
                                <img v-if="song.album_art_url" 
                                     :src="song.album_art_url" 
                                     :alt="song.album"
                                     class="w-12 h-12 rounded object-cover">
                                <div v-else class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                                    <i class="fas fa-music text-gray-400"></i>
                                </div>
                                
                                <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
                                <div class="flex-1">
                                    <h4 class="font-semibold">{{ song.title }}</h4>
                                    <p class="text-sm text-gray-600">{{ song.artist }}</p>
                                    <p class="text-xs text-gray-500">{{ song.album }}</p>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span v-if="song.is_downloaded" class="inline-flex items-center px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                            <i class="fas fa-check-circle mr-1"></i>Â∑≤‰∏ãËΩΩ
                                        </span>
                                        <span v-if="song.preview_url" class="inline-flex items-center px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                            <i class="fas fa-headphones mr-1"></i>ÂèØËØïÂê¨
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Êó∂Èïø -->
                                <div class="text-sm text-gray-500">
                                    {{ formatDuration(song.duration) }}
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="flex items-center space-x-2">
                                <!-- Êí≠ÊîæÊåâÈíÆÁªÑ -->
                                <div class="flex items-center space-x-1">
                                    <button v-if="song.preview_url" 
                                            @click="playSong(song, 'preview')"
                                            class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition"
                                            title="Êí≠ÊîæËØïÂê¨">
                                        <i class="fas fa-headphones"></i>
                                    </button>
                                    <button v-if="song.is_downloaded && song.file_url" 
                                            @click="playSong(song, 'downloaded')"
                                            class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                                            title="Êí≠Êîæ‰∏ãËΩΩÁâàÊú¨">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                                
                                <button @click="downloadSong(song)"
                                        :class="song.is_downloaded ? 'bg-gray-500 hover:bg-gray-600' : 'bg-purple-600 hover:bg-purple-700'"
                                        class="px-3 py-1 text-sm text-white rounded transition"
                                        :title="song.is_downloaded ? 'ÈáçÊñ∞‰∏ãËΩΩ' : '‰∏ãËΩΩÊ≠åÊõ≤'">
                                    <i class="fas fa-download"></i>
                                </button>
                                
                                <button @click="removeSongFromPlaylist(song)"
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition"
                                        title="‰ªéÊ≠åÂçïÁßªÈô§">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Á©∫Ê≠åÂçïÊèêÁ§∫ -->
                    <div v-else class="text-center py-12 text-gray-500">
                        <i class="fas fa-music text-6xl mb-4"></i>
                        <p class="text-lg">Ê≠åÂçïÊòØÁ©∫ÁöÑ</p>
                        <p class="text-sm mt-2">‰ªéÊî∂ËóèÂ∫ìÊ∑ªÂä†Ê≠åÊõ≤Âà∞Ëøô‰∏™Ê≠åÂçï</p>
                    </div>
                </div>
                
                <!-- Á©∫Ê≠åÂçïÂàóË°®ÊèêÁ§∫ -->
                <div v-else-if="!selectedPlaylist && (!playlists || playlists.length === 0)" class="text-center py-12 text-gray-500">
                    <i class="fas fa-list-music text-6xl mb-4"></i>
                    <p class="text-lg">ËøòÊ≤°ÊúâÂàõÂª∫Ê≠åÂçï</p>
                    <p class="text-sm mt-2">ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ê≠åÂçï</p>
                </div>
            </div>
        `,
        props: ['playlists'],
        data() {
            return {
                selectedPlaylist: null,  // ÂΩìÂâçÊü•ÁúãÁöÑÊ≠åÂçïËØ¶ÊÉÖ
                showPlayMenu: false,     // Êí≠ÊîæËèúÂçïÊòæÁ§∫Áä∂ÊÄÅ
                selectedSongs: []        // ÈÄâ‰∏≠ÁöÑÊ≠åÊõ≤IDÂàóË°®
            }
        },
        methods: {
            createPlaylist() {
                const name = prompt('ËØ∑ËæìÂÖ•Ê≠åÂçïÂêçÁß∞:');
                if (!name) return;
                
                api.createPlaylist(name).then(() => {
                    this.$emit('playlist-updated');
                }).catch(error => {
                    this.$root.showError('ÂàõÂª∫Â§±Ë¥•: ' + error.message);
                });
            },
            
            async viewPlaylist(playlist) {
                try {
                    // Ëé∑ÂèñÊ≠åÂçïËØ¶ÊÉÖ
                    const response = await api.getPlaylistDetail(playlist.id);
                    this.selectedPlaylist = response.data;
                } catch (error) {
                    this.$root.showError('Âä†ËΩΩÊ≠åÂçïËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async downloadPlaylist(playlist) {
                // Ê£ÄÊü•ÊùÉÈôê
                if (!this.$root.requireAuth('‰∏ãËΩΩÊ≠åÂçï')) return;
                
                try {
                    const response = await api.downloadPlaylist(playlist.id);
                    this.$emit('download-started', response);
                    this.$root.showSuccess(`Ê≠åÂçï "${playlist.name}" ‰∏ãËΩΩÂ∑≤ÂêØÂä®`);
                    
                    // 5ÁßíÂêéÂà∑Êñ∞Ê≠åÂçïËØ¶ÊÉÖ‰ª•Êõ¥Êñ∞‰∏ãËΩΩÁä∂ÊÄÅ
                    setTimeout(async () => {
                        if (this.selectedPlaylist && this.selectedPlaylist.id === playlist.id) {
                            await this.viewPlaylist(this.selectedPlaylist);
                        }
                    }, 5000);
                } catch (error) {
                    this.$root.showError('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            deletePlaylist(playlist) {
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠åÂçï "${playlist.name}" ÂêóÔºü`)) return;
                
                api.deletePlaylist(playlist.id).then(() => {
                    this.$emit('playlist-updated');
                }).catch(error => {
                    this.$root.showError('Âà†Èô§Â§±Ë¥•: ' + error.message);
                });
            },
            
            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('zh-CN');
            },
            
            // Ê†ºÂºèÂåñÊó∂Èïø
            formatDuration(seconds) {
                if (!seconds) return '--:--';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            },
            
            // Êí≠ÊîæÂçïÈ¶ñÊ≠åÊõ≤
            playSong(song, mode = 'preview') {
                let audioUrl = null;
                let trackTitle = song.title;
                
                if (mode === 'downloaded' && song.is_downloaded && song.file_url) {
                    // Êí≠Êîæ‰∏ãËΩΩÁöÑÊñá‰ª∂
                    audioUrl = song.file_url; // Áõ¥Êé•‰ΩøÁî®APIÊèê‰æõÁöÑURL
                    trackTitle += ' (‰∏ãËΩΩÁâàÊú¨)';
                } else if (song.preview_url) {
                    // Êí≠ÊîæËØïÂê¨ÁâàÊú¨
                    audioUrl = song.preview_url;
                    trackTitle += ' (ËØïÂê¨ÁâàÊú¨)';
                } else {
                    this.$root.showError('Ê≠§Ê≠åÊõ≤ÊöÇÊó†ÂèØÊí≠ÊîæÁâàÊú¨');
                    return;
                }
                
                this.$root.currentTrack = {
                    id: song.spotify_id,
                    title: trackTitle,
                    artist: song.artist,
                    album: song.album,
                    album_art: song.album_art_url,
                    audio_url: audioUrl,
                    preview_url: song.preview_url,
                    duration: song.duration,
                    mode: mode
                };
            },
            
            // Êí≠ÊîæÊâÄÊúâÊ≠åÊõ≤
            playAllSongs(mode = 'mixed') {
                this.showPlayMenu = false;
                let playableSongs = [];
                
                if (mode === 'preview') {
                    playableSongs = this.selectedPlaylist.songs.filter(song => song.preview_url);
                } else if (mode === 'downloaded') {
                    playableSongs = this.selectedPlaylist.songs.filter(song => song.is_downloaded && song.file_url);
                } else { // mixed mode
                    playableSongs = this.selectedPlaylist.songs.filter(song => 
                        (song.is_downloaded && song.file_url) || song.preview_url
                    );
                }
                
                if (playableSongs.length > 0) {
                    // ÂàõÂª∫Êí≠ÊîæÈòüÂàó
                    const playlist = playableSongs.map((song, index) => ({
                        ...song,
                        playMode: mode === 'mixed' 
                            ? (song.is_downloaded && song.file_url ? 'downloaded' : 'preview')
                            : mode,
                        queueIndex: index
                    }));
                    
                    // ÂºÄÂßãÊí≠ÊîæÁ¨¨‰∏ÄÈ¶ñ
                    this.playPlaylist(playlist);
                    
                    const modeText = {
                        'preview': 'ËØïÂê¨ÁâàÊú¨',
                        'downloaded': '‰∏ãËΩΩÁâàÊú¨', 
                        'mixed': 'Ê∑∑ÂêàÊ®°Âºè'
                    };
                    
                    this.$root.showSuccess(`ÂºÄÂßãÊí≠ÊîæÊ≠åÂçï(${modeText[mode]})ÔºåÂÖ± ${playableSongs.length} È¶ñÊ≠åÊõ≤`);
                } else {
                    const errorText = {
                        'preview': 'Ê≤°ÊúâÂèØËØïÂê¨ÁöÑÊ≠åÊõ≤',
                        'downloaded': 'Ê≤°ÊúâÂ∑≤‰∏ãËΩΩÁöÑÊ≠åÊõ≤',
                        'mixed': 'Ê≤°ÊúâÂèØÊí≠ÊîæÁöÑÊ≠åÊõ≤'
                    };
                    this.$root.showError(`Ê≠åÂçï‰∏≠${errorText[mode]}`);
                }
            },
            
            // Êí≠ÊîæÊ≠åÂçïÈòüÂàó
            playPlaylist(playlist) {
                this.$root.currentPlaylist = playlist;
                this.$root.currentPlaylistIndex = 0;
                this.playSong(playlist[0], playlist[0].playMode);
            },
            
            // Ëé∑ÂèñËØïÂê¨ÁâàÊú¨Êï∞Èáè
            getPreviewCount() {
                return this.selectedPlaylist?.songs?.filter(song => song.preview_url).length || 0;
            },
            
            // Ëé∑Âèñ‰∏ãËΩΩÁâàÊú¨Êï∞Èáè
            getDownloadedCount() {
                return this.selectedPlaylist?.songs?.filter(song => song.is_downloaded && song.file_url).length || 0;
            },
            
            // ÂÖ≥Èó≠Êí≠ÊîæËèúÂçï
            closePlayMenu() {
                this.showPlayMenu = false;
            },
            
            // Â§çÂà∂APIÈìæÊé•
            async copyApiLink() {
                if (!this.selectedPlaylist) return;
                
                const baseUrl = window.location.origin;
                const apiUrl = `${baseUrl}/api/playlists/${this.selectedPlaylist.id}`;
                
                try {
                    await navigator.clipboard.writeText(apiUrl);
                    this.$root.showSuccess('APIÊé•Âè£ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    
                    // ÊòæÁ§∫API‰ΩøÁî®ËØ¥Êòé
                    this.$root.showApiInfo(apiUrl, this.selectedPlaylist);
                } catch (error) {
                    // ÈôçÁ∫ßÊñπÊ°àÔºöÈÄâÊã©ÊñáÊú¨
                    this.selectText(apiUrl);
                    this.$root.showSuccess('APIÈìæÊé•Â∑≤ÈÄâ‰∏≠ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
                }
            },
            
            // ÈÄâÊã©ÊñáÊú¨ÁöÑÈôçÁ∫ßÊñπÊ°à
            selectText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.body.removeChild(textArea);
            },
            
            // ‰∏ãËΩΩÂçïÈ¶ñÊ≠åÊõ≤
            async downloadSong(song) {
                try {
                    const response = await api.downloadSingle(song.spotify_id);
                    this.$emit('download-started', response);
                } catch (error) {
                    this.$root.showError('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            // Ê≠åÊõ≤ÈÄâÊã©Áõ∏ÂÖ≥ÊñπÊ≥ï
            toggleSelectAllSongs() {
                if (this.selectedSongs.length === this.selectedPlaylist.songs.length) {
                    this.selectedSongs = [];
                } else {
                    this.selectedSongs = this.selectedPlaylist.songs.map(song => song.id);
                }
            },
            
            // ÂèçÈÄâÊ≠åÊõ≤
            invertSongSelection() {
                const allSongIds = this.selectedPlaylist.songs.map(song => song.id);
                const currentSelected = new Set(this.selectedSongs);
                this.selectedSongs = allSongIds.filter(id => !currentSelected.has(id));
            },
            
            // Ê∏ÖÁ©∫Ê≠åÊõ≤ÈÄâÊã©
            clearSongSelection() {
                this.selectedSongs = [];
            },
            
            // ÊâπÈáè‰∏ãËΩΩÊ≠åÊõ≤
            async batchDownloadSongs() {
                if (this.selectedSongs.length === 0) return;
                
                try {
                    const selectedSongData = this.selectedPlaylist.songs.filter(song => 
                        this.selectedSongs.includes(song.id)
                    );
                    
                    // Ëé∑ÂèñÊî∂ËóèÂ∫ìIDÂàóË°®
                    const libraryIds = selectedSongData
                        .filter(song => song.library_info?.library_id)
                        .map(song => song.library_info.library_id);
                    
                    if (libraryIds.length > 0) {
                        // ‰ΩøÁî®Êî∂ËóèÂ∫ìÊâπÈáè‰∏ãËΩΩAPI
                        const response = await api.downloadFromLibrary(libraryIds);
                        this.$emit('download-started', response);
                        this.$root.showSuccess(`Â∑≤ÂºÄÂßãÊâπÈáè‰∏ãËΩΩ ${libraryIds.length} È¶ñÊ≠åÊõ≤`);
                        
                        // 5ÁßíÂêéÂà∑Êñ∞Ê≠åÂçïËØ¶ÊÉÖ‰ª•Êõ¥Êñ∞‰∏ãËΩΩÁä∂ÊÄÅ
                        setTimeout(async () => {
                            await this.viewPlaylist(this.selectedPlaylist);
                        }, 5000);
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÊî∂ËóèÂ∫ìIDÔºåÈÄê‰∏™‰∏ãËΩΩÔºàÂä†Âª∂ËøüÈÅøÂÖç409ÂÜ≤Á™ÅÔºâ
                        let successCount = 0;
                        for (let i = 0; i < selectedSongData.length; i++) {
                            try {
                                await this.downloadSong(selectedSongData[i]);
                                successCount++;
                                // Ê∑ªÂä†Âª∂ËøüÈÅøÂÖç409ÂÜ≤Á™Å
                                if (i < selectedSongData.length - 1) {
                                    await new Promise(resolve => setTimeout(resolve, 200));
                                }
                            } catch (error) {
                                console.warn(`‰∏ãËΩΩÊ≠åÊõ≤ "${selectedSongData[i].title}" Â§±Ë¥•:`, error.message);
                                this.$root.showError(`‰∏ãËΩΩ "${selectedSongData[i].title}" Â§±Ë¥•: ${error.message}`);
                            }
                        }
                        if (successCount > 0) {
                            this.$root.showSuccess(`Â∑≤ÂºÄÂßã‰∏ãËΩΩ ${successCount} È¶ñÊ≠åÊõ≤`);
                        }
                    }
                    
                    this.clearSongSelection();
                } catch (error) {
                    this.$root.showError('ÊâπÈáè‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
                }
            },
            
            // ÊâπÈáèÁßªÈô§Ê≠åÊõ≤
            async batchRemoveSongs() {
                if (this.selectedSongs.length === 0) return;
                
                if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÊ≠åÂçï‰∏≠ÁßªÈô§ ${this.selectedSongs.length} È¶ñÊ≠åÊõ≤ÂêóÔºü`)) return;
                
                try {
                    for (const songId of this.selectedSongs) {
                        await api.removeSongFromPlaylist(this.selectedPlaylist.id, songId);
                    }
                    
                    this.$root.showSuccess(`Â∑≤ÁßªÈô§ ${this.selectedSongs.length} È¶ñÊ≠åÊõ≤`);
                    this.clearSongSelection();
                    // ÈáçÊñ∞Âä†ËΩΩÊ≠åÂçïËØ¶ÊÉÖ
                    await this.viewPlaylist(this.selectedPlaylist);
                } catch (error) {
                    this.$root.showError('ÊâπÈáèÁßªÈô§Â§±Ë¥•: ' + error.message);
                }
            },
            
            // ‰ªéÊ≠åÂçïÁßªÈô§Ê≠åÊõ≤
            async removeSongFromPlaylist(song) {
                if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÊ≠åÂçï‰∏≠ÁßªÈô§ "${song.title}" ÂêóÔºü`)) return;
                
                try {
                    await api.removeSongFromPlaylist(this.selectedPlaylist.id, song.id);
                    this.$root.showSuccess('Ê≠åÊõ≤Â∑≤‰ªéÊ≠åÂçïÁßªÈô§');
                    // ÈáçÊñ∞Âä†ËΩΩÊ≠åÂçïËØ¶ÊÉÖ
                    await this.viewPlaylist(this.selectedPlaylist);
                } catch (error) {
                    this.$root.showError('ÁßªÈô§Â§±Ë¥•: ' + error.message);
                }
            }
        }
    });
    
    // ‰∏ãËΩΩÁªÑ‰ª∂
    app.component('download-component', {
        template: `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-download text-blue-600 mr-2"></i>‰∏ãËΩΩÁÆ°ÁêÜ
                    </h2>
                    <div v-if="downloadTasks && downloadTasks.length > 0" class="space-x-2">
                        <button @click="clearTasks('completed')" 
                                class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                            <i class="fas fa-check-circle mr-1"></i>Ê∏ÖÈô§Â∑≤ÂÆåÊàê
                        </button>
                        <button @click="clearTasks('failed')" 
                                class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition">
                            <i class="fas fa-exclamation-circle mr-1"></i>Ê∏ÖÈô§Â§±Ë¥•
                        </button>
                        <button @click="clearAllTasks" 
                                class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                            <i class="fas fa-trash mr-1"></i>Ê∏ÖÈô§ÂÖ®ÈÉ®
                        </button>
                    </div>
                </div>
                
                <div v-if="downloadTasks && downloadTasks.length > 0" class="space-y-4">
                    <div v-for="task in downloadTasks" :key="task.id" 
                         class="border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h4 class="font-semibold">{{ task.song_title }}</h4>
                                <p class="text-sm text-gray-600">{{ task.artist }}</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span :class="getStatusClass(task.status)" class="px-3 py-1 rounded-full text-sm">
                                    {{ getStatusText(task.status) }}
                                </span>
                                <button v-if="task.status === 'pending' || task.status === 'downloading'" 
                                        @click="cancelTask(task.id)"
                                        class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- ËøõÂ∫¶Êù° -->
                        <div v-if="task.status === 'downloading'" class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full progress-bar" 
                                 :style="{width: task.progress + '%'}"></div>
                        </div>
                        
                        <!-- ÈîôËØØ‰ø°ÊÅØ -->
                        <p v-if="task.error_message" class="text-sm text-red-600 mt-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            {{ task.error_message }}
                        </p>
                    </div>
                </div>
                
                <div v-else class="text-center py-12 text-gray-500">
                    <i class="fas fa-download text-6xl mb-4"></i>
                    <p class="text-lg">Ê≤°Êúâ‰∏ãËΩΩ‰ªªÂä°</p>
                </div>
            </div>
        `,
        props: ['downloadTasks'],
        methods: {
            getStatusClass(status) {
                const classes = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'downloading': 'bg-blue-100 text-blue-800',
                    'completed': 'bg-green-100 text-green-800',
                    'failed': 'bg-red-100 text-red-800',
                    'cancelled': 'bg-gray-100 text-gray-800'
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            },
            
            getStatusText(status) {
                const texts = {
                    'pending': 'Á≠âÂæÖ‰∏≠',
                    'downloading': '‰∏ãËΩΩ‰∏≠',
                    'completed': 'Â∑≤ÂÆåÊàê',
                    'failed': 'Â§±Ë¥•',
                    'cancelled': 'Â∑≤ÂèñÊ∂à'
                };
                return texts[status] || status;
            },
            
            async cancelTask(taskId) {
                try {
                    await api.cancelDownloadTask(taskId);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('ÂèñÊ∂àÂ§±Ë¥•: ' + error.message);
                }
            },
            
            async clearTasks(status) {
                try {
                    const statusText = {
                        'completed': 'Â∑≤ÂÆåÊàê',
                        'failed': 'Â§±Ë¥•',
                        'cancelled': 'Â∑≤ÂèñÊ∂à'
                    };
                    
                    if (!confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ${statusText[status]}ÁöÑ‰ªªÂä°ËÆ∞ÂΩïÂêóÔºü`)) return;
                    
                    const response = await api.clearDownloadTasks(status);
                    this.$root.showSuccess(response.message);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('Ê∏ÖÈô§Â§±Ë¥•: ' + error.message);
                }
            },
            
            async clearAllTasks() {
                if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ‰∏ãËΩΩ‰ªªÂä°ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;
                
                try {
                    const response = await api.clearDownloadTasks();
                    this.$root.showSuccess(response.message);
                    this.$emit('task-updated');
                } catch (error) {
                    this.$root.showError('Ê∏ÖÈô§Â§±Ë¥•: ' + error.message);
                }
            }
        }
    });
    
    // Èü≥‰πêÊí≠ÊîæÂô®ÁªÑ‰ª∂
    app.component('music-player', {
        template: `
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-30">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <img v-if="currentTrack.album_art" 
                             :src="currentTrack.album_art" 
                             class="w-12 h-12 rounded">
                        <div>
                            <h4 class="font-semibold">{{ currentTrack.title }}</h4>
                            <p class="text-sm text-gray-600">{{ currentTrack.artist }}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <audio ref="audioPlayer" 
                               :src="currentTrack.audio_url || currentTrack.preview_url" 
                               @ended="$emit('track-ended')"
                               autoplay
                               controls
                               class="h-8">
                        </audio>
                        
                        <button @click="$emit('track-ended')" 
                                class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `,
        props: ['currentTrack']
    });
    
    // ÈÄöÁü•ÁªÑ‰ª∂
    app.component('notification-component', {
        template: `
            <div class="fixed top-20 right-4 z-50 space-y-2">
                <transition-group name="fade">
                    <div v-for="notification in notifications" 
                         :key="notification.id"
                         :class="getNotificationClass(notification.type)"
                         class="rounded-lg shadow-lg min-w-80 max-w-96 relative overflow-hidden">
                        
                        <!-- ÈÄöÁü•ÂÜÖÂÆπ -->
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center">
                                    <i :class="getTypeIcon(notification.type)" class="mr-2"></i>
                                    <span class="font-medium text-sm">{{ getTypeText(notification.type) }}</span>
                                </div>
                                <button @click="$emit('dismiss', notification.id)" 
                                        class="text-white text-opacity-70 hover:text-opacity-100 transition-opacity">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-sm whitespace-pre-line">{{ notification.message }}</div>
                        </div>
                        
                        <!-- ËøõÂ∫¶Êù° -->
                        <div class="h-1 bg-black bg-opacity-30">
                            <div class="h-full bg-white bg-opacity-80 transition-all duration-100 ease-linear"
                                 :style="{ width: getProgressWidth(notification.id) + '%' }">
                            </div>
                        </div>
                    </div>
                </transition-group>
            </div>
        `,
        props: ['notifications'],
        data() {
            return {
                activeTimers: new Map(), // Â≠òÂÇ®Ê¥ªÂä®ÁöÑÂÆöÊó∂Âô®
                progressTimers: new Map(), // Â≠òÂÇ®ËøõÂ∫¶Êù°ÂÆöÊó∂Âô®
                progressValues: new Map() // Â≠òÂÇ®ËøõÂ∫¶ÂÄº
            }
        },
        watch: {
            notifications: {
                handler(newNotifications, oldNotifications) {
                    // Ê£ÄÊü•Êñ∞Â¢ûÁöÑÈÄöÁü•
                    const oldIds = (oldNotifications || []).map(n => n.id);
                    const newItems = newNotifications.filter(n => !oldIds.includes(n.id));
                    
                    // ‰∏∫ÊØè‰∏™Êñ∞ÈÄöÁü•ËÆæÁΩÆËá™Âä®ÂÖ≥Èó≠
                    newItems.forEach(notification => {
                        // Â¶ÇÊûúÂ∑≤ÁªèÊúâÂÆöÊó∂Âô®ÔºåÂÖàÊ∏ÖÈô§
                        if (this.activeTimers.has(notification.id)) {
                            clearTimeout(this.activeTimers.get(notification.id));
                        }
                        
                        // Ëé∑ÂèñËá™Âä®ÂÖ≥Èó≠Êó∂Èó¥
                        let autoCloseTime = notification.duration || 5000; // ÈªòËÆ§5Áßí
                        
                        // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÈªòËÆ§Êó∂Èó¥
                        if (!notification.duration) {
                            switch (notification.type) {
                                case 'success':
                                    autoCloseTime = 2500; // ÊàêÂäüÊ∂àÊÅØ2.5Áßí
                                    break;
                                case 'error':
                                    autoCloseTime = 6000; // ÈîôËØØÊ∂àÊÅØ6Áßí
                                    break;
                                case 'warning':
                                    autoCloseTime = 4000; // Ë≠¶ÂëäÊ∂àÊÅØ4Áßí
                                    break;
                                case 'info':
                                    autoCloseTime = 8000; // ‰ø°ÊÅØÊ∂àÊÅØ8Áßí
                                    break;
                                default:
                                    autoCloseTime = 3000;
                            }
                        }
                        
                        // ËÆæÁΩÆ‰∏ªÂÆöÊó∂Âô®
                        const timer = setTimeout(() => {
                            this.$emit('dismiss', notification.id);
                            this.activeTimers.delete(notification.id);
                            this.progressTimers.delete(notification.id);
                            this.progressValues.delete(notification.id);
                        }, autoCloseTime);
                        
                        this.activeTimers.set(notification.id, timer);
                        
                        // ËÆæÁΩÆËøõÂ∫¶Êù°Âä®Áîª
                        this.progressValues.set(notification.id, 100);
                        const progressInterval = setInterval(() => {
                            const elapsed = Date.now() - notification.createdAt;
                            const progress = Math.max(0, 100 - (elapsed / autoCloseTime) * 100);
                            this.progressValues.set(notification.id, progress);
                            
                            if (progress <= 0) {
                                clearInterval(progressInterval);
                                this.progressTimers.delete(notification.id);
                            }
                        }, 50);
                        
                        this.progressTimers.set(notification.id, progressInterval);
                    });
                    
                    // Ê∏ÖÁêÜÂ∑≤Âà†Èô§ÈÄöÁü•ÁöÑÂÆöÊó∂Âô®
                    const currentIds = newNotifications.map(n => n.id);
                    this.activeTimers.forEach((timer, id) => {
                        if (!currentIds.includes(id)) {
                            clearTimeout(timer);
                            this.activeTimers.delete(id);
                        }
                    });
                    
                    this.progressTimers.forEach((timer, id) => {
                        if (!currentIds.includes(id)) {
                            clearInterval(timer);
                            this.progressTimers.delete(id);
                            this.progressValues.delete(id);
                        }
                    });
                },
                deep: true
            }
        },
        beforeUnmount() {
            // ÁªÑ‰ª∂ÈîÄÊØÅÂâçÊ∏ÖÈô§ÊâÄÊúâÂÆöÊó∂Âô®
            this.activeTimers.forEach(timer => clearTimeout(timer));
            this.activeTimers.clear();
            
            this.progressTimers.forEach(timer => clearInterval(timer));
            this.progressTimers.clear();
            this.progressValues.clear();
        },
        methods: {
            getNotificationClass(type) {
                const classes = {
                    'success': 'bg-green-600 text-white',
                    'error': 'bg-red-600 text-white',
                    'warning': 'bg-yellow-600 text-white',
                    'info': 'bg-blue-600 text-white'
                };
                return classes[type] || classes.info;
            },
            
            getTypeIcon(type) {
                const icons = {
                    'success': 'fas fa-check-circle',
                    'error': 'fas fa-exclamation-circle',
                    'warning': 'fas fa-exclamation-triangle',
                    'info': 'fas fa-info-circle'
                };
                return icons[type] || icons.info;
            },
            
            getTypeText(type) {
                const texts = {
                    'success': 'ÊàêÂäü',
                    'error': 'ÈîôËØØ',
                    'warning': 'Ë≠¶Âëä',
                    'info': '‰ø°ÊÅØ'
                };
                return texts[type] || texts.info;
            },
            
            getProgressWidth(notificationId) {
                return this.progressValues.get(notificationId) || 100;
            }
        }
    });

    // ÊåÇËΩΩÂ∫îÁî®
    app.mount('#app');
    </script>
</body>
</html>